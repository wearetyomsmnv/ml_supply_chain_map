<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ML Supply Chain Dependency Map</title>
<script src="https://d3js.org/d3.v7.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
/* ── Reset & Base ── */
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
html, body { width: 100%; height: 100%; overflow: hidden; background: #0a0e17; color: #e0e0e0; font-family: 'Inter', sans-serif; }

/* ── Layout Grid ── */
#app {
  display: grid;
  grid-template-rows: 56px 1fr 140px;
  grid-template-columns: 340px 1fr;
  grid-template-areas:
    "header header"
    "sidebar main"
    "timeline timeline";
  width: 100vw; height: 100vh;
}

/* ── Header ── */
#header {
  grid-area: header;
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 24px;
  background: linear-gradient(180deg, #0f1520 0%, #0a0e17 100%);
  border-bottom: 1px solid rgba(255,255,255,0.06);
  z-index: 10;
}
#header h1 {
  font-size: 16px; font-weight: 600;
  background: linear-gradient(90deg, #00e5ff, #76ff03);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  letter-spacing: 0.5px;
}
.header-controls { display: flex; align-items: center; gap: 12px; }
.layer-filters { display: flex; gap: 6px; }
.layer-chip {
  font-size: 11px; padding: 3px 10px; border-radius: 12px;
  border: 1px solid; cursor: pointer; transition: all 0.2s;
  font-family: 'Inter', sans-serif; background: transparent; color: #ccc;
  opacity: 0.7;
}
.layer-chip.active { opacity: 1; }
.layer-chip:hover { opacity: 1; }

/* ── Simulation Button ── */
.sim-btn {
  font-family: 'JetBrains Mono', monospace; font-size: 12px; font-weight: 500;
  padding: 6px 16px; border-radius: 4px; cursor: pointer;
  border: 1px solid #ff1744; color: #ff1744; background: transparent;
  transition: all 0.25s; text-transform: uppercase; letter-spacing: 1px;
}
.sim-btn:hover { background: rgba(255,23,68,0.15); }
.sim-btn.active { background: #ff1744; color: #fff; box-shadow: 0 0 20px rgba(255,23,68,0.4); }
.sim-reset {
  font-family: 'JetBrains Mono', monospace; font-size: 11px;
  padding: 5px 12px; border-radius: 4px; cursor: pointer;
  border: 1px solid #555; color: #999; background: transparent;
  transition: all 0.2s; display: none;
}
.sim-reset:hover { border-color: #999; color: #fff; }

/* ── Sidebar ── */
#sidebar {
  grid-area: sidebar;
  background: #0d1117;
  border-right: 1px solid rgba(255,255,255,0.06);
  overflow-y: auto; padding: 16px;
  scrollbar-width: thin; scrollbar-color: #1a2030 #0d1117;
}
#sidebar::-webkit-scrollbar { width: 6px; }
#sidebar::-webkit-scrollbar-track { background: #0d1117; }
#sidebar::-webkit-scrollbar-thumb { background: #1a2030; border-radius: 3px; }

.sidebar-section-title {
  font-size: 10px; text-transform: uppercase; letter-spacing: 2px;
  color: #556; margin-bottom: 12px; font-weight: 600;
}

/* ── Stat Cards ── */
.stat-cards { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 20px; }
.stat-card {
  background: #111820; border: 1px solid rgba(255,255,255,0.05);
  border-radius: 8px; padding: 12px; transition: border-color 0.2s;
}
.stat-card:hover { border-color: rgba(255,255,255,0.12); }
.stat-value {
  font-family: 'JetBrains Mono', monospace; font-size: 18px; font-weight: 600;
  margin-bottom: 4px; line-height: 1;
}
.stat-label { font-size: 10px; color: #667; line-height: 1.3; }

/* ── Node Detail Panel ── */
#node-detail { display: none; }
#node-detail.visible { display: block; }
.detail-header {
  display: flex; align-items: center; gap: 10px;
  margin-bottom: 14px; padding-bottom: 12px;
  border-bottom: 1px solid rgba(255,255,255,0.06);
}
.detail-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
.detail-name { font-size: 16px; font-weight: 600; }
.detail-layer { font-size: 11px; color: #667; }
.detail-row {
  display: flex; justify-content: space-between; align-items: center;
  padding: 6px 0; font-size: 12px;
}
.detail-row-label { color: #667; }
.detail-row-value { font-family: 'JetBrains Mono', monospace; font-weight: 500; }
.risk-badge {
  display: inline-block; padding: 2px 8px; border-radius: 3px;
  font-size: 10px; font-weight: 600; text-transform: uppercase;
  font-family: 'JetBrains Mono', monospace;
}
.risk-critical { background: rgba(255,23,68,0.2); color: #ff1744; border: 1px solid rgba(255,23,68,0.3); }
.risk-high { background: rgba(255,145,0,0.2); color: #ff9100; border: 1px solid rgba(255,145,0,0.3); }
.risk-medium { background: rgba(255,234,0,0.2); color: #ffea00; border: 1px solid rgba(255,234,0,0.3); }

.detail-section-title {
  font-size: 10px; text-transform: uppercase; letter-spacing: 1.5px;
  color: #556; margin: 14px 0 8px; font-weight: 600;
}
.blast-radius-text { font-size: 12px; color: #aaa; line-height: 1.5; margin-bottom: 8px; }
.cve-item {
  background: #111820; border: 1px solid rgba(255,255,255,0.05);
  border-radius: 6px; padding: 8px 10px; margin-bottom: 6px;
}
.cve-id { font-family: 'JetBrains Mono', monospace; font-size: 11px; color: #ff9100; font-weight: 500; }
.cve-desc { font-size: 11px; color: #889; margin-top: 2px; }
.cve-cvss {
  font-family: 'JetBrains Mono', monospace; font-size: 10px;
  display: inline-block; padding: 1px 6px; border-radius: 3px; margin-top: 3px;
}
.attack-item {
  font-size: 12px; color: #aab; padding: 4px 0;
  border-bottom: 1px solid rgba(255,255,255,0.03);
}
.attack-date { font-family: 'JetBrains Mono', monospace; color: #ff1744; font-size: 10px; }
.threat-item {
  background: #111820; border: 1px solid rgba(255,255,255,0.05);
  border-radius: 6px; padding: 8px 10px; margin-bottom: 6px;
}
.threat-actor-badge {
  display: inline-block; font-family: 'JetBrains Mono', monospace;
  font-size: 10px; padding: 2px 8px; border-radius: 3px;
  font-weight: 600;
}
.threat-vector { font-size: 11px; color: #889; margin-top: 4px; }
.maintainers-info {
  font-family: 'JetBrains Mono', monospace; font-size: 14px; color: #ff9100;
}

/* ── Compromise simulation panel ── */
#compromise-panel { display: none; margin-top: 16px; }
#compromise-panel.visible { display: block; }
.compromise-stats {
  background: rgba(255,23,68,0.08); border: 1px solid rgba(255,23,68,0.2);
  border-radius: 8px; padding: 12px;
}
.compromise-stat-row {
  display: flex; justify-content: space-between; font-size: 12px; padding: 4px 0;
}
.compromise-stat-label { color: #ff8a80; }
.compromise-stat-value { font-family: 'JetBrains Mono', monospace; color: #ff1744; font-weight: 600; }

/* ── Main SVG ── */
#main {
  grid-area: main; position: relative; overflow: hidden;
  background: radial-gradient(ellipse at center, #0f1520 0%, #0a0e17 70%);
}
#main svg { width: 100%; height: 100%; }

.graph-hint {
  position: absolute; bottom: 16px; right: 16px;
  font-size: 11px; color: #334; pointer-events: none;
  font-family: 'JetBrains Mono', monospace;
}

/* ── Timeline ── */
#timeline {
  grid-area: timeline;
  background: #0d1117;
  border-top: 1px solid rgba(255,255,255,0.06);
  padding: 12px 24px; position: relative;
}
.timeline-title {
  font-size: 10px; text-transform: uppercase; letter-spacing: 2px;
  color: #445; font-weight: 600; margin-bottom: 8px;
}
.timeline-track {
  position: relative; height: 80px; margin-top: 4px;
}
.timeline-axis {
  position: absolute; bottom: 0; left: 0; right: 0; height: 1px;
  background: rgba(255,255,255,0.08);
}
.timeline-incident {
  position: absolute; cursor: pointer; transition: all 0.25s;
}
.timeline-dot {
  width: 12px; height: 12px; border-radius: 50%; border: 2px solid #ff1744;
  background: #0d1117; transition: all 0.25s; margin: 0 auto;
}
.timeline-incident:hover .timeline-dot {
  background: #ff1744; box-shadow: 0 0 12px rgba(255,23,68,0.6);
}
.timeline-incident.active .timeline-dot {
  background: #ff1744; box-shadow: 0 0 16px rgba(255,23,68,0.8);
}
.timeline-label {
  font-size: 9px; color: #667; text-align: center; margin-top: 4px;
  max-width: 140px; line-height: 1.2;
  display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
  overflow: hidden;
}
.timeline-incident.stagger-up { bottom: 40px !important; }
.timeline-connector {
  position: absolute; left: 50%; width: 1px; background: rgba(255,23,68,0.3);
  transform: translateX(-50%);
}
.timeline-date {
  font-family: 'JetBrains Mono', monospace; font-size: 9px;
  color: #445; text-align: center; margin-top: 2px;
}
.timeline-year-label {
  position: absolute; bottom: -2px;
  font-family: 'JetBrains Mono', monospace; font-size: 10px; color: #334;
}

/* ── SVG Styles ── */
.node-group { cursor: pointer; }
.node-circle { stroke-width: 2.5; transition: opacity 0.3s; }
.node-hex { stroke-width: 2.5; transition: opacity 0.3s; }
.node-label {
  font-family: 'JetBrains Mono', monospace; font-size: 10px;
  fill: #ccc; text-anchor: middle; pointer-events: none;
  transition: opacity 0.3s;
}
.link-line {
  fill: none; stroke-opacity: 0.25; transition: stroke-opacity 0.3s, stroke 0.3s;
}
.link-arrow { fill-opacity: 0.4; transition: fill-opacity 0.3s, fill 0.3s; }
.cluster-hull { stroke-width: 1; transition: opacity 0.3s; }

/* ── Dim state for hover ── */
.dimmed .node-circle, .dimmed .node-hex { opacity: 0.12; }
.dimmed .node-label { opacity: 0.08; }
.dimmed .link-line { stroke-opacity: 0.04; }
.dimmed .link-arrow { fill-opacity: 0.04; }
.highlighted .node-circle, .highlighted .node-hex { opacity: 1; }
.highlighted .node-label { opacity: 1; }

/* ── Compromise animation ── */
@keyframes compromisePulse {
  0% { filter: drop-shadow(0 0 4px rgba(255,23,68,0.3)); }
  50% { filter: drop-shadow(0 0 20px rgba(255,23,68,0.8)); }
  100% { filter: drop-shadow(0 0 4px rgba(255,23,68,0.3)); }
}
.compromised { animation: compromisePulse 1.2s ease-in-out infinite; }
.compromised .node-circle, .compromised .node-hex {
  stroke: #ff1744 !important; stroke-width: 3.5;
}
.compromise-link { stroke: #ff1744 !important; stroke-opacity: 0.7 !important; stroke-dasharray: 6 3; }
.compromise-arrow { fill: #ff1744 !important; fill-opacity: 0.8 !important; }

/* ── Incident flash ── */
@keyframes incidentFlash {
  0% { filter: drop-shadow(0 0 0 rgba(255,145,0,0)); }
  25% { filter: drop-shadow(0 0 25px rgba(255,145,0,0.9)); }
  50% { filter: drop-shadow(0 0 5px rgba(255,145,0,0.3)); }
  75% { filter: drop-shadow(0 0 25px rgba(255,145,0,0.9)); }
  100% { filter: drop-shadow(0 0 0 rgba(255,145,0,0)); }
}
.incident-flash { animation: incidentFlash 1.5s ease-in-out; }

/* ── Tooltip ── */
.graph-tooltip {
  position: absolute; pointer-events: none; background: #161c28;
  border: 1px solid rgba(255,255,255,0.1); border-radius: 6px;
  padding: 8px 12px; font-size: 12px; display: none;
  box-shadow: 0 4px 20px rgba(0,0,0,0.5); z-index: 100;
  max-width: 220px;
}
.graph-tooltip .tt-name { font-weight: 600; margin-bottom: 2px; }
.graph-tooltip .tt-layer { font-size: 10px; color: #667; }
.graph-tooltip .tt-downloads {
  font-family: 'JetBrains Mono', monospace; font-size: 11px; margin-top: 4px; color: #aaa;
}

/* ── Legend ── */
.legend-box {
  background: #111820; border: 1px solid rgba(255,255,255,0.05);
  border-radius: 8px; padding: 10px 12px; margin-bottom: 14px;
}
.legend-row {
  display: flex; align-items: center; gap: 8px;
  padding: 3px 0; font-size: 11px; color: #99a;
}
.legend-dot {
  width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0;
  border: 1.5px solid;
}
.legend-hex {
  width: 10px; height: 9px; flex-shrink: 0;
  clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
}
.legend-line {
  width: 18px; height: 0; flex-shrink: 0;
  border-top: 1.5px solid #556;
}
.legend-line-arrow {
  width: 18px; height: 0; flex-shrink: 0;
  border-top: 1.5px dashed #ff1744;
}
.legend-size-dots {
  display: flex; align-items: center; gap: 3px; flex-shrink: 0;
}
.legend-size-dot {
  border-radius: 50%; border: 1px solid #556; background: rgba(255,255,255,0.04);
}
.legend-divider {
  height: 1px; background: rgba(255,255,255,0.04); margin: 6px 0;
}

/* ── Research credit ── */
.research-credit {
  background: linear-gradient(135deg, rgba(0,229,255,0.04) 0%, rgba(118,255,3,0.04) 100%);
  border: 1px solid rgba(0,229,255,0.1);
  border-radius: 8px; padding: 10px 12px; margin-bottom: 14px;
}
.research-credit-title {
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px; font-weight: 600; text-transform: uppercase;
  letter-spacing: 1.5px; color: #00e5ff; margin-bottom: 6px;
}
.research-credit-text {
  font-size: 11px; color: #889; line-height: 1.5;
}
.research-credit-text a {
  color: #00e5ff; text-decoration: none; font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
}
.research-credit-text a:hover { text-decoration: underline; }
.research-tag {
  display: inline-block; font-family: 'JetBrains Mono', monospace;
  font-size: 9px; padding: 2px 6px; border-radius: 3px;
  background: rgba(0,229,255,0.08); color: #00e5ff;
  border: 1px solid rgba(0,229,255,0.15); margin: 3px 2px 0 0;
}

/* ── Search ── */
.search-wrap {
  position: relative; display: flex; align-items: center;
}
.search-input {
  font-family: 'JetBrains Mono', monospace; font-size: 12px;
  background: rgba(255,255,255,0.04); color: #e0e0e0;
  border: 1px solid rgba(255,255,255,0.1); border-radius: 4px;
  padding: 5px 10px 5px 30px; width: 200px; outline: none;
  transition: border-color 0.2s, background 0.2s;
}
.search-input::placeholder { color: #445; }
.search-input:focus {
  border-color: rgba(0,229,255,0.4); background: rgba(255,255,255,0.06);
}
.search-icon {
  position: absolute; left: 9px; top: 50%; transform: translateY(-50%);
  color: #445; font-size: 13px; pointer-events: none; line-height: 1;
}
.search-clear {
  position: absolute; right: 6px; top: 50%; transform: translateY(-50%);
  background: none; border: none; color: #556; font-size: 14px;
  cursor: pointer; padding: 0 3px; line-height: 1; display: none;
}
.search-clear:hover { color: #aaa; }
.search-dropdown {
  position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px;
  background: #161c28; border: 1px solid rgba(255,255,255,0.1);
  border-radius: 6px; overflow: hidden; display: none;
  box-shadow: 0 8px 30px rgba(0,0,0,0.6); z-index: 200;
  max-height: 320px; overflow-y: auto;
  scrollbar-width: thin; scrollbar-color: #1a2030 #161c28;
}
.search-dropdown.visible { display: block; }
.search-item {
  display: flex; align-items: center; gap: 8px;
  padding: 8px 12px; cursor: pointer; transition: background 0.15s;
  border-bottom: 1px solid rgba(255,255,255,0.03);
}
.search-item:last-child { border-bottom: none; }
.search-item:hover, .search-item.active {
  background: rgba(0,229,255,0.08);
}
.search-item-dot {
  width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0;
}
.search-item-name {
  font-family: 'JetBrains Mono', monospace; font-size: 12px;
  color: #ddd; flex: 1;
}
.search-item-name mark {
  background: none; color: #00e5ff; font-weight: 600;
}
.search-item-layer {
  font-size: 9px; color: #556; text-transform: uppercase;
  letter-spacing: 0.5px; flex-shrink: 0;
}
.search-empty {
  padding: 12px; text-align: center; font-size: 11px; color: #445;
  font-family: 'JetBrains Mono', monospace;
}
.search-kbd {
  font-family: 'JetBrains Mono', monospace; font-size: 9px;
  color: #334; background: rgba(255,255,255,0.04);
  border: 1px solid rgba(255,255,255,0.06); border-radius: 3px;
  padding: 1px 5px; margin-left: 6px;
}

/* ── Search highlight ring ── */
@keyframes searchPing {
  0% { stroke-opacity: 0.9; stroke-width: 4; }
  100% { stroke-opacity: 0; stroke-width: 20; }
}
.search-ring {
  fill: none; stroke: #00e5ff; stroke-width: 4;
  animation: searchPing 1.2s ease-out forwards;
  pointer-events: none;
}
</style>
</head>
<body>
<div id="app">
  <!-- HEADER -->
  <header id="header">
    <h1>DEPENDENCY MAP &middot; ML SUPPLY CHAIN</h1>
    <div class="header-controls">
      <div class="layer-filters" id="layerFilters"></div>
      <div class="search-wrap" id="searchWrap">
        <span class="search-icon">&#x2315;</span>
        <input class="search-input" id="searchInput" type="text" placeholder="Search nodes..." autocomplete="off" spellcheck="false">
        <button class="search-clear" id="searchClear">&times;</button>
        <span class="search-kbd">/</span>
        <div class="search-dropdown" id="searchDropdown"></div>
      </div>
      <button class="sim-btn" id="simBtn" onclick="toggleSimMode()">&#x26A0; Compromise Simulation</button>
      <button class="sim-reset" id="simReset" onclick="resetSimulation()">Reset</button>
    </div>
  </header>

  <!-- SIDEBAR -->
  <aside id="sidebar">
    <div style="margin-bottom:12px;font-size:11px;color:#667;"><a href="https://t.me/pwnai" target="_blank" rel="noopener" style="color:#00e5ff;text-decoration:none;font-family:'JetBrains Mono',monospace;font-size:11px;">@pwnai</a> <span style="color:#445;font-size:10px;">on Telegram</span></div>
    <div class="sidebar-section-title">Key Ecosystem Metrics</div>
    <div class="stat-cards">
      <div class="stat-card">
        <div class="stat-value" style="color:#00e5ff">1.7B</div>
        <div class="stat-label">Monthly Downloads (Pickle+SafeT Repos)</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" style="color:#76ff03">3M+</div>
        <div class="stat-label">Models on HuggingFace Hub</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" style="color:#ff1744">877K</div>
        <div class="stat-label">Malicious OSS Packages (Total, Sonatype)</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" style="color:#ff9100">400M+</div>
        <div class="stat-label">Pickle-Only Model Downloads/mo</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" style="color:#ffea00">~92%</div>
        <div class="stat-label">NVIDIA GPU Market (AI Infra)</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" style="color:#d500f9">50K+</div>
        <div class="stat-label">Companies Using HuggingFace</div>
      </div>
    </div>

    <!-- Legend -->
    <div class="sidebar-section-title">Map Legend</div>
    <div class="legend-box">
      <div class="legend-row">
        <div class="legend-dot" style="border-color:#ff1744; background:rgba(255,23,68,0.15);"></div>
        <span>Hardware</span>
      </div>
      <div class="legend-row">
        <div class="legend-dot" style="border-color:#ff9100; background:rgba(255,145,0,0.15);"></div>
        <span>Base Libraries</span>
      </div>
      <div class="legend-row">
        <div class="legend-dot" style="border-color:#ffea00; background:rgba(255,234,0,0.15);"></div>
        <span>ML Frameworks</span>
      </div>
      <div class="legend-row">
        <div class="legend-dot" style="border-color:#00e5ff; background:rgba(0,229,255,0.15);"></div>
        <span>HuggingFace Ecosystem</span>
      </div>
      <div class="legend-row">
        <div class="legend-dot" style="border-color:#76ff03; background:rgba(118,255,3,0.15);"></div>
        <span>Serving &amp; Inference</span>
      </div>
      <div class="legend-row">
        <div class="legend-dot" style="border-color:#d500f9; background:rgba(213,0,249,0.15);"></div>
        <span>Applications &amp; Agents</span>
      </div>
      <div class="legend-divider"></div>
      <div class="legend-row">
        <div class="legend-hex" style="background:#ff1744;"></div>
        <span>Hexagon = hardware component</span>
      </div>
      <div class="legend-row">
        <div class="legend-size-dots">
          <div class="legend-size-dot" style="width:6px;height:6px;"></div>
          <div class="legend-size-dot" style="width:10px;height:10px;"></div>
          <div class="legend-size-dot" style="width:14px;height:14px;"></div>
        </div>
        <span>Circle size = downloads/mo</span>
      </div>
      <div class="legend-row">
        <div class="legend-line"></div>
        <span>Edge = dependency (A &rarr; B)</span>
      </div>
      <div class="legend-row">
        <div class="legend-line-arrow"></div>
        <span>Compromise cascade path</span>
      </div>
    </div>

    <!-- Research credit -->
    <div class="research-credit">
      <div class="research-credit-title">Supply Chain Research</div>
      <div class="research-credit-text">
        Interactive dependency &amp; attack surface map of the ML/AI ecosystem. 41 packages, 105 edges, 12 real-world incidents. Data as of Q1 2026.<br>
        Built by <a href="https://t.me/pwnai" target="_blank" rel="noopener">@pwnai</a>
      </div>
      <div style="margin-top:6px;">
        <span class="research-tag">supply chain</span>
        <span class="research-tag">ML security</span>
        <span class="research-tag">dependency risk</span>
        <span class="research-tag">BFS simulation</span>
      </div>
    </div>

    <!-- Node detail panel -->
    <div id="node-detail">
      <div class="sidebar-section-title">Node Details</div>
      <div class="detail-header">
        <div class="detail-dot" id="detailDot"></div>
        <div>
          <div class="detail-name" id="detailName"></div>
          <div class="detail-layer" id="detailLayer"></div>
        </div>
      </div>
      <div class="detail-row">
        <span class="detail-row-label">Risk Level</span>
        <span class="detail-row-value" id="detailRisk"></span>
      </div>
      <div class="detail-row">
        <span class="detail-row-label">Downloads/mo</span>
        <span class="detail-row-value" id="detailDownloads"></span>
      </div>
      <div class="detail-row">
        <span class="detail-row-label">Dependent Repos</span>
        <span class="detail-row-value" id="detailDeps"></span>
      </div>
      <div class="detail-row">
        <span class="detail-row-label">Maintainers</span>
        <span class="maintainers-info" id="detailMaintainers"></span>
      </div>
      <div class="detail-section-title">Blast Radius</div>
      <div class="blast-radius-text" id="detailBlast"></div>
      <div class="detail-section-title" id="cveSectionTitle" style="display:none">CVE / Vulnerabilities</div>
      <div id="detailCVEs"></div>
      <div class="detail-section-title" id="attackSectionTitle" style="display:none">Attacks / Incidents</div>
      <div id="detailAttacks"></div>
      <div class="detail-section-title" id="threatSectionTitle" style="display:none">Threat Actors</div>
      <div id="detailThreats"></div>
    </div>

    <!-- Compromise simulation results -->
    <div id="compromise-panel">
      <div class="sidebar-section-title" style="color:#ff1744">Simulation Results</div>
      <div class="compromise-stats">
        <div class="compromise-stat-row">
          <span class="compromise-stat-label">Affected Nodes</span>
          <span class="compromise-stat-value" id="compNodes">0</span>
        </div>
        <div class="compromise-stat-row">
          <span class="compromise-stat-label">Total Downloads/mo</span>
          <span class="compromise-stat-value" id="compDownloads">0</span>
        </div>
        <div class="compromise-stat-row">
          <span class="compromise-stat-label">Cascade Depth</span>
          <span class="compromise-stat-value" id="compDepth">0</span>
        </div>
      </div>
    </div>
  </aside>

  <!-- MAIN GRAPH -->
  <div id="main">
    <svg id="graphSvg"></svg>
    <div class="graph-tooltip" id="tooltip"></div>
    <div class="graph-hint" id="graphHint">scroll: zoom &middot; drag: navigate &middot; click: details</div>
  </div>

  <!-- TIMELINE -->
  <div id="timeline">
    <div class="timeline-title">ML Ecosystem Incident Timeline</div>
    <div class="timeline-track" id="timelineTrack">
      <div class="timeline-axis"></div>
    </div>
  </div>
</div>

<script>
// ══════════════════════════════════════════════════
// DATA
// ══════════════════════════════════════════════════

const LAYERS = {
  hardware:  { name: 'Hardware',              color: '#ff1744', order: 0 },
  base:      { name: 'Base Libraries',        color: '#ff9100', order: 1 },
  framework: { name: 'ML Frameworks',         color: '#ffea00', order: 2 },
  hf:        { name: 'HuggingFace Ecosystem', color: '#00e5ff', order: 3 },
  serving:   { name: 'Serving',               color: '#76ff03', order: 4 },
  app:       { name: 'Applications',          color: '#d500f9', order: 5 },
};

const THREAT_ACTORS = {
  'nation-state': { label: 'Nation-State APT',     icon: '\u{1f3db}',  color: '#ff1744' },
  'crime':        { label: 'Organized Crime',      icon: '\u{1f4b0}',  color: '#ff9100' },
  'insider':      { label: 'Rogue Maintainer',     icon: '\u{1f47e}',  color: '#ffea00' },
  'supply-chain': { label: 'Supply Chain',         icon: '\u{1f4e6}',  color: '#d500f9' },
  'opportunist':  { label: 'Opportunistic / PoC',  icon: '\u{1f529}',  color: '#76ff03' },
};

const NODES = [
  // Hardware
  { id: 'cuda',         label: 'NVIDIA CUDA',     layer: 'hardware',  downloads: 0,      risk: 95, depRepos: 0,     maintainers: 'NVIDIA Corp',
    blast: 'Compromising CUDA affects ~90% of all GPU inference. PyTorch ships 13 CUDA libraries as direct dependencies. ChatGPT, Tesla Autopilot, all production transformer systems run on CUDA.',
    cves: [{ id: 'CVE-2023-4969', cvss: 6.5, desc: 'LeftoverLocals — GPU memory leak between processes (Apple/AMD/Qualcomm)' }],
    attacks: [],
    threats: [
      { actor: 'nation-state', vector: 'Hardware-level backdoors or export controls on GPU compute; compromise affects 90% of GPU inference' },
      { actor: 'supply-chain', vector: 'Trojanized CUDA toolkit or driver update distributed via official channels' }
    ], shape: 'hex' },
  { id: 'tsmc',         label: 'TSMC',             layer: 'hardware',  downloads: 0,      risk: 90, depRepos: 0,     maintainers: 'TSMC',
    blast: 'TSMC manufactures ~90% of advanced chips, including all NVIDIA GPUs. Taiwan Strait geopolitical risks pose an existential threat to the entire AI chip supply chain.',
    cves: [], attacks: [],
    threats: [
      { actor: 'nation-state', vector: 'Geopolitical disruption (Taiwan Strait), export sanctions, or fab sabotage' },
      { actor: 'insider', vector: 'IP theft of chip fabrication processes' }
    ], shape: 'hex' },
  { id: 'asml',         label: 'ASML',             layer: 'hardware',  downloads: 0,      risk: 85, depRepos: 0,     maintainers: 'ASML',
    blast: '100% monopoly on EUV lithography. Machines costing \u20AC200M \u2014 literally no alternative supplier for advanced chip manufacturing.',
    cves: [], attacks: [],
    threats: [
      { actor: 'nation-state', vector: 'Targeting EUV monopoly via export controls or industrial espionage' }
    ], shape: 'hex' },
  // Base libraries
  { id: 'numpy',        label: 'numpy',            layer: 'base',      downloads: 683000000,  risk: 88, depRepos: 59200, maintainers: '~15 core',
    blast: 'Cornerstone of the ML ecosystem. 59,200+ dependent repos \u2014 largest blast radius of any package. numpy 2.0 API-breaking changes caused cascading failures across the ecosystem.',
    cves: [],
    attacks: [
      { date: '2023', desc: 'numpy 2.0 breaking changes \u2014 cascade of dependent package failures' },
      { date: '2025', desc: 'np.load(allow_pickle=True): .npy/.npz files with pickle objects \u2014 RCE when loading untrusted arrays. Default changed in 1.16.3, but thousands of projects still use True' }
    ],
    threats: [
      { actor: 'insider', vector: 'Rogue maintainer \u2014 subtle backdoor in core numerical routines (only ~15 core devs)' },
      { actor: 'supply-chain', vector: 'Dependency confusion or typosquatting on PyPI targeting 59K+ dependent repos' }
    ], shape: 'circle' },
  { id: 'scipy',        label: 'scipy',            layer: 'base',      downloads: 257000000,  risk: 55, depRepos: 12000, maintainers: '~10 core',
    blast: '257M downloads/mo. Used for scientific computing, optimization, and statistics in ML pipelines.',
    cves: [], attacks: [],
    threats: [
      { actor: 'supply-chain', vector: 'PyPI package substitution targeting scientific computing users' },
      { actor: 'opportunist', vector: 'Exploiting known deserialization or C-extension vulnerabilities' }
    ], shape: 'circle' },
  { id: 'pandas',       label: 'pandas',           layer: 'base',      downloads: 489000000,  risk: 55, depRepos: 25000, maintainers: '~15 core',
    blast: '489M downloads/mo. Data processing layer for most ML systems.',
    cves: [],
    attacks: [{ date: '2025', desc: 'pd.read_pickle() \u2014 DataFrame deserialization via pickle, RCE when loading untrusted data' }],
    threats: [
      { actor: 'supply-chain', vector: 'Malicious release targeting 489M monthly downloads' },
      { actor: 'opportunist', vector: 'RCE via pd.read_pickle() on untrusted DataFrames' }
    ], shape: 'circle' },
  { id: 'scikit-learn', label: 'scikit-learn',     layer: 'base',      downloads: 159000000,  risk: 62, depRepos: 18000, maintainers: '~20 core',
    blast: '159M downloads/mo. Classical ML \u2014 classification, regression, clustering. Depends on numpy and scipy.',
    cves: [],
    attacks: [{ date: '2025', desc: 'Pickle deserialization via joblib.load \u2014 scikit-learn models stored as pickle, RCE via __reduce__' }],
    threats: [
      { actor: 'supply-chain', vector: 'PyPI substitution for widely-used ML library' },
      { actor: 'opportunist', vector: 'Pickle RCE via joblib.load() on untrusted model files' }
    ], shape: 'circle' },
  { id: 'pillow',       label: 'Pillow',           layer: 'base',      downloads: 253000000,  risk: 45, depRepos: 15000, maintainers: '~5 core',
    blast: '253M downloads/mo. Image processing, critical for all CV pipelines.',
    cves: [], attacks: [],
    threats: [
      { actor: 'supply-chain', vector: 'Compromised release affecting all CV pipelines' },
      { actor: 'opportunist', vector: 'Heap overflow via crafted image files (historical CVE pattern)' }
    ], shape: 'circle' },
  { id: 'matplotlib',   label: 'matplotlib',       layer: 'base',      downloads: 129000000,  risk: 40, depRepos: 20000, maintainers: '~15 core',
    blast: '129M downloads/mo. Data visualization, depends on numpy. Used throughout the ML ecosystem.',
    cves: [], attacks: [],
    threats: [
      { actor: 'supply-chain', vector: 'Dependency confusion on PyPI \u2014 large download surface' }
    ], shape: 'circle' },
  // ML Frameworks
  { id: 'pytorch',      label: 'PyTorch',          layer: 'framework', downloads: 70800000,   risk: 92, depRepos: 30000, maintainers: '7 core',
    blast: '70.8M downloads/mo. Only 7 core maintainers \u2014 critical concentration. Ships 13 NVIDIA CUDA libraries. Primary framework for LLM training and inference.',
    cves: [{ id: 'CVE-2025-32434', cvss: 9.3, desc: 'weights_only=True bypass in torch.load() \u2014 RCE via "safe" model loading' }],
    attacks: [
      { date: '2022-12', desc: 'torchtriton dependency confusion \u2014 SSH key exfiltration via DNS tunneling' },
      { date: '2024-11', desc: 'Free Hugs Part 2: TF exploit persistence \u2014 exploit from TF 2.15 works in TF 2.18, pickle protocol 4 bypasses scanners' },
      { date: '2025', desc: 'TorchScript (.pt): torch.jit.load executes arbitrary code without sandbox \u2014 RCE via compiled models. Format .pt/.pth = pickle + ZIP' }
    ],
    threats: [
      { actor: 'nation-state', vector: 'Only 7 core maintainers \u2014 single highest-leverage target in ML' },
      { actor: 'insider', vector: 'Rogue maintainer backdoor in training/inference core' },
      { actor: 'supply-chain', vector: 'Dependency confusion (torchtriton 2022 incident proved this works)' },
      { actor: 'crime', vector: 'Cryptomining via torch.load() RCE on GPU servers' }
    ], shape: 'circle' },
  { id: 'tensorflow',   label: 'TensorFlow',       layer: 'framework', downloads: 21200000,   risk: 70, depRepos: 15000, maintainers: 'Google team',
    blast: '21.2M downloads/mo. Widely used in production systems and mobile devices (TFLite).',
    cves: [],
    attacks: [
      { date: '2024-11', desc: 'Free Hugs Part 2: Lambda Layer exploit \u2014 marshal deserialization in legacy h5 models, persistence across TF versions' },
      { date: '2025', desc: 'SavedModel arbitrary ops: tf.py_function in SavedModel executes arbitrary Python on tf.saved_model.load. Protobuf format without ops validation' }
    ],
    threats: [
      { actor: 'supply-chain', vector: 'Compromised release via build pipeline targeting production/mobile (TFLite)' },
      { actor: 'opportunist', vector: 'Exploiting legacy SavedModel/h5 deserialization (Free Hugs research)' }
    ], shape: 'circle' },
  { id: 'keras',         label: 'Keras',            layer: 'framework', downloads: 17000000,   risk: 60, depRepos: 10000, maintainers: 'Google/community',
    blast: '17M downloads/mo. High-level API for TensorFlow and PyTorch. Widely used for prototyping and model training.',
    cves: [],
    attacks: [{ date: '2024-12', desc: 'Free Hugs Part 3: from_pretrained_keras loads legacy h5 with Lambda layers \u2014 marshal RCE' }],
    threats: [
      { actor: 'supply-chain', vector: 'Trojanized package targeting prototyping workflows' },
      { actor: 'opportunist', vector: 'Lambda layer marshal deserialization in legacy h5 models (Free Hugs Part 3)' }
    ], shape: 'circle' },
  // HuggingFace ecosystem
  { id: 'transformers', label: 'transformers',     layer: 'hf',        downloads: 104500000,  risk: 90, depRepos: 28575, maintainers: 'HF team (~20)',
    blast: '104.5M downloads/mo. Core HF ecosystem package \u2014 all models pass through it. 28,575 GitHub repos reuse pretrained models.',
    cves: [{ id: 'CVE-2024-3568', cvss: 7.4, desc: 'Path traversal in Hugging Face Hub \u2014 file extraction beyond target directory' }],
    attacks: [{ date: '2024-11', desc: 'Checkmarx Free Hugs: trust_remote_code obfuscation \u2014 masking True via dict/str/expression in README' }],
    threats: [
      { actor: 'supply-chain', vector: 'Malicious auto_map config or trust_remote_code obfuscation in model repos' },
      { actor: 'crime', vector: 'Data exfiltration via backdoored pretrained models (28K+ dependent repos)' }
    ], shape: 'circle' },
  { id: 'hf-hub',       label: 'huggingface-hub',  layer: 'hf',        downloads: 163000000,  risk: 92, depRepos: 20000, maintainers: 'HF team (~10)',
    blast: '163M downloads/mo. Compromise would affect EVERY HF cluster package simultaneously. 45.4B cumulative model downloads pass through it.',
    cves: [{ id: 'CVE-2024-3568', cvss: 7.4, desc: 'Path traversal \u2014 file extraction beyond target directory during model download' }],
    attacks: [
      { date: '2024-02', desc: 'Namespace hijacking (AIJacking) \u2014 takeover of deleted accounts, reverse shell via models with 100K+ downloads' },
      { date: '2024-12', desc: 'Free Hugs Part 1: malicious auto_map in config.json \u2014 arbitrary Python import during model loading' }
    ],
    threats: [
      { actor: 'supply-chain', vector: 'Namespace hijacking of deleted accounts to serve malicious models' },
      { actor: 'crime', vector: 'Mass distribution of trojanized models via the hub (45.4B cumulative downloads)' },
      { actor: 'insider', vector: 'Rogue employee \u2014 hub compromise would affect every HF package simultaneously' }
    ], shape: 'circle' },
  { id: 'tokenizers',   label: 'tokenizers',       layer: 'hf',        downloads: 98000000,   risk: 60, depRepos: 5000,  maintainers: 'HF team (~5)',
    blast: '98M downloads/mo. Rust tokenization implementation. Critical for all NLP models.',
    cves: [], attacks: [],
    threats: [
      { actor: 'insider', vector: 'Rogue maintainer \u2014 only ~5 core devs for Rust tokenizer used by all NLP models' },
      { actor: 'supply-chain', vector: 'Compromised crate/wheel targeting tokenizer pipeline' }
    ], shape: 'circle' },
  { id: 'safetensors',  label: 'safetensors',      layer: 'hf',        downloads: 56000000,   risk: 72, depRepos: 8000,  maintainers: 'HF team (~3)',
    blast: '56M downloads/mo. Positioned as a safe pickle replacement. Core \u2014 ~400 lines of Rust. Despite this, 44.9% of models still use pickle.',
    cves: [],
    attacks: [
      { date: '2024-02', desc: 'Safetensors conversion service hijack \u2014 converter bot used to poison models' },
      { date: '2024-12', desc: 'Free Hugs Part 4: PickleScan bypass via bdb.Bdb.run, pickle protocol 4, recursive torch.load' },
      { date: '2025', desc: 'Safetensors header bomb: JSON header up to 100MB \u2192 DoS during parsing. Metadata injection via arbitrary header keys' }
    ],
    threats: [
      { actor: 'insider', vector: 'Only ~3 maintainers for the "safe" format \u2014 extreme concentration risk' },
      { actor: 'supply-chain', vector: 'Conversion service hijack to poison models during pickle\u2192safetensors migration' }
    ], shape: 'circle' },
  { id: 'datasets',     label: 'datasets',         layer: 'hf',        downloads: 46000000,   risk: 65, depRepos: 4000,  maintainers: 'HF team (~8)',
    blast: '46M downloads/mo. 500K+ datasets loaded through it. 9 malicious data loading scripts found.',
    cves: [], attacks: [{ date: '2024', desc: '9 malicious dataset loading scripts discovered by MalHug' }],
    threats: [
      { actor: 'supply-chain', vector: 'Malicious data loading scripts (9 already found by MalHug)' },
      { actor: 'crime', vector: 'Training data poisoning via compromised datasets' }
    ], shape: 'circle' },
  { id: 'accelerate',   label: 'accelerate',       layer: 'hf',        downloads: 20600000,   risk: 55, depRepos: 3000,  maintainers: 'HF team (~5)',
    blast: '20.6M downloads/mo. Distributed training \u2014 compromise could affect all training pipelines.',
    cves: [], attacks: [],
    threats: [
      { actor: 'supply-chain', vector: 'Trojanized release targeting distributed training pipelines' },
      { actor: 'insider', vector: 'Backdoor in multi-GPU coordination code' }
    ], shape: 'circle' },
  { id: 'diffusers',    label: 'diffusers',        layer: 'hf',        downloads: 9800000,    risk: 55, depRepos: 2000,  maintainers: 'HF team (~8)',
    blast: '9.8M downloads/mo. Framework for diffusion models (Stable Diffusion, etc.).',
    cves: [], attacks: [],
    threats: [
      { actor: 'supply-chain', vector: 'Malicious diffusion model checkpoints on HuggingFace Hub' },
      { actor: 'crime', vector: 'Trojanized image generation models for CSAM or deepfakes' }
    ], shape: 'circle' },
  { id: 'peft',         label: 'peft',             layer: 'hf',        downloads: 7900000,    risk: 50, depRepos: 1500,  maintainers: 'HF team (~5)',
    blast: '7.9M downloads/mo. Parameter-efficient fine-tuning \u2014 LoRA and other adapters.',
    cves: [], attacks: [],
    threats: [
      { actor: 'supply-chain', vector: 'Poisoned LoRA adapters uploaded to model hubs' },
      { actor: 'crime', vector: 'Backdoored fine-tuning adapters that activate on specific inputs' }
    ], shape: 'circle' },
  { id: 'trl',          label: 'trl',              layer: 'hf',        downloads: 2500000,    risk: 50, depRepos: 800,   maintainers: 'HF team (~5)',
    blast: '2.5M downloads/mo. RLHF model training. Part of HF cluster, depends on transformers, pytorch, peft, accelerate, datasets.',
    cves: [], attacks: [],
    threats: [
      { actor: 'supply-chain', vector: 'Compromised RLHF training pipeline to manipulate model alignment' },
      { actor: 'insider', vector: 'Subtle reward model manipulation during RLHF training' }
    ], shape: 'circle' },
  // Serving
  { id: 'vllm',         label: 'vLLM',             layer: 'serving',   downloads: 6500000,    risk: 92, depRepos: 2000,  maintainers: '~15 core',
    blast: '5-8M downloads/mo. Production LLM serving standard. 60+ direct dependencies \u2192 ~150+ unique packages after transitive resolution.',
    cves: [
      { id: 'CVE-2025-32444', cvss: 10.0, desc: 'RCE via pickle deserialization in Mooncake integration (ZeroMQ)' },
      { id: 'CVE-2026-22778', cvss: 9.8, desc: 'RCE via video processing \u2014 heap overflow in FFmpeg/OpenCV' },
      { id: 'CVE-2026-22807', cvss: 8.8, desc: 'RCE via auto_map dynamic HF module loading' },
      { id: 'CVE-2026-24779', cvss: 7.1, desc: 'SSRF in MediaConnector \u2014 hostname validation bypass' }
    ],
    attacks: [
      { date: '2025-04', desc: 'CVE-2025-32444 CVSS 10.0 \u2014 pickle RCE via Mooncake ZeroMQ, unauthorized access' }
    ],
    threats: [
      { actor: 'crime', vector: 'Cryptomining on GPU inference servers via RCE (CVE-2025-32444 CVSS 10.0)' },
      { actor: 'opportunist', vector: 'Exploiting public PoCs for Mooncake pickle RCE or video processing heap overflow' },
      { actor: 'supply-chain', vector: 'Malicious dependency in 60+ direct deps (~150 transitive)' }
    ], shape: 'circle' },
  { id: 'onnx',         label: 'ONNX Runtime',     layer: 'serving',   downloads: 22900000,   risk: 68, depRepos: 5000,  maintainers: 'Microsoft',
    blast: '22.9M downloads/mo. Cross-platform inference \u2014 used by Azure, Windows ML, and many edge devices.',
    cves: [{ id: 'CVE-2024-27318', cvss: 7.5, desc: 'ONNX: path traversal via external_data \u2014 arbitrary file read during model loading' }],
    attacks: [
      { date: '2025', desc: 'Path traversal during ONNX model extraction + arbitrary custom operator execution' },
      { date: '2025', desc: 'ONNX Protobuf format: custom ops loading from shared libraries (.so/.dll) \u2014 arbitrary native code execution' }
    ],
    threats: [
      { actor: 'supply-chain', vector: 'Malicious custom operators (.so/.dll) loaded during ONNX model inference' },
      { actor: 'opportunist', vector: 'Path traversal via external_data during model loading (CVE-2024-27318)' }
    ], shape: 'circle' },
  { id: 'triton',       label: 'Triton',           layer: 'serving',   downloads: 35700000,   risk: 75, depRepos: 3000,  maintainers: 'OpenAI/NVIDIA',
    blast: '35.7M downloads/mo. GPU compiler, PyTorch auto-dependency. torchtriton was the target of the 2022 dependency confusion attack.',
    cves: [],
    attacks: [{ date: '2022-12', desc: 'torchtriton dependency confusion \u2014 2,717 malicious package downloads in 24 hours' }],
    threats: [
      { actor: 'supply-chain', vector: 'Dependency confusion \u2014 torchtriton attack (2022) proved this vector works' },
      { actor: 'nation-state', vector: 'GPU compiler backdoor affecting all PyTorch JIT compilation' }
    ], shape: 'circle' },
  // Applications
  { id: 'langchain',    label: 'LangChain',        layer: 'app',       downloads: 187000000,  risk: 75, depRepos: 8000,  maintainers: 'LangChain Inc',
    blast: '187M downloads/mo. LLM application framework \u2014 connects all ecosystem layers in production systems.',
    cves: [
      { id: 'CVE-2025-68664', cvss: 9.3, desc: '"LangGrinch" \u2014 serialization injection, secret leakage and RCE' },
      { id: 'CVE-2025-68665', cvss: 8.6, desc: 'Same for JS version @langchain/core' },
      { id: 'CVE-2025-64439', cvss: 8.4, desc: 'LangGraph checkpoint deserialization RCE \u2014 JsonPlusSerializer fallback reconstructs objects from attacker-controlled payloads' }
    ],
    attacks: [
      { date: '2025-12', desc: 'LangGrinch CVE-2025-68664 \u2014 API key leakage and RCE via serialization injection' },
      { date: '2025', desc: 'Prompt injection \u2192 Agent RCE: SQL injection via LangChain SQL Agent, data leakage via tool calling' }
    ],
    threats: [
      { actor: 'crime', vector: 'API key and secret extraction via serialization injection (LangGrinch)' },
      { actor: 'opportunist', vector: 'Prompt injection \u2192 SQL injection \u2192 RCE via LangChain SQL Agent' },
      { actor: 'supply-chain', vector: 'Malicious tool/chain in the fast-growing LangChain ecosystem' }
    ], shape: 'circle' },
  // New nodes from AI-Infra-Guard v3.6.2
  { id: 'ollama',       label: 'Ollama',           layer: 'serving',   downloads: 5000000,    risk: 85, depRepos: 3000,  maintainers: 'Ollama Inc (~10)',
    blast: '175K public servers. RCE via OOB-write in GGUF, no authentication. Local LLM inference.',
    cves: [
      { id: 'CVE-2025-63389', cvss: 8.5, desc: 'Missing API authentication \u2014 unauthorized model operations' }
    ],
    attacks: [{ date: '2025', desc: 'GGUF/GGML parsing: OOB write, heap overflow when loading crafted models' }],
    threats: [
      { actor: 'crime', vector: 'Cryptomining on 175K publicly exposed servers with no authentication' },
      { actor: 'opportunist', vector: 'OOB-write RCE via crafted GGUF model files' }
    ], shape: 'circle' },
  { id: 'mlflow',       label: 'MLflow',           layer: 'serving',   downloads: 20000000,   risk: 78, depRepos: 5000,  maintainers: 'LF AI (~20)',
    blast: '20M downloads/mo. ML lifecycle, model registry. Directory traversal \u2192 RCE (CVE-2025-11201).',
    cves: [
      { id: 'CVE-2025-11201', cvss: 8.8, desc: 'Directory traversal in Tracking Server \u2192 remote code execution' }
    ], attacks: [],
    threats: [
      { actor: 'opportunist', vector: 'Directory traversal \u2192 RCE on model registry servers (CVE-2025-11201)' },
      { actor: 'crime', vector: 'Model registry poisoning to distribute backdoored production models' }
    ], shape: 'circle' },
  { id: 'jupyter',      label: 'Jupyter',          layer: 'base',      downloads: 30000000,   risk: 65, depRepos: 40000, maintainers: 'Jupyter team (~30)',
    blast: '30M downloads/mo. Primary ML IDE. DOM clobbering via malicious notebooks (CVE-2024-43805).',
    cves: [
      { id: 'CVE-2024-43805', cvss: 7.6, desc: 'DOM Clobbering via malicious Markdown cells in notebooks' }
    ], attacks: [],
    threats: [
      { actor: 'opportunist', vector: 'DOM Clobbering via malicious shared notebooks (CVE-2024-43805)' },
      { actor: 'crime', vector: 'Social engineering via trojanized .ipynb notebooks with hidden code cells' }
    ], shape: 'circle' },
  { id: 'dask',         label: 'Dask',             layer: 'base',      downloads: 30000000,   risk: 70, depRepos: 8000,  maintainers: 'Dask team (~15)',
    blast: '30M downloads/mo. Distributed computing. Pickle deserialization \u2192 RCE (CVE-2024-10096).',
    cves: [
      { id: 'CVE-2024-10096', cvss: 8.0, desc: 'Pickle deserialization in distributed server \u2192 remote command execution' }
    ], attacks: [],
    threats: [
      { actor: 'opportunist', vector: 'Pickle RCE on exposed distributed workers (CVE-2024-10096)' },
      { actor: 'crime', vector: 'Hijacking distributed compute clusters for cryptomining' }
    ], shape: 'circle' },
  { id: 'langflow',     label: 'Langflow',         layer: 'app',       downloads: 2000000,    risk: 82, depRepos: 1500,  maintainers: 'DataStax (~15)',
    blast: '2M downloads/mo. 9 CVEs including multiple RCE and code injection. Visual LLM application builder.',
    cves: [
      { id: 'CVE-2025-3248', cvss: 9.8, desc: 'Unauthenticated RCE via /api/v1/validate/code \u2014 arbitrary Python code execution' }
    ], attacks: [],
    threats: [
      { actor: 'opportunist', vector: 'Unauthenticated RCE via /api/v1/validate/code (CVE-2025-3248 CVSS 9.8)' },
      { actor: 'crime', vector: 'Data theft from visual LLM workflows processing sensitive documents' }
    ], shape: 'circle' },
  { id: 'dify',         label: 'Dify',             layer: 'app',       downloads: 3000000,    risk: 80, depRepos: 2000,  maintainers: 'Dify Inc (~20)',
    blast: '3M downloads/mo. Sandbox escape with root privileges (CVE-2025-3466, CVSS 9.8). LLM platform.',
    cves: [
      { id: 'CVE-2025-3466', cvss: 9.8, desc: 'Sandbox escape \u2014 code execution with root privileges via code node' }
    ], attacks: [],
    threats: [
      { actor: 'opportunist', vector: 'Sandbox escape with root privileges (CVE-2025-3466 CVSS 9.8)' },
      { actor: 'crime', vector: 'Exfiltrating data from self-hosted LLM platform instances' }
    ], shape: 'circle' },
  // New nodes from XLSX/DOCX enrichment
  { id: 'gradio',        label: 'Gradio',           layer: 'app',       downloads: 15000000,   risk: 72, depRepos: 5000,  maintainers: 'HF team (~10)',
    blast: '15M downloads/mo. ML demos and interfaces. Arbitrary file read, SSRF, path traversal history. Primary tool for model demo interfaces.',
    cves: [{ id: 'CVE-2024-47084', cvss: 8.3, desc: 'SSRF via URL upload \u2014 access to internal services and metadata' }],
    attacks: [],
    threats: [
      { actor: 'opportunist', vector: 'Arbitrary file read and SSRF via URL upload (CVE-2024-47084)' },
      { actor: 'supply-chain', vector: 'Trojanized Gradio spaces serving malicious model demos' }
    ], shape: 'circle' },
  { id: 'ray',           label: 'Ray',              layer: 'serving',   downloads: 8000000,    risk: 78, depRepos: 4000,  maintainers: 'Anyscale (~20)',
    blast: '8M downloads/mo. Distributed ML framework. Unauthenticated dashboard \u2192 RCE. Pickle in Ray workers.',
    cves: [{ id: 'CVE-2023-48022', cvss: 9.8, desc: 'Unauthenticated Ray Dashboard \u2014 RCE via Job Submission API (ShadowRay)' }],
    attacks: [{ date: '2024', desc: 'Ray ObjectStore: pickle serialization of objects between workers \u2014 RCE upon compromising a single cluster node. No trust boundaries' }],
    threats: [
      { actor: 'crime', vector: 'Cryptomining via ShadowRay \u2014 unauthenticated dashboard RCE on compute clusters' },
      { actor: 'opportunist', vector: 'Pickle RCE between Ray workers with no trust boundaries' }
    ], shape: 'circle' },
  { id: 'wandb',         label: 'W&B',              layer: 'serving',   downloads: 5000000,    risk: 60, depRepos: 3000,  maintainers: 'Weights & Biases (~15)',
    blast: '5M downloads/mo. Experiment tracking. Artifact deserialization, API key leakage via logs.',
    cves: [], attacks: [],
    threats: [
      { actor: 'crime', vector: 'API key harvesting from leaked experiment logs' },
      { actor: 'supply-chain', vector: 'Trojanized artifact downloads from experiment tracking' }
    ], shape: 'circle' },
  { id: 'llamaindex',    label: 'LlamaIndex',       layer: 'app',       downloads: 8000000,    risk: 70, depRepos: 2000,  maintainers: 'LlamaIndex Inc (~15)',
    blast: '8M downloads/mo. RAG framework. Prompt injection \u2192 data exfiltration via retrieval-augmented generation.',
    cves: [{ id: 'CVE-2024-45202', cvss: 7.5, desc: 'Prompt injection via poisoned documents in RAG pipeline' }],
    attacks: [],
    threats: [
      { actor: 'crime', vector: 'Data exfiltration from RAG pipelines processing confidential documents' },
      { actor: 'opportunist', vector: 'Prompt injection via poisoned documents in retrieval pipeline' }
    ], shape: 'circle' },
  // Serialization format core
  { id: 'llama-cpp',     label: 'llama.cpp',        layer: 'serving',   downloads: 4000000,    risk: 80, depRepos: 6000,  maintainers: 'ggerganov + community (~30)',
    blast: '4M downloads/mo. Core GGUF/GGML parser \u2014 backbone of Ollama, LM Studio, GPT4All. Multiple heap overflow and OOB-write in tensor parsing. Compromise would affect all local LLM inference.',
    cves: [
      { id: 'CVE-2024-42479', cvss: 9.8, desc: 'GGUF: path traversal \u2192 arbitrary file overwrite during model extraction' },
      { id: 'CVE-2024-25294', cvss: 8.8, desc: 'GGUF parser: multiple heap buffer overflows during tensor processing' },
      { id: 'CVE-2024-23605', cvss: 8.2, desc: 'Heap buffer overflow in gguf_fread_str \u2014 RCE via crafted model' }
    ],
    attacks: [{ date: '2024-08', desc: 'GGUF header manipulation: OOB write via crafted tensor sizes, alignment check bypass' }],
    threats: [
      { actor: 'supply-chain', vector: 'Malicious GGUF model files with crafted headers \u2014 affects Ollama, LM Studio, GPT4All' },
      { actor: 'opportunist', vector: 'Heap buffer overflow via crafted tensor data (multiple CVEs)' }
    ], shape: 'circle' },
  // Agentic frameworks
  { id: 'crewai',        label: 'CrewAI',           layer: 'app',       downloads: 1000000,    risk: 75, depRepos: 2000,  maintainers: 'CrewAI Inc (~15)',
    blast: '1M downloads/mo. Multi-agent orchestration framework. 60% Fortune 500 claim. Internal GitHub token leak (Dec 2025) exposed all private repos. COLM 2025 research: orchestrator hijacking to download and execute malicious binaries, even bypassing sub-agent refusals.',
    cves: [],
    attacks: [
      { date: '2025-12', desc: 'Uncrew token leak: high-privilege internal GitHub token exposed via improper exception handling, granting full access to all private repos' },
      { date: '2025', desc: 'COLM 2025: control-flow hijacking of CrewAI orchestrators \u2014 sub-agents bypassed, reverse shell executed despite safety refusals' }
    ],
    threats: [
      { actor: 'crime', vector: 'Orchestrator hijacking \u2014 reverse shell via multi-agent control-flow manipulation' },
      { actor: 'supply-chain', vector: 'Exploiting leaked internal tokens (Dec 2025 incident) to poison private repos' }
    ], shape: 'circle' },
  { id: 'autogpt',       label: 'AutoGPT',          layer: 'app',       downloads: 500000,     risk: 82, depRepos: 3000,  maintainers: 'Significant Gravitas (~20)',
    blast: '166K+ GitHub stars, one of the most starred AI repos. Command denylist bypass (CVSS 9.8) via path normalization. API keys logged in plaintext. Autonomous code execution with minimal guardrails.',
    cves: [
      { id: 'CVE-2024-6091', cvss: 9.8, desc: 'Shell command denylist bypass via path normalization (/bin/./whoami) \u2014 OS command injection' },
      { id: 'CVE-2026-22038', cvss: 8.1, desc: 'API keys and auth secrets logged in plaintext via logger.info() in Stagehand integration' }
    ],
    attacks: [{ date: '2024', desc: 'Prompt injection hijacking: GPT-4 linked to AutoGPT for automated prompt injection via API requests, searches, and code execution' }],
    threats: [
      { actor: 'opportunist', vector: 'Command denylist bypass via path normalization \u2192 OS command injection' },
      { actor: 'crime', vector: 'Autonomous agents executing attacker-controlled code with minimal guardrails' }
    ], shape: 'circle' },
  { id: 'n8n',           label: 'n8n',              layer: 'app',       downloads: 2000000,    risk: 88, depRepos: 1500,  maintainers: 'n8n GmbH (~30)',
    blast: '103K+ internet-facing instances. 4 CVSS 9.9-10.0 vulnerabilities in a single month. AI workflow automation platform. Compromise exposes all connected API credentials, OAuth tokens, and database connections.',
    cves: [
      { id: 'CVE-2026-21858', cvss: 10.0, desc: 'Ni8mare: unauthenticated RCE via content-type confusion in webhook handling' },
      { id: 'CVE-2026-21877', cvss: 10.0, desc: 'Unrestricted file upload with dangerous type \u2014 chains with CVE-2026-21858 for full unauth compromise' },
      { id: 'CVE-2025-68613', cvss: 9.9, desc: 'Authenticated RCE via expression injection in workflow definitions' },
      { id: 'CVE-2025-68668', cvss: 9.9, desc: 'N8scape: Pyodide sandbox bypass via _pyodide._base.eval_code() \u2014 arbitrary OS commands' }
    ],
    attacks: [{ date: '2026-01', desc: 'Ni8mare: mass exploitation of 100K+ exposed n8n servers. Government advisories issued by Australia and Canada' }],
    threats: [
      { actor: 'opportunist', vector: '4 CVEs at CVSS 9.9-10.0 \u2014 unauth RCE, sandbox bypass, file upload chains' },
      { actor: 'crime', vector: 'Credential harvesting from 100K+ exposed instances (all connected API keys, OAuth tokens, databases)' }
    ], shape: 'circle' },
  { id: 'haystack',      label: 'Haystack',         layer: 'app',       downloads: 500000,     risk: 68, depRepos: 1500,  maintainers: 'deepset GmbH (~20)',
    blast: '18K GitHub stars. RAG and agent framework. Jinja2 SSTI in 7 components (PromptBuilder, ChatPromptBuilder, OutputAdapter, etc.) \u2014 arbitrary code execution via template injection.',
    cves: [
      { id: 'CVE-2024-41950', cvss: 7.5, desc: 'Server-Side Template Injection (SSTI) via Jinja2 in PromptBuilder and 6 other components \u2014 arbitrary code execution' }
    ],
    attacks: [{ date: '2025', desc: 'Flatt Security case study: Jinja2 SSTI pattern exploitable when user input embedded into prompt templates without sanitization' }],
    threats: [
      { actor: 'opportunist', vector: 'Jinja2 SSTI in 7 components \u2192 arbitrary code execution' },
      { actor: 'supply-chain', vector: 'Template injection via poisoned user input in RAG prompt templates' }
    ], shape: 'circle' },
  { id: 'metagpt',       label: 'MetaGPT',          layer: 'app',       downloads: 200000,     risk: 76, depRepos: 1000,  maintainers: 'Foundation Agents (~15)',
    blast: '45K GitHub stars. Multi-agent software engineering framework. Critical deserialization RCE in deserialize_message (ZDI-26-026). Agents generate and execute code autonomously.',
    cves: [
      { id: 'CVE-2026-0763', cvss: 9.8, desc: 'Deserialization of untrusted data in deserialize_message \u2014 Remote Code Execution (ZDI-26-026)' }
    ],
    attacks: [{ date: '2025', desc: 'Multi-agent code execution: 97% malicious code execution rate for GPT-4o orchestrators interacting with poisoned files (arXiv research)' }],
    threats: [
      { actor: 'opportunist', vector: 'Deserialization RCE in deserialize_message (CVE-2026-0763 CVSS 9.8)' },
      { actor: 'crime', vector: 'Poisoned files triggering 97% malicious code execution rate in multi-agent workflows' }
    ], shape: 'circle' },
];

// Edges: source DEPENDS ON target (arrow from source → target)
const EDGES = [
  // Everything → numpy
  { source: 'scipy',        target: 'numpy' },
  { source: 'pandas',       target: 'numpy' },
  { source: 'pytorch',      target: 'numpy' },
  { source: 'tensorflow',   target: 'numpy' },
  { source: 'transformers', target: 'numpy' },
  { source: 'datasets',     target: 'numpy' },
  { source: 'onnx',         target: 'numpy' },
  { source: 'vllm',         target: 'numpy' },
  { source: 'accelerate',   target: 'numpy' },
  // Frameworks → CUDA
  { source: 'pytorch',      target: 'cuda' },
  { source: 'tensorflow',   target: 'cuda' },
  // HF cluster → hf-hub + pytorch
  { source: 'transformers', target: 'hf-hub' },
  { source: 'transformers', target: 'pytorch' },
  { source: 'transformers', target: 'tokenizers' },
  { source: 'transformers', target: 'safetensors' },
  { source: 'tokenizers',   target: 'hf-hub' },
  { source: 'safetensors',  target: 'hf-hub' },
  { source: 'datasets',     target: 'hf-hub' },
  { source: 'accelerate',   target: 'pytorch' },
  { source: 'accelerate',   target: 'hf-hub' },
  { source: 'diffusers',    target: 'transformers' },
  { source: 'diffusers',    target: 'pytorch' },
  { source: 'diffusers',    target: 'hf-hub' },
  { source: 'diffusers',    target: 'safetensors' },
  { source: 'diffusers',    target: 'accelerate' },
  { source: 'diffusers',    target: 'pillow' },
  { source: 'peft',         target: 'transformers' },
  { source: 'peft',         target: 'pytorch' },
  { source: 'peft',         target: 'hf-hub' },
  { source: 'peft',         target: 'accelerate' },
  // vLLM
  { source: 'vllm',         target: 'pytorch' },
  { source: 'vllm',         target: 'transformers' },
  { source: 'vllm',         target: 'triton' },
  { source: 'vllm',         target: 'cuda' },
  { source: 'vllm',         target: 'hf-hub' },
  { source: 'vllm',         target: 'safetensors' },
  // Triton + pytorch → triton (torchtriton — inc1 attack vector)
  { source: 'pytorch',      target: 'triton' },
  { source: 'triton',       target: 'cuda' },
  // ONNX
  { source: 'onnx',         target: 'pytorch' },
  // Hardware chain
  { source: 'cuda',         target: 'tsmc' },
  { source: 'tsmc',         target: 'asml' },
  // LangChain
  { source: 'langchain',    target: 'transformers' },
  { source: 'langchain',    target: 'pytorch' },
  { source: 'langchain',    target: 'hf-hub' },
  // scipy → pandas
  { source: 'pandas',       target: 'scipy' },
  // scikit-learn
  { source: 'scikit-learn', target: 'numpy' },
  { source: 'scikit-learn', target: 'scipy' },
  // keras
  { source: 'keras',        target: 'tensorflow' },
  { source: 'keras',        target: 'numpy' },
  // pillow
  { source: 'pillow',       target: 'numpy' },
  // matplotlib
  { source: 'matplotlib',   target: 'numpy' },
  // trl
  { source: 'trl',          target: 'transformers' },
  { source: 'trl',          target: 'pytorch' },
  { source: 'trl',          target: 'hf-hub' },
  { source: 'trl',          target: 'peft' },
  { source: 'trl',          target: 'accelerate' },
  { source: 'trl',          target: 'datasets' },
  // Ollama
  { source: 'ollama',       target: 'llama-cpp' },
  { source: 'ollama',       target: 'cuda' },
  // llama.cpp
  { source: 'llama-cpp',    target: 'cuda' },
  // MLflow
  { source: 'mlflow',       target: 'pytorch' },
  { source: 'mlflow',       target: 'tensorflow' },
  { source: 'mlflow',       target: 'numpy' },
  { source: 'mlflow',       target: 'hf-hub' },
  // Jupyter
  { source: 'jupyter',      target: 'numpy' },
  { source: 'jupyter',      target: 'scipy' },
  { source: 'jupyter',      target: 'pandas' },
  { source: 'jupyter',      target: 'matplotlib' },
  // Dask
  { source: 'dask',         target: 'numpy' },
  { source: 'dask',         target: 'scipy' },
  { source: 'dask',         target: 'pandas' },
  // Langflow
  { source: 'langflow',     target: 'langchain' },
  { source: 'langflow',     target: 'transformers' },
  { source: 'langflow',     target: 'hf-hub' },
  // Dify
  { source: 'dify',         target: 'langchain' },
  { source: 'dify',         target: 'transformers' },
  { source: 'dify',         target: 'hf-hub' },
  // Gradio
  { source: 'gradio',       target: 'transformers' },
  { source: 'gradio',       target: 'pytorch' },
  { source: 'gradio',       target: 'hf-hub' },
  { source: 'gradio',       target: 'numpy' },
  { source: 'gradio',       target: 'pillow' },
  // Ray
  { source: 'ray',          target: 'pytorch' },
  { source: 'ray',          target: 'numpy' },
  { source: 'ray',          target: 'cuda' },
  // W&B
  { source: 'wandb',        target: 'pytorch' },
  { source: 'wandb',        target: 'tensorflow' },
  { source: 'wandb',        target: 'numpy' },
  { source: 'wandb',        target: 'hf-hub' },
  // LlamaIndex
  { source: 'llamaindex',   target: 'langchain' },
  { source: 'llamaindex',   target: 'transformers' },
  { source: 'llamaindex',   target: 'hf-hub' },
  { source: 'llamaindex',   target: 'pytorch' },
  // CrewAI
  { source: 'crewai',       target: 'langchain' },
  { source: 'crewai',       target: 'transformers' },
  { source: 'crewai',       target: 'hf-hub' },
  // AutoGPT
  { source: 'autogpt',      target: 'langchain' },
  { source: 'autogpt',      target: 'pytorch' },
  // n8n
  { source: 'n8n',          target: 'langchain' },
  { source: 'n8n',          target: 'hf-hub' },
  // Haystack
  { source: 'haystack',     target: 'transformers' },
  { source: 'haystack',     target: 'hf-hub' },
  { source: 'haystack',     target: 'pytorch' },
  // MetaGPT
  { source: 'metagpt',      target: 'pytorch' },
  { source: 'metagpt',      target: 'transformers' },
];

const INCIDENTS = [
  { id: 'inc1', date: '2022-12', label: 'PyTorch torchtriton dependency confusion', nodes: ['pytorch', 'triton'],
    desc: 'Attacker registered malicious torchtriton on PyPI. 2,717 downloads, SSH key exfiltration via DNS tunneling.' },
  { id: 'inc2', date: '2024-02', label: '100 malicious models on HF', nodes: ['hf-hub', 'transformers'],
    desc: 'JFrog discovered ~100 models with reverse shell payload via pickle __reduce__. After removal \u2014 re-uploads with new IPs.' },
  { id: 'inc3', date: '2024-02', label: 'Safetensors converter hijack', nodes: ['safetensors', 'hf-hub'],
    desc: 'HiddenLayer: official HF conversion bot could be hijacked to send malicious PRs to any platform repository.' },
  { id: 'inc4', date: '2025-02', label: 'nullifAI Picklescan bypass', nodes: ['hf-hub', 'transformers', 'safetensors'],
    desc: 'ReversingLabs: 7z instead of ZIP to bypass scanner. Payload executed before parser error. Cross-platform reverse shells.' },
  { id: 'inc5', date: '2025-04', label: 'CVE-2025-32434 CVSS 9.3', nodes: ['pytorch'],
    desc: 'weights_only=True bypass in torch.load() \u2014 RCE via "safe" loading. All PyTorch versions \u22642.5.1 affected.' },
  { id: 'inc6', date: '2025-04', label: 'vLLM Mooncake RCE CVSS 10.0', nodes: ['vllm'],
    desc: 'CVE-2025-32444: pickle deserialization via ZeroMQ in Mooncake integration. CVSS 10.0, unauthorized RCE.' },
  { id: 'inc7', date: '2025-12', label: 'LangGrinch \u2014 secret leakage', nodes: ['langchain'],
    desc: 'CVE-2025-68664: serialization injection in langchain-core. API key leakage via prompt injection + RCE.' },
  { id: 'inc8', date: '2026-01', label: 'Ni8mare: n8n unauth RCE', nodes: ['n8n', 'langflow', 'dify'],
    desc: 'CVE-2026-21858 CVSS 10.0: unauthenticated RCE in n8n. 100K+ servers vulnerable. Government advisories from Australia and Canada. Wave of attacks on AI-workflow platforms.' },
  { id: 'inc9', date: '2024-11', label: 'Checkmarx Free Hugs: HF ecosystem exploits', nodes: ['transformers', 'hf-hub', 'safetensors'],
    desc: 'Checkmarx Free Hugs Parts 1-4 series: trust_remote_code obfuscation, pickle protocol 4 scanner bypass, bdb/pdb gadgets, exploit persistence across TF versions.' },
  { id: 'inc10', date: '2024-08', label: 'GGUF parser RCE: llama.cpp heap overflows', nodes: ['llama-cpp', 'ollama'],
    desc: 'Series of critical CVEs in llama.cpp GGUF parser: heap buffer overflow (CVE-2024-25294), OOB write, path traversal (CVE-2024-42479 CVSS 9.8). Ollama, LM Studio, GPT4All affected.' },
  { id: 'inc11', date: '2024-06', label: 'AutoGPT CVSS 9.8: command denylist bypass', nodes: ['autogpt'],
    desc: 'CVE-2024-6091: shell command denylist bypass via path normalization (/bin/./whoami). 166K+ starred project. OS command injection in autonomous AI agent.' },
  { id: 'inc12', date: '2025-04', label: 'MCP tool poisoning: agent supply chain attacks', nodes: ['langchain', 'crewai', 'llamaindex'],
    desc: 'Invariant Labs: MCP tool poisoning via hidden instructions in tool descriptions. 43% of MCP implementations had command injection. WhatsApp histories, SSH keys, GitHub repos exfiltrated. CVE-2025-6514 CVSS 9.6: mcp-remote RCE (437K downloads).' },
];

// ══════════════════════════════════════════════════
// GLOBALS
// ══════════════════════════════════════════════════
let simulation, svg, g, linkGroup, nodeGroup, hullGroup, arrowDefs, graphZoom;
let simMode = false;
let activeFilters = new Set(Object.keys(LAYERS));
let nodeMap = {};
let adjForward = {};  // source → [target]  (source depends on target)
let adjReverse = {};  // target → [source]  (who depends on target)

NODES.forEach(n => { nodeMap[n.id] = n; adjForward[n.id] = []; adjReverse[n.id] = []; });
EDGES.forEach(e => {
  adjForward[e.source] = adjForward[e.source] || [];
  adjForward[e.source].push(e.target);
  adjReverse[e.target] = adjReverse[e.target] || [];
  adjReverse[e.target].push(e.source);
});

// ══════════════════════════════════════════════════
// INIT
// ══════════════════════════════════════════════════
document.addEventListener('DOMContentLoaded', () => {
  buildLayerFilters();
  buildTimeline();
  buildGraph();
});

// ══════════════════════════════════════════════════
// LAYER FILTERS
// ══════════════════════════════════════════════════
function buildLayerFilters() {
  const container = document.getElementById('layerFilters');
  Object.entries(LAYERS).forEach(([key, l]) => {
    const chip = document.createElement('button');
    chip.className = 'layer-chip active';
    chip.textContent = l.name;
    chip.style.borderColor = l.color;
    chip.style.color = l.color;
    chip.dataset.layer = key;
    chip.onclick = () => toggleLayer(key, chip);
    container.appendChild(chip);
  });
}

function toggleLayer(key, chip) {
  if (activeFilters.has(key)) { activeFilters.delete(key); chip.classList.remove('active'); }
  else { activeFilters.add(key); chip.classList.add('active'); }
  updateVisibility();
}

function updateVisibility() {
  nodeGroup.each(function(d) {
    d3.select(this).style('display', activeFilters.has(d.layer) ? null : 'none');
  });
  linkGroup.each(function(d) {
    const srcVis = activeFilters.has(nodeMap[d.source.id || d.source]?.layer);
    const tgtVis = activeFilters.has(nodeMap[d.target.id || d.target]?.layer);
    d3.select(this).style('display', srcVis && tgtVis ? null : 'none');
  });
  hullGroup.each(function(d) {
    d3.select(this).style('display', activeFilters.has(d) ? null : 'none');
  });
}

// ══════════════════════════════════════════════════
// GRAPH
// ══════════════════════════════════════════════════
function buildGraph() {
  const container = document.getElementById('main');
  const W = container.clientWidth;
  const H = container.clientHeight;

  svg = d3.select('#graphSvg');

  // Defs: glow filters + arrow markers
  const defs = svg.append('defs');

  // Glow filters per layer
  Object.entries(LAYERS).forEach(([key, l]) => {
    const filter = defs.append('filter').attr('id', `glow-${key}`)
      .attr('x', '-50%').attr('y', '-50%').attr('width', '200%').attr('height', '200%');
    filter.append('feGaussianBlur').attr('stdDeviation', '4').attr('result', 'blur');
    const merge = filter.append('feMerge');
    merge.append('feMergeNode').attr('in', 'blur');
    merge.append('feMergeNode').attr('in', 'SourceGraphic');
  });

  // Critical glow (stronger)
  const critGlow = defs.append('filter').attr('id', 'glow-critical')
    .attr('x', '-50%').attr('y', '-50%').attr('width', '200%').attr('height', '200%');
  critGlow.append('feGaussianBlur').attr('stdDeviation', '8').attr('result', 'blur');
  const critMerge = critGlow.append('feMerge');
  critMerge.append('feMergeNode').attr('in', 'blur');
  critMerge.append('feMergeNode').attr('in', 'SourceGraphic');

  // Arrow marker
  defs.append('marker')
    .attr('id', 'arrowhead')
    .attr('viewBox', '0 -5 10 10')
    .attr('refX', 20).attr('refY', 0)
    .attr('markerWidth', 6).attr('markerHeight', 6)
    .attr('orient', 'auto')
    .append('path').attr('d', 'M0,-4L10,0L0,4').attr('class', 'link-arrow')
    .style('fill', '#556');

  // Zoom
  const zoom = d3.zoom()
    .scaleExtent([0.3, 4])
    .on('zoom', (event) => { g.attr('transform', event.transform); });
  svg.call(zoom);
  graphZoom = zoom;

  g = svg.append('g');

  // Cluster centers
  const layerCenters = {
    hardware:  { x: W * 0.15, y: H * 0.25 },
    base:      { x: W * 0.32, y: H * 0.82 },
    framework: { x: W * 0.3,  y: H * 0.5 },
    hf:        { x: W * 0.6,  y: H * 0.45 },
    serving:   { x: W * 0.8, y: H * 0.28 },
    app:       { x: W * 0.82, y: H * 0.72 },
  };

  // Radius scale
  const maxDl = d3.max(NODES, d => d.downloads);
  const rScale = d3.scaleSqrt().domain([0, maxDl]).range([14, 55]);

  // Copy nodes data
  const nodesData = NODES.map(d => ({
    ...d,
    r: d.downloads > 0 ? rScale(d.downloads) : (d.layer === 'hardware' ? 30 : 18),
    x: layerCenters[d.layer].x + (Math.random() - 0.5) * 80,
    y: layerCenters[d.layer].y + (Math.random() - 0.5) * 60,
  }));

  const edgesData = EDGES.map(d => ({ ...d }));

  // Convex hulls
  hullGroup = g.selectAll('.cluster-hull')
    .data(Object.keys(LAYERS))
    .enter().append('path')
    .attr('class', 'cluster-hull')
    .attr('fill', d => LAYERS[d].color)
    .attr('fill-opacity', 0.03)
    .attr('stroke', d => LAYERS[d].color)
    .attr('stroke-opacity', 0.12)
    .attr('stroke-dasharray', '4 2');

  // Links
  linkGroup = g.selectAll('.link-line')
    .data(edgesData)
    .enter().append('path')
    .attr('class', 'link-line')
    .attr('stroke', '#334')
    .attr('stroke-width', 1.2)
    .attr('marker-end', 'url(#arrowhead)');

  // Nodes
  nodeGroup = g.selectAll('.node-group')
    .data(nodesData)
    .enter().append('g')
    .attr('class', 'node-group')
    .call(d3.drag()
      .on('start', dragStart)
      .on('drag', dragging)
      .on('end', dragEnd))
    .on('mouseover', onNodeHover)
    .on('mouseout', onNodeOut)
    .on('click', onNodeClick);

  // Draw shapes
  nodeGroup.each(function(d) {
    const el = d3.select(this);
    const layerColor = LAYERS[d.layer].color;
    const glowFilter = d.risk >= 85 ? 'url(#glow-critical)' : `url(#glow-${d.layer})`;

    if (d.shape === 'hex') {
      const r = d.r;
      const hex = d3.range(6).map(i => {
        const angle = (Math.PI / 3) * i - Math.PI / 6;
        return [r * Math.cos(angle), r * Math.sin(angle)];
      });
      el.append('polygon')
        .attr('class', 'node-hex')
        .attr('points', hex.map(p => p.join(',')).join(' '))
        .attr('fill', hexToRGBA(layerColor, 0.15))
        .attr('stroke', layerColor)
        .style('filter', glowFilter);
    } else {
      el.append('circle')
        .attr('class', 'node-circle')
        .attr('r', d.r)
        .attr('fill', hexToRGBA(layerColor, 0.12))
        .attr('stroke', layerColor)
        .style('filter', glowFilter);
    }

    el.append('text')
      .attr('class', 'node-label')
      .attr('dy', d.r + 14)
      .text(d.label);
  });

  // Force simulation
  simulation = d3.forceSimulation(nodesData)
    .force('link', d3.forceLink(edgesData).id(d => d.id).distance(120).strength(0.3))
    .force('charge', d3.forceManyBody().strength(-500))
    .force('x', d3.forceX(d => layerCenters[d.layer].x).strength(0.15))
    .force('y', d3.forceY(d => layerCenters[d.layer].y).strength(0.15))
    .force('collide', d3.forceCollide(d => d.r + 12).strength(0.8))
    .on('tick', ticked);

  function ticked() {
    linkGroup.attr('d', d => {
      const dx = d.target.x - d.source.x;
      const dy = d.target.y - d.source.y;
      const dr = Math.sqrt(dx * dx + dy * dy) * 1.5;
      return `M${d.source.x},${d.source.y}A${dr},${dr} 0 0,1 ${d.target.x},${d.target.y}`;
    });

    nodeGroup.attr('transform', d => `translate(${d.x},${d.y})`);
    updateHulls(nodesData);
  }

  function updateHulls(nodes) {
    hullGroup.attr('d', layer => {
      const pts = nodes.filter(n => n.layer === layer).map(n => [n.x, n.y]);
      if (pts.length < 3) return null;
      const hull = d3.polygonHull(expandPoints(pts, 30));
      return hull ? `M${hull.join('L')}Z` : null;
    });
  }

  // Center view
  const initTransform = d3.zoomIdentity.translate(0, 0).scale(1);
  svg.call(zoom.transform, initTransform);

  // Resize handler
  window.addEventListener('resize', () => {
    const nW = container.clientWidth;
    const nH = container.clientHeight;
    const scaleX = nW / W;
    const scaleY = nH / H;
    Object.keys(layerCenters).forEach(k => {
      layerCenters[k].x *= scaleX;
      layerCenters[k].y *= scaleY;
    });
    simulation.force('x', d3.forceX(d => layerCenters[d.layer].x).strength(0.15));
    simulation.force('y', d3.forceY(d => layerCenters[d.layer].y).strength(0.15));
    simulation.alpha(0.3).restart();
  });
}

// ── Helpers ──
function hexToRGBA(hex, alpha) {
  const r = parseInt(hex.slice(1, 3), 16);
  const g = parseInt(hex.slice(3, 5), 16);
  const b = parseInt(hex.slice(5, 7), 16);
  return `rgba(${r},${g},${b},${alpha})`;
}

function expandPoints(points, padding) {
  if (points.length < 2) return points;
  const cx = d3.mean(points, p => p[0]);
  const cy = d3.mean(points, p => p[1]);
  return points.map(p => {
    const dx = p[0] - cx;
    const dy = p[1] - cy;
    const dist = Math.sqrt(dx * dx + dy * dy) || 1;
    return [p[0] + (dx / dist) * padding, p[1] + (dy / dist) * padding];
  });
}

function formatNumber(n) {
  if (n >= 1e9) return (n / 1e9).toFixed(1) + 'B';
  if (n >= 1e6) return (n / 1e6).toFixed(1) + 'M';
  if (n >= 1e3) return (n / 1e3).toFixed(1) + 'K';
  return n.toString();
}

// ── Drag ──
function dragStart(event, d) {
  if (!event.active) simulation.alphaTarget(0.3).restart();
  d.fx = d.x; d.fy = d.y;
}
function dragging(event, d) { d.fx = event.x; d.fy = event.y; }
function dragEnd(event, d) {
  if (!event.active) simulation.alphaTarget(0);
  d.fx = null; d.fy = null;
}

// ══════════════════════════════════════════════════
// HOVER — highlight neighbors
// ══════════════════════════════════════════════════
function onNodeHover(event, d) {
  if (simMode) return;

  const neighbors = new Set([d.id]);
  (adjForward[d.id] || []).forEach(n => neighbors.add(n));
  (adjReverse[d.id] || []).forEach(n => neighbors.add(n));

  nodeGroup.classed('dimmed', n => !neighbors.has(n.id));
  nodeGroup.classed('highlighted', n => neighbors.has(n.id));
  linkGroup.classed('dimmed', e => {
    const sid = e.source.id || e.source;
    const tid = e.target.id || e.target;
    return !(sid === d.id || tid === d.id);
  });

  // Tooltip
  const tooltip = document.getElementById('tooltip');
  const mainRect = document.getElementById('main').getBoundingClientRect();
  tooltip.innerHTML = `
    <div class="tt-name" style="color:${LAYERS[d.layer].color}">${d.label}</div>
    <div class="tt-layer">${LAYERS[d.layer].name}</div>
    ${d.downloads > 0 ? `<div class="tt-downloads">${formatNumber(d.downloads)} downloads/mo</div>` : ''}
  `;
  tooltip.style.display = 'block';
  tooltip.style.left = (event.clientX - mainRect.left + 15) + 'px';
  tooltip.style.top = (event.clientY - mainRect.top + 15) + 'px';
}

function onNodeOut(event, d) {
  if (simMode) return;
  nodeGroup.classed('dimmed', false).classed('highlighted', false);
  linkGroup.classed('dimmed', false);
  document.getElementById('tooltip').style.display = 'none';
}

// ══════════════════════════════════════════════════
// CLICK — detail panel or compromise
// ══════════════════════════════════════════════════
function onNodeClick(event, d) {
  event.stopPropagation();
  document.getElementById('tooltip').style.display = 'none';

  if (simMode) {
    runCompromiseSimulation(d);
    return;
  }

  showNodeDetail(d);
}

function showNodeDetail(d) {
  const panel = document.getElementById('node-detail');
  panel.classList.add('visible');

  document.getElementById('detailDot').style.background = LAYERS[d.layer].color;
  document.getElementById('detailName').textContent = d.label;
  document.getElementById('detailName').style.color = LAYERS[d.layer].color;
  document.getElementById('detailLayer').textContent = LAYERS[d.layer].name;

  // Risk
  const riskEl = document.getElementById('detailRisk');
  const riskClass = d.risk >= 85 ? 'risk-critical' : d.risk >= 65 ? 'risk-high' : 'risk-medium';
  const riskLabel = d.risk >= 85 ? 'CRITICAL' : d.risk >= 65 ? 'HIGH' : 'MEDIUM';
  riskEl.innerHTML = `<span class="risk-badge ${riskClass}">${d.risk}/100 ${riskLabel}</span>`;

  document.getElementById('detailDownloads').textContent = d.downloads > 0 ? formatNumber(d.downloads) : 'N/A (hardware)';
  document.getElementById('detailDeps').textContent = d.depRepos > 0 ? formatNumber(d.depRepos) + '+' : 'N/A';
  document.getElementById('detailMaintainers').textContent = d.maintainers;
  document.getElementById('detailBlast').textContent = d.blast;

  // CVEs
  const cveContainer = document.getElementById('detailCVEs');
  const cveSectionTitle = document.getElementById('cveSectionTitle');
  cveContainer.innerHTML = '';
  if (d.cves.length > 0) {
    cveSectionTitle.style.display = 'block';
    d.cves.forEach(cve => {
      const cvssColor = cve.cvss >= 9 ? '#ff1744' : cve.cvss >= 7 ? '#ff9100' : '#ffea00';
      cveContainer.innerHTML += `
        <div class="cve-item">
          <div class="cve-id">${cve.id}</div>
          <div class="cve-desc">${cve.desc}</div>
          <span class="cve-cvss" style="background:${hexToRGBA(cvssColor, 0.2)};color:${cvssColor};border:1px solid ${hexToRGBA(cvssColor, 0.3)}">CVSS ${cve.cvss}</span>
        </div>`;
    });
  } else {
    cveSectionTitle.style.display = 'none';
  }

  // Attacks
  const attackContainer = document.getElementById('detailAttacks');
  const attackSectionTitle = document.getElementById('attackSectionTitle');
  attackContainer.innerHTML = '';
  if (d.attacks.length > 0) {
    attackSectionTitle.style.display = 'block';
    d.attacks.forEach(a => {
      attackContainer.innerHTML += `
        <div class="attack-item">
          <span class="attack-date">${a.date}</span> — ${a.desc}
        </div>`;
    });
  } else {
    attackSectionTitle.style.display = 'none';
  }

  // Threat Actors
  const threatContainer = document.getElementById('detailThreats');
  const threatSectionTitle = document.getElementById('threatSectionTitle');
  threatContainer.innerHTML = '';
  if (d.threats && d.threats.length > 0) {
    threatSectionTitle.style.display = 'block';
    d.threats.forEach(t => {
      const actor = THREAT_ACTORS[t.actor];
      if (!actor) return;
      threatContainer.innerHTML += `
        <div class="threat-item">
          <span class="threat-actor-badge" style="background:${hexToRGBA(actor.color, 0.2)};color:${actor.color};border:1px solid ${hexToRGBA(actor.color, 0.3)}">${actor.icon} ${actor.label}</span>
          <div class="threat-vector">${t.vector}</div>
        </div>`;
    });
  } else {
    threatSectionTitle.style.display = 'none';
  }
}

// ══════════════════════════════════════════════════
// COMPROMISE SIMULATION
// ══════════════════════════════════════════════════
function toggleSimMode() {
  simMode = !simMode;
  const btn = document.getElementById('simBtn');
  const resetBtn = document.getElementById('simReset');
  const hint = document.getElementById('graphHint');

  if (simMode) {
    btn.classList.add('active');
    btn.innerHTML = '&#x26A0; SIMULATION MODE ACTIVE';
    resetBtn.style.display = 'inline-block';
    hint.textContent = 'Click a node to run cascade simulation';
    hint.style.color = '#ff1744';
  } else {
    resetSimulation();
  }
}

function resetSimulation() {
  simMode = false;
  const btn = document.getElementById('simBtn');
  const resetBtn = document.getElementById('simReset');
  const hint = document.getElementById('graphHint');

  btn.classList.remove('active');
  btn.innerHTML = '&#x26A0; Compromise Simulation';
  resetBtn.style.display = 'none';
  hint.textContent = 'scroll: zoom \u00b7 drag: navigate \u00b7 click: details';
  hint.style.color = '#334';

  // Clear all compromise visuals
  nodeGroup.classed('compromised', false).classed('dimmed', false).classed('highlighted', false);
  linkGroup.classed('compromise-link', false).classed('dimmed', false);
  document.querySelectorAll('.link-arrow').forEach(el => el.classList.remove('compromise-arrow'));

  document.getElementById('compromise-panel').classList.remove('visible');
}

function runCompromiseSimulation(startNode) {
  // Reset previous
  nodeGroup.classed('compromised', false);
  linkGroup.classed('compromise-link', false);

  // BFS through reverse dependencies (who depends on compromised node)
  const visited = new Set();
  const queue = [{ id: startNode.id, depth: 0 }];
  visited.add(startNode.id);
  let maxDepth = 0;
  const depthMap = { [startNode.id]: 0 };

  while (queue.length > 0) {
    const { id, depth } = queue.shift();
    maxDepth = Math.max(maxDepth, depth);
    const dependents = adjReverse[id] || [];
    dependents.forEach(dep => {
      if (!visited.has(dep)) {
        visited.add(dep);
        depthMap[dep] = depth + 1;
        queue.push({ id: dep, depth: depth + 1 });
      }
    });
  }

  // Animate cascade with delay per depth level
  visited.forEach(nodeId => {
    const depth = depthMap[nodeId];
    setTimeout(() => {
      nodeGroup.filter(n => n.id === nodeId).classed('compromised', true);
    }, depth * 600);
  });

  // Highlight compromise edges
  linkGroup.each(function(e) {
    const sid = e.source.id || e.source;
    const tid = e.target.id || e.target;
    if (visited.has(sid) && visited.has(tid)) {
      const edgeDepth = Math.min(depthMap[sid] || 0, depthMap[tid] || 0);
      setTimeout(() => {
        d3.select(this).classed('compromise-link', true);
      }, edgeDepth * 600);
    }
  });

  // Calculate total downloads affected
  let totalDownloads = 0;
  visited.forEach(nodeId => {
    totalDownloads += (nodeMap[nodeId]?.downloads || 0);
  });

  // Show panel after animation completes
  setTimeout(() => {
    const panel = document.getElementById('compromise-panel');
    panel.classList.add('visible');
    document.getElementById('compNodes').textContent = visited.size;
    document.getElementById('compDownloads').textContent = formatNumber(totalDownloads) + '/mo';
    document.getElementById('compDepth').textContent = maxDepth;
  }, (maxDepth + 1) * 600);
}

// ══════════════════════════════════════════════════
// TIMELINE
// ══════════════════════════════════════════════════
function buildTimeline() {
  const track = document.getElementById('timelineTrack');
  const trackWidth = track.clientWidth || (window.innerWidth - 48);

  // Date range: 2022-10 to 2026-06
  const startDate = new Date(2022, 9);  // Oct 2022
  const endDate = new Date(2026, 5);    // Jun 2026
  const totalMs = endDate - startDate;

  // Year labels
  [2023, 2024, 2025, 2026].forEach(year => {
    const yearDate = new Date(year, 0);
    const pos = ((yearDate - startDate) / totalMs) * trackWidth;
    const label = document.createElement('div');
    label.className = 'timeline-year-label';
    label.style.left = pos + 'px';
    label.textContent = year;
    track.appendChild(label);
  });

  // Sort incidents by date for zigzag ordering
  const sorted = [...INCIDENTS].sort((a, b) => {
    const da = a.date.split('-'), db = b.date.split('-');
    return new Date(+da[0], +da[1] - 1) - new Date(+db[0], +db[1] - 1);
  });

  // Track positions to detect overlap and apply offset
  const usedPositions = [];

  sorted.forEach((inc, i) => {
    const parts = inc.date.split('-');
    const incDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1);
    let pos = ((incDate - startDate) / totalMs) * trackWidth;

    // If another incident occupies the same (or very close) position, shift right
    for (const used of usedPositions) {
      if (Math.abs(pos - used) < 70) {
        pos = used + 70;
      }
    }
    usedPositions.push(pos);

    // Zigzag: alternate between bottom row and top row
    const isUp = i % 2 === 1;

    const el = document.createElement('div');
    el.className = 'timeline-incident' + (isUp ? ' stagger-up' : '');
    el.style.left = (pos - 6) + 'px';
    el.style.bottom = isUp ? '40px' : '4px';
    el.title = inc.desc;

    // Connector line from dot to axis for stagger-up items
    const connectorHTML = isUp
      ? '<div class="timeline-connector" style="top: 12px; height: 28px;"></div>'
      : '';

    el.innerHTML = `
      <div class="timeline-dot"></div>
      ${connectorHTML}
      <div class="timeline-label">${inc.label}</div>
      <div class="timeline-date">${inc.date}</div>
    `;
    el.onclick = (e) => flashIncidentNodes(inc, e);
    track.appendChild(el);
  });
}

function flashIncidentNodes(incident, e) {
  // Remove previous active
  document.querySelectorAll('.timeline-incident.active').forEach(el => el.classList.remove('active'));
  e?.currentTarget?.classList.add('active');

  // Flash affected nodes
  incident.nodes.forEach(nodeId => {
    const nodeEl = nodeGroup.filter(n => n.id === nodeId);
    nodeEl.classed('incident-flash', false);
    // Force reflow
    nodeEl.each(function() { this.offsetWidth; });
    nodeEl.classed('incident-flash', true);
    setTimeout(() => nodeEl.classed('incident-flash', false), 1500);
  });

  // Show detail for first node
  const firstNode = NODES.find(n => n.id === incident.nodes[0]);
  if (firstNode) showNodeDetail(firstNode);
}

// Click on background → deselect
document.addEventListener('click', (e) => {
  if (e.target === document.getElementById('graphSvg') || e.target.tagName === 'svg') {
    document.getElementById('node-detail').classList.remove('visible');
  }
});

// ══════════════════════════════════════════════════
// SEARCH
// ══════════════════════════════════════════════════
(function initSearch() {
  const input = document.getElementById('searchInput');
  const dropdown = document.getElementById('searchDropdown');
  const clearBtn = document.getElementById('searchClear');
  const kbdHint = document.querySelector('.search-kbd');
  let activeIdx = -1;
  let results = [];

  function getResults(query) {
    if (!query) return [];
    const q = query.toLowerCase();
    return NODES
      .filter(n => n.label.toLowerCase().includes(q) || n.id.toLowerCase().includes(q) || LAYERS[n.layer].name.toLowerCase().includes(q))
      .sort((a, b) => {
        const aStart = a.label.toLowerCase().startsWith(q) ? 0 : 1;
        const bStart = b.label.toLowerCase().startsWith(q) ? 0 : 1;
        return aStart - bStart || a.label.localeCompare(b.label);
      });
  }

  function highlightText(text, query) {
    const idx = text.toLowerCase().indexOf(query.toLowerCase());
    if (idx === -1) return text;
    return text.slice(0, idx) + '<mark>' + text.slice(idx, idx + query.length) + '</mark>' + text.slice(idx + query.length);
  }

  function renderDropdown() {
    const q = input.value.trim();
    results = getResults(q);
    activeIdx = -1;

    if (!q) { dropdown.classList.remove('visible'); return; }

    if (results.length === 0) {
      dropdown.innerHTML = '<div class="search-empty">No nodes found</div>';
      dropdown.classList.add('visible');
      return;
    }

    dropdown.innerHTML = results.map((n, i) =>
      `<div class="search-item" data-idx="${i}">
        <div class="search-item-dot" style="background:${LAYERS[n.layer].color}"></div>
        <span class="search-item-name">${highlightText(n.label, q)}</span>
        <span class="search-item-layer">${LAYERS[n.layer].name}</span>
      </div>`
    ).join('');

    dropdown.classList.add('visible');

    dropdown.querySelectorAll('.search-item').forEach(el => {
      el.addEventListener('mousedown', (e) => {
        e.preventDefault();
        selectResult(parseInt(el.dataset.idx));
      });
    });
  }

  function setActiveItem(idx) {
    const items = dropdown.querySelectorAll('.search-item');
    items.forEach(el => el.classList.remove('active'));
    if (idx >= 0 && idx < items.length) {
      items[idx].classList.add('active');
      items[idx].scrollIntoView({ block: 'nearest' });
    }
    activeIdx = idx;
  }

  function selectResult(idx) {
    const node = results[idx];
    if (!node) return;

    input.value = node.label;
    dropdown.classList.remove('visible');
    clearBtn.style.display = 'block';
    kbdHint.style.display = 'none';

    focusNode(node.id);
  }

  function focusNode(nodeId) {
    // Find the d3 data object for this node (with live x/y)
    let targetData = null;
    nodeGroup.each(function(d) { if (d.id === nodeId) targetData = d; });
    if (!targetData) return;

    // Make sure layer is visible
    if (!activeFilters.has(targetData.layer)) {
      activeFilters.add(targetData.layer);
      const chip = document.querySelector(`.layer-chip[data-layer="${targetData.layer}"]`);
      if (chip) chip.classList.add('active');
      updateVisibility();
    }

    // Pan + zoom to center the node
    const container = document.getElementById('main');
    const W = container.clientWidth;
    const H = container.clientHeight;
    const scale = 1.8;
    const tx = W / 2 - targetData.x * scale;
    const ty = H / 2 - targetData.y * scale;
    const transform = d3.zoomIdentity.translate(tx, ty).scale(scale);
    svg.transition().duration(700).ease(d3.easeCubicInOut).call(graphZoom.transform, transform);

    // Highlight with neighbor dimming
    setTimeout(() => {
      const neighbors = new Set([targetData.id]);
      (adjForward[targetData.id] || []).forEach(n => neighbors.add(n));
      (adjReverse[targetData.id] || []).forEach(n => neighbors.add(n));

      nodeGroup.classed('dimmed', n => !neighbors.has(n.id));
      nodeGroup.classed('highlighted', n => neighbors.has(n.id));
      linkGroup.classed('dimmed', e => {
        const sid = e.source.id || e.source;
        const tid = e.target.id || e.target;
        return !(sid === targetData.id || tid === targetData.id);
      });

      // Ping ring
      const ring = g.append('circle')
        .attr('class', 'search-ring')
        .attr('cx', targetData.x).attr('cy', targetData.y)
        .attr('r', targetData.r + 5);
      setTimeout(() => ring.remove(), 1300);

      showNodeDetail(targetData);
    }, 750);
  }

  function clearSearch() {
    input.value = '';
    dropdown.classList.remove('visible');
    clearBtn.style.display = 'none';
    kbdHint.style.display = '';
    activeIdx = -1;
    results = [];
    if (!simMode) {
      nodeGroup.classed('dimmed', false).classed('highlighted', false);
      linkGroup.classed('dimmed', false);
    }
  }

  // Event listeners
  input.addEventListener('input', renderDropdown);

  input.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      if (results.length) setActiveItem(Math.min(activeIdx + 1, results.length - 1));
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      if (results.length) setActiveItem(Math.max(activeIdx - 1, 0));
    } else if (e.key === 'Enter') {
      e.preventDefault();
      if (activeIdx >= 0) selectResult(activeIdx);
      else if (results.length === 1) selectResult(0);
    } else if (e.key === 'Escape') {
      if (input.value) clearSearch();
      else input.blur();
    }
  });

  input.addEventListener('focus', () => {
    kbdHint.style.display = 'none';
    if (input.value.trim()) renderDropdown();
  });

  input.addEventListener('blur', () => {
    setTimeout(() => dropdown.classList.remove('visible'), 150);
    if (!input.value.trim()) kbdHint.style.display = '';
  });

  clearBtn.addEventListener('click', () => { clearSearch(); input.focus(); });

  // Global "/" shortcut to focus search
  document.addEventListener('keydown', (e) => {
    if (e.key === '/' && document.activeElement !== input && document.activeElement.tagName !== 'INPUT') {
      e.preventDefault();
      input.focus();
      input.select();
    }
  });
})();
</script>
</body>
</html>
