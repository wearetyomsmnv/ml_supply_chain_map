<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ML Supply Chain Security Map</title>
<script src="https://d3js.org/d3.v7.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
/* ── Reset & Base ── */
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
html, body { width: 100%; height: 100%; overflow: hidden; background: #0a0e17; color: #e0e0e0; font-family: 'Inter', sans-serif; }

/* ── Layout Grid ── */
#app {
  display: grid;
  grid-template-rows: auto 1fr 100px;
  grid-template-columns: 290px 1fr;
  grid-template-areas:
    "header header"
    "sidebar main"
    "timeline timeline";
  width: 100vw; height: 100vh;
  transition: grid-template-columns 0.3s ease;
}
#app.sidebar-hidden {
  grid-template-columns: 0px 1fr;
}

/* ── Header ── */
#header {
  grid-area: header;
  display: flex; flex-direction: column;
  padding: 0;
  background: #0d1219;
  border-bottom: 1px solid rgba(255,255,255,0.07);
  z-index: 10;
}
.header-row-top {
  display: flex; align-items: center; justify-content: space-between;
  padding: 10px 24px 6px;
}
#header h1 {
  font-size: 17px; font-weight: 700;
  background: linear-gradient(90deg, #00e5ff 0%, #76ff03 100%);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  letter-spacing: 0.6px; white-space: nowrap; margin: 0;
}
.header-actions { display: flex; align-items: center; gap: 12px; }
.header-row-filters {
  display: flex; align-items: center; gap: 8px;
  padding: 4px 24px 10px;
  flex-wrap: wrap;
}
.filter-group {
  display: flex; align-items: center; gap: 6px;
}
.filter-group-label {
  font-size: 10px; color: #556; text-transform: uppercase;
  letter-spacing: 1px; font-family: 'JetBrains Mono', monospace;
  margin-right: 4px; white-space: nowrap;
}
.filter-sep {
  width: 1px; height: 22px; background: rgba(255,255,255,0.08);
  margin: 0 10px;
}
.layer-filters { display: flex; gap: 5px; flex-wrap: wrap; }
.layer-chip {
  font-size: 11px; padding: 4px 12px; border-radius: 12px;
  border: 1px solid; cursor: pointer; transition: all 0.2s;
  font-family: 'Inter', sans-serif; background: transparent; color: #ccc;
  opacity: 0.55; line-height: 1.3;
}
.layer-chip.active { opacity: 1; }
.layer-chip:hover { opacity: 1; }

/* ── Year Filters ── */
.year-filters { display: flex; gap: 5px; }
.year-chip {
  font-size: 11px; padding: 4px 12px; border-radius: 12px;
  border: 1px solid rgba(0,229,255,0.2); cursor: pointer; transition: all 0.2s;
  font-family: 'JetBrains Mono', monospace; background: transparent; color: #556;
  opacity: 0.55; line-height: 1.3;
}
.year-chip:hover { opacity: 1; color: #99b; }
.year-chip.active {
  opacity: 1; color: #00e5ff; border-color: #00e5ff;
  background: rgba(0,229,255,0.08);
  box-shadow: 0 0 8px rgba(0,229,255,0.15);
}

/* ── Simulation Button ── */
.sim-btn {
  font-family: 'JetBrains Mono', monospace; font-size: 11px; font-weight: 600;
  padding: 6px 16px; border-radius: 5px; cursor: pointer;
  border: 1px solid #ff1744; color: #ff1744; background: transparent;
  transition: all 0.25s; text-transform: uppercase; letter-spacing: 1px;
  white-space: nowrap;
}
.sim-btn:hover { background: rgba(255,23,68,0.12); }
.sim-btn.active { background: #ff1744; color: #fff; box-shadow: 0 0 20px rgba(255,23,68,0.4); }
.sim-reset {
  font-family: 'JetBrains Mono', monospace; font-size: 11px;
  padding: 5px 12px; border-radius: 5px; cursor: pointer;
  border: 1px solid #555; color: #999; background: transparent;
  transition: all 0.2s; display: none; white-space: nowrap;
}
.sim-reset:hover { border-color: #999; color: #fff; }

/* ── Sidebar ── */
#sidebar {
  grid-area: sidebar;
  background: #0d1117;
  border-right: 1px solid rgba(255,255,255,0.06);
  overflow-y: auto; overflow-x: hidden; padding: 14px;
  scrollbar-width: thin; scrollbar-color: #1a2030 #0d1117;
  transition: transform 0.3s ease, opacity 0.3s ease, padding 0.3s ease;
  min-width: 0;
}
#app.sidebar-hidden #sidebar {
  transform: translateX(-100%);
  opacity: 0; padding: 0;
  pointer-events: none;
}
#sidebar::-webkit-scrollbar { width: 6px; }
#sidebar::-webkit-scrollbar-track { background: #0d1117; }
#sidebar::-webkit-scrollbar-thumb { background: #1a2030; border-radius: 3px; }

/* ── Sidebar Toggle Button ── */
#sidebarToggle {
  position: fixed; left: 290px; top: 50%;
  transform: translateY(-50%);
  z-index: 20; width: 20px; height: 48px;
  background: #161c28; border: 1px solid rgba(255,255,255,0.08);
  border-left: none; border-radius: 0 6px 6px 0;
  color: #556; cursor: pointer; display: flex;
  align-items: center; justify-content: center;
  font-size: 12px; transition: all 0.3s ease;
  padding: 0;
}
#sidebarToggle:hover { color: #aab; background: #1a2030; }
#app.sidebar-hidden #sidebarToggle { left: 0; }

.sidebar-section-title {
  font-size: 10px; text-transform: uppercase; letter-spacing: 2px;
  color: #556; margin-bottom: 12px; font-weight: 600;
}

/* ── Contact Banner ── */
.contact-banner {
  display: flex; align-items: center; gap: 8px;
  padding: 8px 10px; margin-bottom: 14px; border-radius: 6px;
  background: rgba(0,229,255,0.04);
  border: 1px solid rgba(0,229,255,0.12);
  transition: border-color 0.2s, background 0.2s;
  text-decoration: none;
}
.contact-banner:hover {
  background: rgba(0,229,255,0.08);
  border-color: rgba(0,229,255,0.3);
}
.contact-banner .contact-icon {
  font-size: 16px; flex-shrink: 0;
}
.contact-banner .contact-text {
  font-size: 10px; color: #889; line-height: 1.4;
}
.contact-banner .contact-text strong {
  font-family: 'JetBrains Mono', monospace;
  color: #00e5ff; font-weight: 600; font-size: 11px;
}

/* ── Stat Cards ── */
.stat-cards { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 20px; }
.stat-card {
  background: #111820; border: 1px solid rgba(255,255,255,0.05);
  border-radius: 8px; padding: 12px; transition: border-color 0.2s;
}
.stat-card:hover { border-color: rgba(255,255,255,0.12); }
.stat-value {
  font-family: 'JetBrains Mono', monospace; font-size: 18px; font-weight: 600;
  margin-bottom: 4px; line-height: 1;
}
.stat-label { font-size: 10px; color: #667; line-height: 1.3; }

/* ── Node Detail Panel ── */
#node-detail { display: none; }
#node-detail.visible { display: block; }
.detail-header {
  display: flex; align-items: center; gap: 10px;
  margin-bottom: 14px; padding-bottom: 12px;
  border-bottom: 1px solid rgba(255,255,255,0.06);
}
.detail-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
.detail-name { font-size: 16px; font-weight: 600; }
.detail-layer { font-size: 11px; color: #667; }
.detail-row {
  display: flex; justify-content: space-between; align-items: center;
  padding: 6px 0; font-size: 12px;
}
.detail-row-label { color: #667; }
.detail-row-value { font-family: 'JetBrains Mono', monospace; font-weight: 500; }
.risk-badge {
  display: inline-block; padding: 2px 8px; border-radius: 3px;
  font-size: 10px; font-weight: 600; text-transform: uppercase;
  font-family: 'JetBrains Mono', monospace;
}
.risk-critical { background: rgba(255,23,68,0.2); color: #ff1744; border: 1px solid rgba(255,23,68,0.3); }
.risk-high { background: rgba(255,145,0,0.2); color: #ff9100; border: 1px solid rgba(255,145,0,0.3); }
.risk-medium { background: rgba(255,234,0,0.2); color: #ffea00; border: 1px solid rgba(255,234,0,0.3); }

.detail-section-title {
  font-size: 10px; text-transform: uppercase; letter-spacing: 1.5px;
  color: #556; margin: 14px 0 8px; font-weight: 600;
}
.blast-radius-text { font-size: 12px; color: #aaa; line-height: 1.5; margin-bottom: 8px; }
.cve-item {
  background: #111820; border: 1px solid rgba(255,255,255,0.05);
  border-radius: 6px; padding: 8px 10px; margin-bottom: 6px;
}
.cve-id {
  font-family: 'JetBrains Mono', monospace; font-size: 11px; color: #ff9100; font-weight: 500;
  display: flex; align-items: center; flex-wrap: nowrap; gap: 4px;
}
.cve-desc { font-size: 11px; color: #889; margin-top: 2px; }
.cve-cvss {
  font-family: 'JetBrains Mono', monospace; font-size: 10px;
  display: inline-block; padding: 1px 6px; border-radius: 3px; margin-top: 3px;
}

/* ── OSV Integration ── */
.cve-osv-spinner {
  display: inline-block; width: 12px; height: 12px; border: 2px solid rgba(0,229,255,0.2);
  border-top-color: #00e5ff; border-radius: 50%; animation: osvSpin 0.8s linear infinite;
  margin-left: 6px; vertical-align: middle;
}
@keyframes osvSpin { to { transform: rotate(360deg); } }

.cve-fix-badge {
  display: inline-block; font-family: 'JetBrains Mono', monospace; font-size: 9px;
  padding: 1px 7px; border-radius: 3px; margin-left: 6px; font-weight: 600;
  vertical-align: middle; letter-spacing: 0.5px;
  max-width: 140px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
}
.cve-fix-available {
  background: rgba(118,255,3,0.15); color: #76ff03; border: 1px solid rgba(118,255,3,0.3);
}
.cve-fix-none {
  background: rgba(255,23,68,0.15); color: #ff1744; border: 1px solid rgba(255,23,68,0.3);
}

.cve-osv-details { margin-top: 6px; padding-top: 6px; border-top: 1px solid rgba(255,255,255,0.04); }
.cve-osv-details:empty { display: none; }
.cve-osv-summary {
  font-size: 11px; color: #99a; line-height: 1.4; margin-bottom: 4px;
  overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
}
.cve-osv-aliases { font-size: 10px; color: #667; margin-bottom: 4px; }
.cve-osv-refs { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 4px; }
.cve-osv-ref-link {
  font-size: 10px; padding: 2px 8px; border-radius: 10px;
  background: rgba(0,229,255,0.08); color: #00e5ff; text-decoration: none;
  border: 1px solid rgba(0,229,255,0.15); transition: all 0.2s;
  font-family: 'JetBrains Mono', monospace;
}
.cve-osv-ref-link:hover { background: rgba(0,229,255,0.15); border-color: rgba(0,229,255,0.3); }
.cve-osv-error { font-size: 10px; color: #ff1744; margin-top: 4px; font-style: italic; }

.fix-summary-row {
  display: flex; align-items: center; justify-content: space-between;
  padding: 8px 10px; margin: 8px 0; border-radius: 6px;
  background: #111820; border: 1px solid rgba(255,255,255,0.05);
}
.fix-summary-label { font-size: 10px; color: #667; text-transform: uppercase; letter-spacing: 1px; }
.fix-summary-value { font-family: 'JetBrains Mono', monospace; font-size: 12px; font-weight: 600; }
.fix-summary-good { color: #76ff03; }
.fix-summary-warn { color: #ff9100; }
.fix-summary-bad { color: #ff1744; }

.osv-extra-cve-item {
  background: rgba(0,229,255,0.04); border: 1px solid rgba(0,229,255,0.1);
  border-radius: 6px; padding: 8px 10px; margin-bottom: 6px;
}
.osv-extra-cve-id {
  font-family: 'JetBrains Mono', monospace; font-size: 11px; color: #00e5ff; font-weight: 500;
}

.vuln-ring { fill: none; stroke-dasharray: 4 3; }
.vuln-ring-unfixed { animation: vulnPulse 2.5s ease-in-out infinite; }
@keyframes vulnPulse { 0%, 100% { opacity: 0.4; } 50% { opacity: 0.9; } }

.attack-item {
  font-size: 12px; color: #aab; padding: 4px 0;
  border-bottom: 1px solid rgba(255,255,255,0.03);
}
.attack-date { font-family: 'JetBrains Mono', monospace; color: #ff1744; font-size: 10px; }
.threat-item {
  background: #111820; border: 1px solid rgba(255,255,255,0.05);
  border-radius: 6px; padding: 8px 10px; margin-bottom: 6px;
}
.threat-actor-badge {
  display: inline-block; font-family: 'JetBrains Mono', monospace;
  font-size: 10px; padding: 2px 8px; border-radius: 3px;
  font-weight: 600;
}
.threat-vector { font-size: 11px; color: #889; margin-top: 4px; }
.maintainers-info {
  font-family: 'JetBrains Mono', monospace; font-size: 14px; color: #ff9100;
}

/* ── Compromise simulation panel ── */
#compromise-panel { display: none; margin-top: 16px; }
#compromise-panel.visible { display: block; }
.compromise-stats {
  background: rgba(255,23,68,0.08); border: 1px solid rgba(255,23,68,0.2);
  border-radius: 8px; padding: 12px;
}
.compromise-stat-row {
  display: flex; justify-content: space-between; font-size: 12px; padding: 4px 0;
}
.compromise-stat-label { color: #ff8a80; }
.compromise-stat-value { font-family: 'JetBrains Mono', monospace; color: #ff1744; font-weight: 600; }

/* ── Main SVG ── */
#main {
  grid-area: main; position: relative; overflow: hidden;
  background: radial-gradient(ellipse at center, #0f1520 0%, #0a0e17 70%);
}
#main svg { width: 100%; height: 100%; }

.graph-hint {
  position: absolute; bottom: 16px; right: 16px;
  font-size: 11px; color: #334; pointer-events: none;
  font-family: 'JetBrains Mono', monospace;
}

/* ── Timeline ── */
#timeline {
  grid-area: timeline;
  background: #0d1117;
  border-top: 1px solid rgba(255,255,255,0.06);
  padding: 8px 24px 4px; position: relative;
  display: flex; flex-direction: column;
  overflow: hidden;
}
.timeline-title {
  font-size: 10px; text-transform: uppercase; letter-spacing: 2px;
  color: #445; font-weight: 600; margin-bottom: 4px;
  flex-shrink: 0;
}
.timeline-scroll {
  flex: 1; min-height: 0;
  overflow-x: scroll; overflow-y: hidden;
  scrollbar-width: thin; scrollbar-color: #1a2030 #0d1117;
  position: relative;
}
.timeline-scroll::-webkit-scrollbar { height: 6px; }
.timeline-scroll::-webkit-scrollbar-track { background: #0d1117; }
.timeline-scroll::-webkit-scrollbar-thumb { background: #2a3040; border-radius: 3px; }
.timeline-scroll::-webkit-scrollbar-thumb:hover { background: #3a4050; }
.timeline-track {
  position: relative; height: 100%;
}
.timeline-axis {
  position: absolute; top: 50%; left: 0; right: 0; height: 1px;
  background: rgba(255,255,255,0.1);
}
.timeline-year-separator {
  position: absolute; top: 0; bottom: 0; width: 1px;
  background: rgba(255,255,255,0.06);
}
.timeline-year-label {
  position: absolute; top: 50%; margin-top: 8px;
  font-family: 'JetBrains Mono', monospace; font-size: 10px; color: #445;
}
.timeline-incident {
  position: absolute; top: 50%; cursor: pointer; transition: all 0.25s;
  transform: translateX(-50%);
}
.timeline-dot {
  width: 12px; height: 12px; border-radius: 50%;
  border: 2px solid #ff1744; background: #0d1117;
  transition: all 0.25s; margin: 0 auto;
  position: relative; z-index: 2;
}
.timeline-dot.severity-critical { border-color: #ff1744; }
.timeline-dot.severity-high { border-color: #ff9100; }
.timeline-dot.severity-medium { border-color: #ffea00; }
.timeline-incident:hover .timeline-dot { box-shadow: 0 0 12px rgba(255,23,68,0.5); }
.timeline-incident:hover .timeline-dot.severity-critical { background: #ff1744; }
.timeline-incident:hover .timeline-dot.severity-high { background: #ff9100; }
.timeline-incident:hover .timeline-dot.severity-medium { background: #ffea00; }
.timeline-incident.active .timeline-dot { box-shadow: 0 0 16px rgba(255,23,68,0.8); }
.timeline-incident.active .timeline-dot.severity-critical { background: #ff1744; }
.timeline-incident.active .timeline-dot.severity-high { background: #ff9100; }
.timeline-incident.active .timeline-dot.severity-medium { background: #ffea00; }
.timeline-label-above {
  position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
  font-size: 8px; color: #667; text-align: center;
  width: 85px; line-height: 1.2; padding-bottom: 4px;
  display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
  overflow: hidden;
}
.timeline-date-below {
  position: absolute; top: 100%; left: 50%; transform: translateX(-50%);
  font-family: 'JetBrains Mono', monospace; font-size: 8px;
  color: #445; text-align: center; white-space: nowrap;
  padding-top: 3px;
}
/* Tooltip rendered in a fixed overlay, not inside scroll container */
#timeline-tooltip-overlay {
  display: none; position: fixed;
  background: #161c28; border: 1px solid rgba(255,255,255,0.12);
  border-radius: 6px; padding: 10px 12px; font-size: 11px; z-index: 200;
  box-shadow: 0 4px 20px rgba(0,0,0,0.6); min-width: 200px; max-width: 300px;
  pointer-events: none; white-space: normal;
}
#timeline-tooltip-overlay.visible { display: block; }
.timeline-tooltip-title { font-weight: 600; color: #e0e0e0; margin-bottom: 4px; font-size: 11px; }
.timeline-tooltip-desc { color: #889; font-size: 10px; line-height: 1.4; margin-bottom: 6px; }
.timeline-tooltip-nodes { display: flex; flex-wrap: wrap; gap: 3px; }
.timeline-tooltip-node {
  font-family: 'JetBrains Mono', monospace; font-size: 9px;
  padding: 1px 6px; border-radius: 3px;
  background: rgba(0,229,255,0.08); color: #00e5ff;
  border: 1px solid rgba(0,229,255,0.15);
}

/* ── SVG Styles ── */
.node-group { cursor: pointer; }
.node-circle { stroke-width: 2.5; transition: opacity 0.3s; }
.node-hex { stroke-width: 2.5; transition: opacity 0.3s; }
.node-label {
  font-family: 'JetBrains Mono', monospace; font-size: 10px;
  fill: #ccc; text-anchor: middle; pointer-events: none;
  transition: opacity 0.3s;
}
.link-line {
  fill: none; stroke-opacity: 0.25; transition: stroke-opacity 0.3s, stroke 0.3s;
}
.link-arrow { fill-opacity: 0.4; transition: fill-opacity 0.3s, fill 0.3s; }
.cluster-hull { stroke-width: 1; transition: opacity 0.3s; }

/* ── Year dim state ── */
.year-old .node-circle, .year-old .node-hex { opacity: 0.35; }
.year-old .node-label { opacity: 0.3; }
.year-new .node-circle, .year-new .node-hex { opacity: 1; stroke-width: 3.5; }
.year-new .node-label { opacity: 1; }
.link-line.year-edge-dim { stroke-opacity: 0.06; }

/* ── Dim state for hover ── */
.dimmed .node-circle, .dimmed .node-hex { opacity: 0.12 !important; }
.dimmed .node-label { opacity: 0.08 !important; }
.link-line.dimmed { stroke-opacity: 0.04 !important; }
.highlighted .node-circle, .highlighted .node-hex { opacity: 1 !important; }
.highlighted .node-label { opacity: 1 !important; }

/* ── Compromise animation ── */
@keyframes compromisePulse {
  0% { filter: drop-shadow(0 0 4px rgba(255,23,68,0.3)); }
  50% { filter: drop-shadow(0 0 20px rgba(255,23,68,0.8)); }
  100% { filter: drop-shadow(0 0 4px rgba(255,23,68,0.3)); }
}
.compromised { animation: compromisePulse 1.2s ease-in-out infinite; }
.compromised .node-circle, .compromised .node-hex {
  stroke: #ff1744 !important; stroke-width: 3.5;
}
.compromise-link { stroke: #ff1744 !important; stroke-opacity: 0.7 !important; stroke-dasharray: 6 3; }
.compromise-arrow { fill: #ff1744 !important; fill-opacity: 0.8 !important; }

/* ── Incident flash ── */
@keyframes incidentFlash {
  0% { filter: drop-shadow(0 0 0 rgba(255,145,0,0)); }
  25% { filter: drop-shadow(0 0 25px rgba(255,145,0,0.9)); }
  50% { filter: drop-shadow(0 0 5px rgba(255,145,0,0.3)); }
  75% { filter: drop-shadow(0 0 25px rgba(255,145,0,0.9)); }
  100% { filter: drop-shadow(0 0 0 rgba(255,145,0,0)); }
}
.incident-flash { animation: incidentFlash 1.5s ease-in-out; }

/* ── Attack-ranking focus ring ── */
@keyframes focusDashSpin {
  0% { stroke-dashoffset: 0; }
  100% { stroke-dashoffset: -40; }
}
.focus-ring {
  fill: none; stroke-width: 2.5;
  stroke-dasharray: 6 4;
  animation: focusDashSpin 1.5s linear infinite;
  pointer-events: none;
}

/* ── Tooltip ── */
.graph-tooltip {
  position: absolute; pointer-events: none; background: #161c28;
  border: 1px solid rgba(255,255,255,0.1); border-radius: 6px;
  padding: 8px 12px; font-size: 12px; display: none;
  box-shadow: 0 4px 20px rgba(0,0,0,0.5); z-index: 100;
  max-width: 220px;
}
.graph-tooltip .tt-name { font-weight: 600; margin-bottom: 2px; }
.graph-tooltip .tt-layer { font-size: 10px; color: #667; }
.graph-tooltip .tt-downloads {
  font-family: 'JetBrains Mono', monospace; font-size: 11px; margin-top: 4px; color: #aaa;
}

/* ── Legend ── */
.legend-box {
  background: #111820; border: 1px solid rgba(255,255,255,0.05);
  border-radius: 8px; padding: 10px 12px; margin-bottom: 14px;
}
.legend-row {
  display: flex; align-items: center; gap: 8px;
  padding: 3px 0; font-size: 11px; color: #99a;
}
.legend-dot {
  width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0;
  border: 1.5px solid;
}
.legend-hex {
  width: 10px; height: 9px; flex-shrink: 0;
  clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
}
.legend-line {
  width: 18px; height: 0; flex-shrink: 0;
  border-top: 1.5px solid #556;
}
.legend-line-arrow {
  width: 18px; height: 0; flex-shrink: 0;
  border-top: 1.5px dashed #ff1744;
}
.legend-size-dots {
  display: flex; align-items: center; gap: 3px; flex-shrink: 0;
}
.legend-size-dot {
  border-radius: 50%; border: 1px solid #556; background: rgba(255,255,255,0.04);
}
.legend-divider {
  height: 1px; background: rgba(255,255,255,0.04); margin: 6px 0;
}

/* ── Research credit ── */
.research-credit {
  background: linear-gradient(135deg, rgba(0,229,255,0.04) 0%, rgba(118,255,3,0.04) 100%);
  border: 1px solid rgba(0,229,255,0.1);
  border-radius: 8px; padding: 10px 12px; margin-bottom: 14px;
}
.research-credit-title {
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px; font-weight: 600; text-transform: uppercase;
  letter-spacing: 1.5px; color: #00e5ff; margin-bottom: 6px;
}
.research-credit-text {
  font-size: 11px; color: #889; line-height: 1.5;
}
.research-credit-text a {
  color: #00e5ff; text-decoration: none; font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
}
.research-credit-text a:hover { text-decoration: underline; }
.research-tag {
  display: inline-block; font-family: 'JetBrains Mono', monospace;
  font-size: 9px; padding: 2px 6px; border-radius: 3px;
  background: rgba(0,229,255,0.08); color: #00e5ff;
  border: 1px solid rgba(0,229,255,0.15); margin: 3px 2px 0 0;
}

/* ── Search ── */
.search-wrap {
  position: relative; display: flex; align-items: center;
}
.search-input {
  font-family: 'JetBrains Mono', monospace; font-size: 12px;
  background: rgba(255,255,255,0.04); color: #e0e0e0;
  border: 1px solid rgba(255,255,255,0.1); border-radius: 5px;
  padding: 6px 12px 6px 30px; width: 190px; outline: none;
  transition: border-color 0.2s, background 0.2s;
}
.search-input::placeholder { color: #445; }
.search-input:focus {
  border-color: rgba(0,229,255,0.4); background: rgba(255,255,255,0.06);
}
.search-icon {
  position: absolute; left: 9px; top: 50%; transform: translateY(-50%);
  color: #445; font-size: 13px; pointer-events: none; line-height: 1;
}
.search-clear {
  position: absolute; right: 6px; top: 50%; transform: translateY(-50%);
  background: none; border: none; color: #556; font-size: 14px;
  cursor: pointer; padding: 0 3px; line-height: 1; display: none;
}
.search-clear:hover { color: #aaa; }
.search-dropdown {
  position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px;
  background: #161c28; border: 1px solid rgba(255,255,255,0.1);
  border-radius: 6px; overflow: hidden; display: none;
  box-shadow: 0 8px 30px rgba(0,0,0,0.6); z-index: 200;
  max-height: 320px; overflow-y: auto;
  scrollbar-width: thin; scrollbar-color: #1a2030 #161c28;
}
.search-dropdown.visible { display: block; }
.search-item {
  display: flex; align-items: center; gap: 8px;
  padding: 8px 12px; cursor: pointer; transition: background 0.15s;
  border-bottom: 1px solid rgba(255,255,255,0.03);
}
.search-item:last-child { border-bottom: none; }
.search-item:hover, .search-item.active {
  background: rgba(0,229,255,0.08);
}
.search-item-dot {
  width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0;
}
.search-item-name {
  font-family: 'JetBrains Mono', monospace; font-size: 12px;
  color: #ddd; flex: 1;
}
.search-item-name mark {
  background: none; color: #00e5ff; font-weight: 600;
}
.search-item-layer {
  font-size: 9px; color: #556; text-transform: uppercase;
  letter-spacing: 0.5px; flex-shrink: 0;
}
.search-empty {
  padding: 12px; text-align: center; font-size: 11px; color: #445;
  font-family: 'JetBrains Mono', monospace;
}
.search-kbd {
  font-family: 'JetBrains Mono', monospace; font-size: 9px;
  color: #334; background: rgba(255,255,255,0.04);
  border: 1px solid rgba(255,255,255,0.06); border-radius: 3px;
  padding: 1px 5px; margin-left: 6px;
}

/* ── Attack Ranking ── */
.attack-ranking { margin-bottom: 14px; }
.attack-ranking-tabs {
  display: flex; gap: 4px; margin-bottom: 8px;
}
.attack-ranking-tab {
  font-family: 'JetBrains Mono', monospace; font-size: 10px;
  padding: 2px 8px; border-radius: 3px; cursor: pointer;
  border: 1px solid rgba(255,23,68,0.2); background: transparent; color: #667;
  transition: all 0.2s;
}
.attack-ranking-tab.active {
  border-color: #ff1744; color: #ff1744; background: rgba(255,23,68,0.1);
}
.attack-ranking-item {
  display: flex; align-items: center; gap: 8px;
  padding: 5px 8px; font-size: 11px; cursor: pointer;
  border-bottom: 1px solid rgba(255,255,255,0.03);
  transition: background 0.15s; border-radius: 4px;
}
.attack-ranking-item:hover { background: rgba(255,23,68,0.08); }
.attack-ranking-rank {
  font-family: 'JetBrains Mono', monospace; font-size: 10px;
  color: #ff1744; font-weight: 600; width: 16px; text-align: center;
}
.attack-ranking-name { color: #ccc; flex: 1; }
.attack-ranking-count {
  font-family: 'JetBrains Mono', monospace; font-size: 10px;
  color: #ff9100; background: rgba(255,145,0,0.1);
  padding: 1px 6px; border-radius: 3px; border: 1px solid rgba(255,145,0,0.2);
}

/* ── Research Library ── */
.research-library { margin-bottom: 14px; }
.research-collapse-btn {
  font-family: 'JetBrains Mono', monospace; font-size: 10px;
  padding: 4px 10px; border-radius: 4px; cursor: pointer;
  border: 1px solid rgba(0,229,255,0.2); background: transparent; color: #556;
  transition: all 0.2s; display: flex; align-items: center; gap: 6px;
  width: 100%; text-align: left; margin-bottom: 8px;
}
.research-collapse-btn:hover { color: #99b; border-color: rgba(0,229,255,0.4); }
.research-collapse-btn .arrow { transition: transform 0.2s; }
.research-collapse-btn.open .arrow { transform: rotate(90deg); }

.attack-pattern-card {
  padding: 8px 10px; margin-bottom: 6px; border-radius: 6px;
  border: 1px solid rgba(255,255,255,0.06); cursor: pointer;
  background: rgba(255,255,255,0.02); transition: all 0.2s;
}
.attack-pattern-card:hover { background: rgba(255,255,255,0.05); }
.attack-pattern-card .pattern-title {
  font-size: 11px; font-weight: 600; margin-bottom: 3px;
  display: flex; align-items: center; gap: 6px;
}
.attack-pattern-card .pattern-dot {
  width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0;
}
.attack-pattern-card .pattern-desc {
  font-size: 10px; color: #667; line-height: 1.4;
}
.attack-pattern-card .pattern-nodes {
  display: flex; flex-wrap: wrap; gap: 3px; margin-top: 4px;
}
.attack-pattern-card .pattern-node-tag {
  font-family: 'JetBrains Mono', monospace; font-size: 9px;
  padding: 1px 5px; border-radius: 3px;
  background: rgba(255,255,255,0.05); color: #889;
  border: 1px solid rgba(255,255,255,0.08);
}

.ref-category { margin-bottom: 8px; }
.ref-category-title {
  font-family: 'JetBrains Mono', monospace; font-size: 9px;
  color: #00e5ff; text-transform: uppercase; letter-spacing: 1px;
  margin-bottom: 4px;
}
.ref-item {
  font-size: 10px; color: #889; padding: 2px 0; line-height: 1.4;
}
.ref-item a { color: #00e5ff; text-decoration: none; }
.ref-item a:hover { text-decoration: underline; }
.ref-item .ref-venue {
  font-family: 'JetBrains Mono', monospace; font-size: 9px;
  color: #556; margin-left: 4px;
}

/* ── Search highlight ring ── */
@keyframes searchPing {
  0% { stroke-opacity: 0.9; stroke-width: 4; }
  100% { stroke-opacity: 0; stroke-width: 20; }
}
.search-ring {
  fill: none; stroke: #00e5ff; stroke-width: 4;
  animation: searchPing 1.2s ease-out forwards;
  pointer-events: none;
}

/* ── Attack Path Calculator ── */
#attack-paths-panel { display: none; margin-top: 16px; }
#attack-paths-panel.visible { display: block; }
.atk-btn { border-color: #ff6d00; color: #ff6d00; }
.atk-btn:hover { background: rgba(255,109,0,0.12); }
.atk-btn.active { background: #ff6d00; color: #fff; box-shadow: 0 0 20px rgba(255,109,0,0.4); }

.attack-path-card {
    background: rgba(255,23,68,0.04);
    border: 1px solid rgba(255,23,68,0.15);
    border-radius: 8px; padding: 10px 12px; margin-bottom: 10px;
    cursor: pointer; transition: all 0.2s;
}
.attack-path-card:hover {
    background: rgba(255,23,68,0.08);
    border-color: rgba(255,23,68,0.3);
}
.attack-path-card.active {
    border-color: #ff1744;
    box-shadow: 0 0 12px rgba(255,23,68,0.2);
}
.path-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 6px;
}
.path-title { font-size: 12px; font-weight: 600; color: #ff8a80; }
.path-score {
    font-family: 'JetBrains Mono', monospace; font-size: 10px;
    color: #ff1744; background: rgba(255,23,68,0.15);
    padding: 2px 6px; border-radius: 3px;
}
.path-step {
    display: flex; gap: 8px; padding: 4px 0;
    border-left: 2px solid rgba(255,23,68,0.2);
    margin-left: 8px; padding-left: 12px;
}
.path-step-number {
    font-family: 'JetBrains Mono', monospace; font-size: 10px;
    color: #ff1744; font-weight: 700; width: 14px; flex-shrink: 0;
}
.path-step-content { flex: 1; }
.path-step-node { font-size: 11px; font-weight: 600; color: #ddd; }
.path-step-atlas {
    font-family: 'JetBrains Mono', monospace; font-size: 9px;
    color: #ff9100; margin-top: 1px;
}
.path-step-atlas a { color: #ff9100; text-decoration: none; }
.path-step-atlas a:hover { text-decoration: underline; }
.path-step-incident {
    font-size: 9px; color: #889; margin-top: 2px;
    display: flex; align-items: center; gap: 4px;
}
.atk-paths-title {
    font-size: 10px; text-transform: uppercase; letter-spacing: 2px;
    color: #ff6d00; font-weight: 600; margin-bottom: 8px;
}
.atk-paths-subtitle { font-size: 11px; color: #667; margin-bottom: 12px; }
.atk-paths-empty { font-size: 11px; color: #445; font-style: italic; }
@keyframes atkDash { to { stroke-dashoffset: -20; } }
.atk-path-edge {
    stroke: #ff1744; stroke-width: 2.5; stroke-dasharray: 6,4;
    animation: atkDash 0.6s linear infinite; fill: none; pointer-events: none;
}
.atk-hop-label {
    font-family: 'JetBrains Mono', monospace; font-size: 11px;
    fill: #ff1744; font-weight: 700; pointer-events: none;
    text-anchor: middle; dominant-baseline: central;
}

/* ── Temporal Heatmap ── */
.view-toggle-btn {
    font-family: 'JetBrains Mono', monospace; font-size: 11px;
    padding: 4px 12px; border-radius: 12px; cursor: pointer;
    border: 1px solid rgba(0,229,255,0.2); background: transparent;
    color: #556; transition: all 0.2s; line-height: 1.3;
}
.view-toggle-btn:hover { opacity: 1; color: #99b; }
.view-toggle-btn.active {
    opacity: 1; color: #00e5ff; border-color: #00e5ff;
    background: rgba(0,229,255,0.08);
    box-shadow: 0 0 8px rgba(0,229,255,0.15);
}
.hm-bg-cell { fill: rgba(255,255,255,0.02); }
.hm-bg-cell:hover { fill: rgba(255,255,255,0.06); }
.heatmap-cell { cursor: pointer; transition: all 0.15s; filter: saturate(1.1); }
.heatmap-cell:hover { stroke: #fff; stroke-width: 2; filter: brightness(1.3) saturate(1.3); }
.hm-cell-text {
    font-family: 'JetBrains Mono', monospace; font-size: 9px; font-weight: 600;
    fill: #fff; text-anchor: middle; dominant-baseline: central;
    pointer-events: none; opacity: 0.9;
}
.heatmap-label {
    font-family: 'JetBrains Mono', monospace; font-size: 11px;
    fill: #99a; cursor: pointer; transition: fill 0.15s;
}
.heatmap-label:hover { fill: #fff; }
.heatmap-quarter-label {
    font-family: 'JetBrains Mono', monospace; font-size: 10px;
    fill: #667; text-anchor: middle; font-weight: 500;
}
.hm-year-label {
    font-family: 'JetBrains Mono', monospace; font-size: 11px;
    fill: #889; text-anchor: middle; font-weight: 600; letter-spacing: 1px;
}
.heatmap-layer-label {
    font-size: 9px; text-transform: uppercase;
    letter-spacing: 2px; font-weight: 700;
}
.hm-layer-bg { opacity: 0.04; }
.hm-row-hover { fill: rgba(255,255,255,0.03); opacity: 0; transition: opacity 0.15s; }
.hm-row-hover:hover { opacity: 1; }
.hm-risk-bar { opacity: 0.5; }
.heatmap-tooltip {
    position: fixed; z-index: 200; pointer-events: none;
    background: #161c28; border: 1px solid rgba(255,255,255,0.15);
    border-radius: 8px; padding: 10px 12px; font-size: 11px;
    color: #ccc; max-width: 280px; box-shadow: 0 8px 30px rgba(0,0,0,0.7);
    display: none; line-height: 1.5;
}
.heatmap-tooltip.visible { display: block; }
.hm-legend-label {
    font-family: 'JetBrains Mono', monospace; font-size: 8px;
    fill: #556; text-anchor: middle;
}

/* ── LLM Chat Panel ── */
#llm-chat {
    position: fixed; bottom: 170px; right: 20px;
    width: 380px; max-height: 450px;
    background: #0d1219; border: 1px solid rgba(255,255,255,0.1);
    border-radius: 10px; z-index: 150;
    display: flex; flex-direction: column;
    box-shadow: 0 8px 40px rgba(0,0,0,0.6);
    font-family: 'Inter', sans-serif;
    transition: max-height 0.3s;
}
#llm-chat.collapsed { max-height: 36px; overflow: hidden; }
.chat-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 8px 12px; cursor: pointer;
    border-bottom: 1px solid rgba(255,255,255,0.06);
    font-size: 12px; font-weight: 600; color: #aab;
}
.chat-header:hover { color: #fff; }
.chat-minimize { background: none; border: none; color: #667; cursor: pointer; font-size: 14px; padding: 0 4px; }
.chat-minimize:hover { color: #fff; }
.chat-messages {
    flex: 1; overflow-y: auto; padding: 10px;
    min-height: 200px; max-height: 320px;
    scrollbar-width: thin; scrollbar-color: #1a2030 #0d1219;
}
.chat-msg { margin-bottom: 10px; font-size: 12px; line-height: 1.5; }
.chat-msg.user { text-align: right; color: #00e5ff; }
.chat-msg.user .msg-bubble {
    display: inline-block; background: rgba(0,229,255,0.08);
    border: 1px solid rgba(0,229,255,0.2);
    border-radius: 10px 10px 0 10px; padding: 6px 10px;
    text-align: left; max-width: 85%;
}
.chat-msg.ai .msg-bubble {
    display: inline-block; background: rgba(255,255,255,0.04);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 10px 10px 10px 0; padding: 6px 10px;
    max-width: 90%;
}
.chat-msg.ai { color: #ccc; }
.chat-msg.error .msg-bubble {
    border-color: rgba(255,23,68,0.3); color: #ff8a80;
}
.chat-node-link {
    font-family: 'JetBrains Mono', monospace; font-size: 11px;
    color: #00e5ff; cursor: pointer; text-decoration: underline;
    text-decoration-style: dotted;
}
.chat-node-link:hover { text-decoration-style: solid; }
.chat-atlas-tag {
    font-family: 'JetBrains Mono', monospace; font-size: 10px;
    color: #ff9100; background: rgba(255,145,0,0.1);
    padding: 1px 4px; border-radius: 2px; text-decoration: none;
}
.chat-input-row {
    display: flex; gap: 8px; padding: 8px 10px;
    border-top: 1px solid rgba(255,255,255,0.06);
}
.chat-input {
    flex: 1; font-family: 'Inter', sans-serif; font-size: 12px;
    background: rgba(255,255,255,0.04); color: #e0e0e0;
    border: 1px solid rgba(255,255,255,0.1); border-radius: 6px;
    padding: 6px 10px; outline: none;
}
.chat-input::placeholder { color: #445; }
.chat-input:focus { border-color: rgba(0,229,255,0.3); }
.chat-send-btn {
    font-family: 'JetBrains Mono', monospace; font-size: 11px;
    padding: 6px 12px; border-radius: 6px; cursor: pointer;
    border: 1px solid rgba(0,229,255,0.3); color: #00e5ff;
    background: transparent; transition: all 0.2s;
}
.chat-send-btn:hover { background: rgba(0,229,255,0.1); }
.chat-send-btn:disabled { opacity: 0.3; cursor: not-allowed; }
@keyframes chatTyping {
    0%, 80%, 100% { opacity: 0.3; }
    40% { opacity: 1; }
}
.chat-typing span {
    display: inline-block; width: 6px; height: 6px; border-radius: 50%;
    background: #556; margin: 0 2px;
    animation: chatTyping 1.4s infinite;
}
.chat-typing span:nth-child(2) { animation-delay: 0.2s; }
.chat-typing span:nth-child(3) { animation-delay: 0.4s; }

/* ── Settings Modal ── */
.settings-modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.6);
    z-index: 300; display: none; align-items: center; justify-content: center;
}
.settings-modal-overlay.visible { display: flex; }
.settings-modal {
    background: #161c28; border: 1px solid rgba(255,255,255,0.1);
    border-radius: 10px; padding: 20px; width: 400px;
    box-shadow: 0 8px 40px rgba(0,0,0,0.8);
}
.settings-title { font-size: 14px; font-weight: 600; margin-bottom: 14px; color: #e0e0e0; }
.settings-label { font-size: 11px; color: #889; margin-bottom: 4px; display: block; }
.settings-input {
    width: 100%; font-family: 'JetBrains Mono', monospace; font-size: 12px;
    background: rgba(255,255,255,0.04); color: #e0e0e0;
    border: 1px solid rgba(255,255,255,0.1); border-radius: 6px;
    padding: 8px 10px; outline: none; margin-bottom: 12px;
}
.settings-hint { font-size: 10px; color: #556; line-height: 1.4; margin-bottom: 14px; }
.settings-hint a { color: #00e5ff; text-decoration: none; }
.settings-btn {
    font-family: 'JetBrains Mono', monospace; font-size: 11px;
    padding: 6px 16px; border-radius: 5px; cursor: pointer;
    border: 1px solid; transition: all 0.2s; margin-right: 8px;
}
.settings-btn-save { border-color: #76ff03; color: #76ff03; background: transparent; }
.settings-btn-save:hover { background: rgba(118,255,3,0.12); }
.settings-btn-cancel { border-color: #555; color: #999; background: transparent; }
.settings-btn-cancel:hover { border-color: #999; color: #fff; }
</style>
</head>
<body>
<div id="app">
  <!-- HEADER -->
  <header id="header">
    <div class="header-row-top">
      <h1>ML SUPPLY CHAIN SECURITY MAP</h1>
      <div class="header-actions">
        <div class="search-wrap" id="searchWrap">
          <span class="search-icon">&#x2315;</span>
          <input class="search-input" id="searchInput" type="text" placeholder="Search nodes..." autocomplete="off" spellcheck="false">
          <button class="search-clear" id="searchClear">&times;</button>
          <span class="search-kbd">/</span>
          <div class="search-dropdown" id="searchDropdown"></div>
        </div>
        <button class="sim-btn" id="simBtn" onclick="toggleSimMode()">&#x26A0; Simulate</button>
        <button class="sim-reset" id="simReset" onclick="resetSimulation()">Reset</button>
        <button class="sim-btn atk-btn" id="atkBtn" onclick="toggleAttackPathMode()">&#x2694; Attack Paths</button>
        <button class="sim-btn" id="settingsBtn" onclick="openSettings()" style="border-color:#556;color:#889">&#x2699;</button>
      </div>
    </div>
    <div class="header-row-filters">
      <div class="filter-group">
        <span class="filter-group-label">Layers</span>
        <div class="layer-filters" id="layerFilters"></div>
      </div>
      <div class="filter-sep"></div>
      <div class="filter-group">
        <span class="filter-group-label">Year</span>
        <div class="year-filters" id="yearFilters"></div>
      </div>
      <div class="filter-sep"></div>
      <div class="filter-group">
        <span class="filter-group-label">View</span>
        <button class="view-toggle-btn active" id="viewGraph" onclick="switchView('graph')">Graph</button>
        <button class="view-toggle-btn" id="viewHeatmap" onclick="switchView('heatmap')">Heatmap</button>
      </div>
    </div>
  </header>

  <!-- SIDEBAR -->
  <button id="sidebarToggle" onclick="toggleSidebar()" title="Toggle sidebar">&#x25C0;</button>
  <aside id="sidebar">
    <div style="margin-bottom:12px;font-size:11px;color:#667;"><a href="https://t.me/pwnai" target="_blank" rel="noopener" style="color:#00e5ff;text-decoration:none;font-family:'JetBrains Mono',monospace;font-size:11px;">@pwnai</a> <span style="color:#445;font-size:10px;">on Telegram</span></div>
    <a class="contact-banner" href="https://t.me/wearetyomsmnv" target="_blank" rel="noopener">
      <span class="contact-icon">&#9993;</span>
      <div class="contact-text">Ideas or suggestions? Reach out to <strong>@wearetyomsmnv</strong> on Telegram</div>
    </a>
    <div class="sidebar-section-title">Key Ecosystem Metrics</div>
    <div class="stat-cards">
      <div class="stat-card">
        <div class="stat-value" style="color:#00e5ff">1.7B</div>
        <div class="stat-label">Monthly Downloads (Pickle+SafeT Repos)</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" style="color:#76ff03">3M+</div>
        <div class="stat-label">Models on HuggingFace Hub</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" style="color:#ff1744">877K</div>
        <div class="stat-label">Malicious OSS Packages (Total, Sonatype)</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" style="color:#ff9100">400M+</div>
        <div class="stat-label">Pickle-Only Model Downloads/mo</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" style="color:#ffea00">~92%</div>
        <div class="stat-label">NVIDIA GPU Market (AI Infra)</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" style="color:#d500f9">50K+</div>
        <div class="stat-label">Companies Using HuggingFace</div>
      </div>
    </div>

    <!-- Most Attacked Components -->
    <div class="sidebar-section-title">Most Attacked Components</div>
    <div class="attack-ranking">
      <div class="attack-ranking-tabs" id="attackRankingTabs"></div>
      <div id="attackRankingList"></div>
    </div>

    <!-- Legend -->
    <div class="sidebar-section-title">Map Legend</div>
    <div class="legend-box">
      <div class="legend-row">
        <div class="legend-dot" style="border-color:#ff1744; background:rgba(255,23,68,0.15);"></div>
        <span>Hardware</span>
      </div>
      <div class="legend-row">
        <div class="legend-dot" style="border-color:#ff9100; background:rgba(255,145,0,0.15);"></div>
        <span>Base Libraries</span>
      </div>
      <div class="legend-row">
        <div class="legend-dot" style="border-color:#ffea00; background:rgba(255,234,0,0.15);"></div>
        <span>ML Frameworks</span>
      </div>
      <div class="legend-row">
        <div class="legend-dot" style="border-color:#00e5ff; background:rgba(0,229,255,0.15);"></div>
        <span>HuggingFace Ecosystem</span>
      </div>
      <div class="legend-row">
        <div class="legend-dot" style="border-color:#18ffff; background:rgba(24,255,255,0.15);"></div>
        <span>Vector Databases</span>
      </div>
      <div class="legend-row">
        <div class="legend-dot" style="border-color:#76ff03; background:rgba(118,255,3,0.15);"></div>
        <span>Serving &amp; Inference</span>
      </div>
      <div class="legend-row">
        <div class="legend-dot" style="border-color:#ff6d00; background:rgba(255,109,0,0.15);"></div>
        <span>AI Agents</span>
      </div>
      <div class="legend-row">
        <div class="legend-dot" style="border-color:#d500f9; background:rgba(213,0,249,0.15);"></div>
        <span>Applications</span>
      </div>
      <div class="legend-divider"></div>
      <div class="legend-row">
        <div class="legend-hex" style="background:#ff1744;"></div>
        <span>Hexagon = hardware component</span>
      </div>
      <div class="legend-row">
        <div class="legend-size-dots">
          <div class="legend-size-dot" style="width:6px;height:6px;"></div>
          <div class="legend-size-dot" style="width:10px;height:10px;"></div>
          <div class="legend-size-dot" style="width:14px;height:14px;"></div>
        </div>
        <span>Circle size = downloads/mo</span>
      </div>
      <div class="legend-row">
        <div class="legend-line"></div>
        <span>Edge = dependency (A &rarr; B)</span>
      </div>
      <div class="legend-row">
        <div class="legend-line-arrow"></div>
        <span>Compromise cascade path</span>
      </div>
    </div>

    <!-- Research credit -->
    <div class="research-credit">
      <div class="research-credit-title">Supply Chain Research</div>
      <div class="research-credit-text">
        Interactive dependency &amp; attack surface map of the ML/AI ecosystem. 95+ packages, 260+ edges, 29 real-world incidents. Data as of Q1 2026.<br>
        Built by <a href="https://t.me/pwnai" target="_blank" rel="noopener">@pwnai</a>
      </div>
      <div style="margin-top:6px;">
        <span class="research-tag">supply chain</span>
        <span class="research-tag">ML security</span>
        <span class="research-tag">dependency risk</span>
        <span class="research-tag">BFS simulation</span>
      </div>
    </div>

    <!-- Section: Research Library -->
    <div class="sidebar-section-title">Research Library</div>
    <div class="research-library">
      <button class="research-collapse-btn open" id="patternsToggle" onclick="toggleResearchSection('patterns')">
        <span class="arrow">&#9654;</span> Attack Patterns (7)
      </button>
      <div id="patternsContent"></div>
      <button class="research-collapse-btn" id="refsToggle" onclick="toggleResearchSection('refs')">
        <span class="arrow">&#9654;</span> Academic References (22)
      </button>
      <div id="refsContent" style="display:none;"></div>
    </div>

    <!-- Node detail panel -->
    <div id="node-detail">
      <div class="sidebar-section-title">Node Details</div>
      <div class="detail-header">
        <div class="detail-dot" id="detailDot"></div>
        <div>
          <div class="detail-name" id="detailName"></div>
          <div class="detail-layer" id="detailLayer"></div>
        </div>
      </div>
      <div class="detail-row">
        <span class="detail-row-label">Risk Level</span>
        <span class="detail-row-value" id="detailRisk"></span>
      </div>
      <div class="detail-row">
        <span class="detail-row-label">Downloads/mo</span>
        <span class="detail-row-value" id="detailDownloads"></span>
      </div>
      <div class="detail-row">
        <span class="detail-row-label">Dependent Repos</span>
        <span class="detail-row-value" id="detailDeps"></span>
      </div>
      <div class="detail-row">
        <span class="detail-row-label">Maintainers</span>
        <span class="maintainers-info" id="detailMaintainers"></span>
      </div>
      <div class="detail-section-title">Blast Radius</div>
      <div class="blast-radius-text" id="detailBlast"></div>
      <div class="detail-section-title" id="cveSectionTitle" style="display:none">CVE / Vulnerabilities</div>
      <div id="detailCVEs"></div>
      <div class="fix-summary-row" id="fixSummaryRow" style="display:none">
        <span class="fix-summary-label">Fix Coverage</span>
        <span class="fix-summary-value" id="fixSummaryValue"></span>
      </div>
      <div class="detail-section-title" id="osvExtraSectionTitle" style="display:none">
        Additional OSV Vulnerabilities
      </div>
      <div id="osvExtraCVEs"></div>
      <div class="detail-section-title" id="attackSectionTitle" style="display:none">Attacks / Incidents</div>
      <div id="detailAttacks"></div>
      <div class="detail-section-title" id="threatSectionTitle" style="display:none">Threat Actors</div>
      <div id="detailThreats"></div>
    </div>

    <!-- Compromise simulation results -->
    <div id="compromise-panel">
      <div class="sidebar-section-title" style="color:#ff1744">Simulation Results</div>
      <div class="compromise-stats">
        <div class="compromise-stat-row">
          <span class="compromise-stat-label">Affected Nodes</span>
          <span class="compromise-stat-value" id="compNodes">0</span>
        </div>
        <div class="compromise-stat-row">
          <span class="compromise-stat-label">Total Downloads/mo</span>
          <span class="compromise-stat-value" id="compDownloads">0</span>
        </div>
        <div class="compromise-stat-row">
          <span class="compromise-stat-label">Cascade Depth</span>
          <span class="compromise-stat-value" id="compDepth">0</span>
        </div>
      </div>
    </div>

    <!-- Attack Paths panel -->
    <div id="attack-paths-panel">
      <div class="atk-paths-title">Attack Paths To: <span id="atkTargetName">—</span></div>
      <div class="atk-paths-subtitle" id="atkPathsCount"></div>
      <div id="attackPathsList"></div>
      <div class="atk-paths-empty" id="atkPathsEmpty" style="display:none">No attack paths found for this node.</div>
    </div>
  </aside>

  <!-- MAIN GRAPH -->
  <div id="main">
    <svg id="graphSvg"></svg>
    <svg id="heatmapSvg" style="display:none; width:100%; height:100%"></svg>
    <div class="heatmap-tooltip" id="heatmapTooltip"></div>
    <div class="graph-tooltip" id="tooltip"></div>
    <div class="graph-hint" id="graphHint">scroll: zoom &middot; drag: navigate &middot; click: details</div>
  </div>

  <!-- TIMELINE -->
  <div id="timeline">
    <div class="timeline-title">ML Ecosystem Incident Timeline</div>
    <div class="timeline-scroll">
      <div class="timeline-track" id="timelineTrack">
        <div class="timeline-axis"></div>
      </div>
    </div>
  </div>
</div>
<div id="timeline-tooltip-overlay"></div>

<!-- LLM Chat Panel -->
<div id="llm-chat" class="collapsed">
  <div class="chat-header" onclick="toggleChat()">
    <span>&#x1F916; Ask about the map</span>
    <button class="chat-minimize" id="chatMinBtn">&#x25BC;</button>
  </div>
  <div class="chat-messages" id="chatMessages">
    <div class="chat-msg ai"><div class="msg-bubble">Ask me about attack paths, high-risk nodes, MITRE ATLAS mappings, or any part of the ML supply chain.</div></div>
  </div>
  <div class="chat-input-row">
    <input class="chat-input" id="chatInput" type="text" placeholder="Type a question..." autocomplete="off" spellcheck="false">
    <button class="chat-send-btn" id="chatSendBtn" onclick="sendChatMessage()">Send</button>
  </div>
</div>

<!-- Settings Modal -->
<div class="settings-modal-overlay" id="settingsOverlay">
  <div class="settings-modal">
    <div class="settings-title">&#x2699; Settings</div>
    <label class="settings-label">Groq API Key</label>
    <input class="settings-input" id="groqKeyInput" type="password" placeholder="gsk_..." autocomplete="off">
    <div class="settings-hint">
      Free API key from <a href="https://console.groq.com" target="_blank">console.groq.com</a>
      &mdash; no credit card required. Stored locally in your browser only.
    </div>
    <button class="settings-btn settings-btn-save" onclick="saveSettings()">Save</button>
    <button class="settings-btn settings-btn-cancel" onclick="closeSettings()">Cancel</button>
  </div>
</div>

<script>
// ══════════════════════════════════════════════════
// DATA
// ══════════════════════════════════════════════════

const LAYERS = {
  hardware:  { name: 'Hardware',              color: '#ff1744', order: 0 },
  base:      { name: 'Base Libraries',        color: '#ff9100', order: 1 },
  framework: { name: 'ML Frameworks',         color: '#ffea00', order: 2 },
  hf:        { name: 'HuggingFace Ecosystem', color: '#00e5ff', order: 3 },
  vectordb:  { name: 'Vector Databases',      color: '#18ffff', order: 3.5 },
  serving:   { name: 'Serving',               color: '#76ff03', order: 4 },
  agents:    { name: 'AI Agents',             color: '#ff6d00', order: 5 },
  app:       { name: 'Applications',          color: '#d500f9', order: 6 },
};

const THREAT_ACTORS = {
  'nation-state': { label: 'Nation-State APT',     icon: '\u{1f3db}',  color: '#ff1744' },
  'crime':        { label: 'Organized Crime',      icon: '\u{1f4b0}',  color: '#ff9100' },
  'insider':      { label: 'Rogue Maintainer',     icon: '\u{1f47e}',  color: '#ffea00' },
  'supply-chain': { label: 'Supply Chain',         icon: '\u{1f4e6}',  color: '#d500f9' },
  'opportunist':  { label: 'Opportunistic / PoC',  icon: '\u{1f529}',  color: '#76ff03' },
};

const NODES = [
  // Hardware
  { id: 'cuda',         label: 'NVIDIA CUDA',     layer: 'hardware',  downloads: 0,      risk: 95, depRepos: 0,     maintainers: 'NVIDIA Corp', since: 2020,
    blast: 'Compromising CUDA affects ~90% of all GPU inference. PyTorch ships 13 CUDA libraries as direct dependencies. ChatGPT, Tesla Autopilot, all production transformer systems run on CUDA.',
    cves: [{ id: 'CVE-2023-4969', cvss: 6.5, desc: 'LeftoverLocals \u2014 GPU memory leak between processes (Apple/AMD/Qualcomm)' }],
    attacks: [],
    threats: [
      { actor: 'nation-state', vector: 'Hardware-level backdoors or export controls on GPU compute; compromise affects 90% of GPU inference' },
      { actor: 'supply-chain', vector: 'Trojanized CUDA toolkit or driver update distributed via official channels' }
    ], shape: 'hex' },
  { id: 'tsmc',         label: 'TSMC',             layer: 'hardware',  downloads: 0,      risk: 90, depRepos: 0,     maintainers: 'TSMC', since: 2020,
    blast: 'TSMC manufactures ~90% of advanced chips, including all NVIDIA GPUs. Taiwan Strait geopolitical risks pose an existential threat to the entire AI chip supply chain.',
    cves: [], attacks: [],
    threats: [
      { actor: 'nation-state', vector: 'Geopolitical disruption (Taiwan Strait), export sanctions, or fab sabotage' },
      { actor: 'insider', vector: 'IP theft of chip fabrication processes' }
    ], shape: 'hex' },
  { id: 'asml',         label: 'ASML',             layer: 'hardware',  downloads: 0,      risk: 85, depRepos: 0,     maintainers: 'ASML', since: 2020,
    blast: '100% monopoly on EUV lithography. Machines costing \u20AC200M \u2014 literally no alternative supplier for advanced chip manufacturing.',
    cves: [], attacks: [],
    threats: [
      { actor: 'nation-state', vector: 'Targeting EUV monopoly via export controls or industrial espionage' }
    ], shape: 'hex' },
  // Base libraries
  { id: 'numpy',        label: 'numpy',            layer: 'base',      downloads: 683000000,  risk: 88, depRepos: 59200, maintainers: '~15 core', since: 2020,
    blast: 'Cornerstone of the ML ecosystem. 59,200+ dependent repos \u2014 largest blast radius of any package. numpy 2.0 API-breaking changes caused cascading failures across the ecosystem.',
    cves: [],
    attacks: [
      { date: '2023', desc: 'numpy 2.0 breaking changes \u2014 cascade of dependent package failures' },
      { date: '2025', desc: 'np.load(allow_pickle=True): .npy/.npz files with pickle objects \u2014 RCE when loading untrusted arrays. Default changed in 1.16.3, but thousands of projects still use True' }
    ],
    threats: [
      { actor: 'insider', vector: 'Rogue maintainer \u2014 subtle backdoor in core numerical routines (only ~15 core devs)' },
      { actor: 'supply-chain', vector: 'Dependency confusion or typosquatting on PyPI targeting 59K+ dependent repos' }
    ], shape: 'circle' },
  { id: 'scipy',        label: 'scipy',            layer: 'base',      downloads: 257000000,  risk: 55, depRepos: 12000, maintainers: '~10 core', since: 2020,
    blast: '257M downloads/mo. Used for scientific computing, optimization, and statistics in ML pipelines.',
    cves: [], attacks: [],
    threats: [
      { actor: 'supply-chain', vector: 'PyPI package substitution targeting scientific computing users' },
      { actor: 'opportunist', vector: 'Exploiting known deserialization or C-extension vulnerabilities' }
    ], shape: 'circle' },
  { id: 'pandas',       label: 'pandas',           layer: 'base',      downloads: 489000000,  risk: 55, depRepos: 25000, maintainers: '~15 core', since: 2020,
    blast: '489M downloads/mo. Data processing layer for most ML systems.',
    cves: [],
    attacks: [{ date: '2025', desc: 'pd.read_pickle() \u2014 DataFrame deserialization via pickle, RCE when loading untrusted data' }],
    threats: [
      { actor: 'supply-chain', vector: 'Malicious release targeting 489M monthly downloads' },
      { actor: 'opportunist', vector: 'RCE via pd.read_pickle() on untrusted DataFrames' }
    ], shape: 'circle' },
  { id: 'scikit-learn', label: 'scikit-learn',     layer: 'base',      downloads: 159000000,  risk: 62, depRepos: 18000, maintainers: '~20 core', since: 2020,
    blast: '159M downloads/mo. Classical ML \u2014 classification, regression, clustering. Depends on numpy and scipy.',
    cves: [],
    attacks: [{ date: '2025', desc: 'Pickle deserialization via joblib.load \u2014 scikit-learn models stored as pickle, RCE via __reduce__' }],
    threats: [
      { actor: 'supply-chain', vector: 'PyPI substitution for widely-used ML library' },
      { actor: 'opportunist', vector: 'Pickle RCE via joblib.load() on untrusted model files' }
    ], shape: 'circle' },
  { id: 'pillow',       label: 'Pillow',           layer: 'base',      downloads: 253000000,  risk: 45, depRepos: 15000, maintainers: '~5 core', since: 2020,
    blast: '253M downloads/mo. Image processing, critical for all CV pipelines.',
    cves: [], attacks: [],
    threats: [
      { actor: 'supply-chain', vector: 'Compromised release affecting all CV pipelines' },
      { actor: 'opportunist', vector: 'Heap overflow via crafted image files (historical CVE pattern)' }
    ], shape: 'circle' },
  { id: 'matplotlib',   label: 'matplotlib',       layer: 'base',      downloads: 129000000,  risk: 40, depRepos: 20000, maintainers: '~15 core', since: 2020,
    blast: '129M downloads/mo. Data visualization, depends on numpy. Used throughout the ML ecosystem.',
    cves: [], attacks: [],
    threats: [
      { actor: 'supply-chain', vector: 'Dependency confusion on PyPI \u2014 large download surface' }
    ], shape: 'circle' },
  // ML Frameworks
  { id: 'pytorch',      label: 'PyTorch',          layer: 'framework', downloads: 70800000,   risk: 92, depRepos: 30000, maintainers: '7 core', since: 2020,
    blast: '70.8M downloads/mo. Only 7 core maintainers \u2014 critical concentration. Ships 13 NVIDIA CUDA libraries. Primary framework for LLM training and inference.',
    cves: [{ id: 'CVE-2025-32434', cvss: 9.3, desc: 'weights_only=True bypass in torch.load() \u2014 RCE via "safe" model loading' }],
    attacks: [
      { date: '2022-12', desc: 'torchtriton dependency confusion \u2014 SSH key exfiltration via DNS tunneling' },
      { date: '2024-11', desc: 'Free Hugs Part 2: TF exploit persistence \u2014 exploit from TF 2.15 works in TF 2.18, pickle protocol 4 bypasses scanners' },
      { date: '2025', desc: 'TorchScript (.pt): torch.jit.load executes arbitrary code without sandbox \u2014 RCE via compiled models. Format .pt/.pth = pickle + ZIP' }
    ],
    threats: [
      { actor: 'nation-state', vector: 'Only 7 core maintainers \u2014 single highest-leverage target in ML' },
      { actor: 'insider', vector: 'Rogue maintainer backdoor in training/inference core' },
      { actor: 'supply-chain', vector: 'Dependency confusion (torchtriton 2022 incident proved this works)' },
      { actor: 'crime', vector: 'Cryptomining via torch.load() RCE on GPU servers' }
    ], shape: 'circle' },
  { id: 'tensorflow',   label: 'TensorFlow',       layer: 'framework', downloads: 21200000,   risk: 78, depRepos: 15000, maintainers: 'Google team', since: 2020,
    blast: '21.2M downloads/mo. 3 separate attack surfaces: pickle serialization, protobuf parsing, legitimate API abuse (TensorAbuse S&P\'25). CVE-2024-3660: Keras Lambda = arbitrary code in any model.',
    cves: [
      { id: 'CVE-2024-3660', cvss: 9.8, desc: 'Keras 2 Lambda Layers \u2014 arbitrary code injection via Lambda in .h5/SavedModel. Any model.load() with Lambda = code execution (CERT/CC VU#253266)' }
    ],
    attacks: [
      { date: '2024-11', desc: 'Free Hugs Part 2: Lambda Layer exploit \u2014 marshal deserialization in legacy h5 models, persistence across TF versions' },
      { date: '2025', desc: 'TensorAbuse (S&P\'25): legitimate TF APIs (Lambda, custom objects, TFLite delegates) create full-featured malware inside models. Model = file + executable code' },
      { date: '2025', desc: 'SavedModel arbitrary ops: tf.py_function in SavedModel executes arbitrary Python on tf.saved_model.load. Protobuf format without ops validation' }
    ],
    threats: [
      { actor: 'supply-chain', vector: 'Model-as-Malware: TensorAbuse proves legitimate TF APIs create malware inside models (S&P\'25)' },
      { actor: 'opportunist', vector: 'CVE-2024-3660: any model with Keras Lambda layer = arbitrary code execution' }
    ], shape: 'circle' },
  { id: 'keras',         label: 'Keras',            layer: 'framework', downloads: 17000000,   risk: 60, depRepos: 10000, maintainers: 'Google/community', since: 2020,
    blast: '17M downloads/mo. High-level API for TensorFlow and PyTorch. Widely used for prototyping and model training.',
    cves: [
      { id: 'CVE-2025-1550', cvss: 8.8, desc: 'Arbitrary code execution in .keras model loading' }
    ],
    attacks: [{ date: '2024-12', desc: 'Free Hugs Part 3: from_pretrained_keras loads legacy h5 with Lambda layers \u2014 marshal RCE' }],
    threats: [
      { actor: 'supply-chain', vector: 'Trojanized package targeting prototyping workflows' },
      { actor: 'opportunist', vector: 'Lambda layer marshal deserialization in legacy h5 models (Free Hugs Part 3)' }
    ], shape: 'circle' },
  // HuggingFace ecosystem
  { id: 'transformers', label: 'transformers',     layer: 'hf',        downloads: 104500000,  risk: 90, depRepos: 28575, maintainers: 'HF team (~20)', since: 2020,
    blast: '104.5M downloads/mo. Core HF ecosystem package \u2014 all models pass through it. 28,575 GitHub repos reuse pretrained models.',
    cves: [
      { id: 'CVE-2024-3568', cvss: 7.4, desc: 'Path traversal in Hugging Face Hub \u2014 file extraction beyond target directory' },
      { id: 'CVE-2025-11264', cvss: 8.1, desc: 'Dependency chain attack via hijacked GitHub repo \u2014 malicious code injection through compromised upstream dependency' }
    ],
    attacks: [{ date: '2024-11', desc: 'Checkmarx Free Hugs: trust_remote_code obfuscation \u2014 masking True via dict/str/expression in README' }],
    threats: [
      { actor: 'supply-chain', vector: 'Malicious auto_map config or trust_remote_code obfuscation in model repos' },
      { actor: 'crime', vector: 'Data exfiltration via backdoored pretrained models (28K+ dependent repos)' }
    ], shape: 'circle' },
  { id: 'hf-hub',       label: 'huggingface-hub',  layer: 'hf',        downloads: 163000000,  risk: 95, depRepos: 20000, maintainers: 'HF team (~10)', since: 2020,
    blast: '163M downloads/mo. MOST INCIDENT-DENSE node: API token exposure (1500+ tokens), AI Jacking, silent backdoor models, cross-tenant escape, picklescan bypasses, 9+ malicious datasets. 45.4B cumulative downloads.',
    cves: [{ id: 'CVE-2024-3568', cvss: 7.4, desc: 'Path traversal \u2014 file extraction beyond target directory during model download' }],
    attacks: [
      { date: '2023-12', desc: 'Lasso Security: 1500+ HF API tokens found on GitHub with write-access to Meta-Llama, Bloom, Pythia repos. Could backdoor model weights' },
      { date: '2024-02', desc: 'Namespace hijacking (AIJacking) \u2014 takeover of deleted accounts, reverse shell via models with 100K+ downloads' },
      { date: '2024', desc: 'Legit Security: CI/CD pipeline injection via malicious PR \u2014 hijack of any HF repo through CI workflow exploitation' },
      { date: '2024', desc: 'Wiz Research: cross-tenant attack on HF Inference API \u2014 container escape \u2192 access to other users\' models and data' },
      { date: '2024-12', desc: 'Free Hugs Part 1: malicious auto_map in config.json \u2014 arbitrary Python import during model loading' }
    ],
    threats: [
      { actor: 'supply-chain', vector: 'Most incident-dense node: token exposure, CI/CD hijack, silent backdoors, picklescan bypasses' },
      { actor: 'crime', vector: 'Mass distribution of trojanized models via the hub (45.4B cumulative downloads)' },
      { actor: 'insider', vector: 'Rogue employee \u2014 hub compromise would affect every HF package simultaneously' }
    ], shape: 'circle' },
  { id: 'tokenizers',   label: 'tokenizers',       layer: 'hf',        downloads: 98000000,   risk: 60, depRepos: 5000,  maintainers: 'HF team (~5)', since: 2020,
    blast: '98M downloads/mo. Rust tokenization implementation. Critical for all NLP models.',
    cves: [], attacks: [],
    threats: [
      { actor: 'insider', vector: 'Rogue maintainer \u2014 only ~5 core devs for Rust tokenizer used by all NLP models' },
      { actor: 'supply-chain', vector: 'Compromised crate/wheel targeting tokenizer pipeline' }
    ], shape: 'circle' },
  { id: 'safetensors',  label: 'safetensors',      layer: 'hf',        downloads: 56000000,   risk: 72, depRepos: 8000,  maintainers: 'HF team (~3)', since: 2020,
    blast: '56M downloads/mo. Positioned as a safe pickle replacement. Core \u2014 ~400 lines of Rust. Despite this, 44.9% of models still use pickle.',
    cves: [],
    attacks: [
      { date: '2024-02', desc: 'Safetensors conversion service hijack \u2014 converter bot used to poison models' },
      { date: '2024', desc: 'JFrog ML Bug Bonanza: even safetensors format has attack surface via metadata manipulation \u2014 information leakage and DoS. "Safe" is relative' },
      { date: '2024-12', desc: 'Free Hugs Part 4: PickleScan bypass via bdb.Bdb.run, pickle protocol 4, recursive torch.load' },
      { date: '2025', desc: 'Safetensors header bomb: JSON header up to 100MB \u2192 DoS during parsing. Metadata injection via arbitrary header keys' }
    ],
    threats: [
      { actor: 'insider', vector: 'Only ~3 maintainers for the "safe" format \u2014 extreme concentration risk' },
      { actor: 'supply-chain', vector: 'JFrog proved "safe" formats still have attack surface \u2014 metadata manipulation, DoS, info leakage' }
    ], shape: 'circle' },
  { id: 'datasets',     label: 'datasets',         layer: 'hf',        downloads: 46000000,   risk: 65, depRepos: 4000,  maintainers: 'HF team (~8)', since: 2020,
    blast: '46M downloads/mo. 500K+ datasets loaded through it. 9 malicious data loading scripts found.',
    cves: [], attacks: [{ date: '2024', desc: '9 malicious dataset loading scripts discovered by MalHug' }],
    threats: [
      { actor: 'supply-chain', vector: 'Malicious data loading scripts (9 already found by MalHug)' },
      { actor: 'crime', vector: 'Training data poisoning via compromised datasets' }
    ], shape: 'circle' },
  { id: 'accelerate',   label: 'accelerate',       layer: 'hf',        downloads: 20600000,   risk: 55, depRepos: 3000,  maintainers: 'HF team (~5)', since: 2020,
    blast: '20.6M downloads/mo. Distributed training \u2014 compromise could affect all training pipelines.',
    cves: [], attacks: [],
    threats: [
      { actor: 'supply-chain', vector: 'Trojanized release targeting distributed training pipelines' },
      { actor: 'insider', vector: 'Backdoor in multi-GPU coordination code' }
    ], shape: 'circle' },
  { id: 'diffusers',    label: 'diffusers',        layer: 'hf',        downloads: 9800000,    risk: 55, depRepos: 2000,  maintainers: 'HF team (~8)', since: 2020,
    blast: '9.8M downloads/mo. Framework for diffusion models (Stable Diffusion, etc.).',
    cves: [], attacks: [],
    threats: [
      { actor: 'supply-chain', vector: 'Malicious diffusion model checkpoints on HuggingFace Hub' },
      { actor: 'crime', vector: 'Trojanized image generation models for CSAM or deepfakes' }
    ], shape: 'circle' },
  { id: 'peft',         label: 'peft',             layer: 'hf',        downloads: 7900000,    risk: 50, depRepos: 1500,  maintainers: 'HF team (~5)', since: 2020,
    blast: '7.9M downloads/mo. Parameter-efficient fine-tuning \u2014 LoRA and other adapters.',
    cves: [], attacks: [],
    threats: [
      { actor: 'supply-chain', vector: 'Poisoned LoRA adapters uploaded to model hubs' },
      { actor: 'crime', vector: 'Backdoored fine-tuning adapters that activate on specific inputs' }
    ], shape: 'circle' },
  { id: 'trl',          label: 'trl',              layer: 'hf',        downloads: 2500000,    risk: 50, depRepos: 800,   maintainers: 'HF team (~5)', since: 2020,
    blast: '2.5M downloads/mo. RLHF model training. Part of HF cluster, depends on transformers, pytorch, peft, accelerate, datasets.',
    cves: [], attacks: [],
    threats: [
      { actor: 'supply-chain', vector: 'Compromised RLHF training pipeline to manipulate model alignment' },
      { actor: 'insider', vector: 'Subtle reward model manipulation during RLHF training' }
    ], shape: 'circle' },
  // Serving
  { id: 'vllm',         label: 'vLLM',             layer: 'serving',   downloads: 6500000,    risk: 92, depRepos: 2000,  maintainers: '~15 core', since: 2023,
    blast: '5-8M downloads/mo. Production LLM serving standard. 60+ direct dependencies \u2192 ~150+ unique packages after transitive resolution.',
    cves: [
      { id: 'CVE-2025-32444', cvss: 10.0, desc: 'RCE via pickle deserialization in Mooncake integration (ZeroMQ)' },
      { id: 'CVE-2026-22778', cvss: 9.8, desc: 'RCE via video processing \u2014 heap overflow in FFmpeg/OpenCV' },
      { id: 'CVE-2026-22807', cvss: 8.8, desc: 'RCE via auto_map dynamic HF module loading' },
      { id: 'CVE-2026-24779', cvss: 7.1, desc: 'SSRF in MediaConnector \u2014 hostname validation bypass' },
      { id: 'CVE-2025-62164', cvss: 9.1, desc: 'RCE via prompt embeddings deserialization (Wiz)' },
      { id: 'CVE-2025-66448', cvss: 9.8, desc: 'RCE via auto_map even when trust_remote_code=False' },
      { id: 'CVE-2024-9053', cvss: 9.8, desc: 'Pickle RCE in AsyncEngineRPCServer \u2014 arbitrary code execution via deserialization' },
      { id: 'CVE-2024-9052', cvss: 9.1, desc: 'Pickle RCE in recv_object \u2014 untrusted deserialization in RPC communication' },
      { id: 'CVE-2025-30165', cvss: 8.0, desc: 'ShadowMQ \u2014 unsafe pickle deserialization via ZeroMQ recv_pyobj(). Root of cross-framework propagation pattern' }
    ],
    attacks: [
      { date: '2025-04', desc: 'CVE-2025-32444 CVSS 10.0 \u2014 pickle RCE via Mooncake ZeroMQ, unauthorized access' },
      { date: '2025-11', desc: 'ShadowMQ: CVE-2025-30165 pickle/ZMQ vulnerability propagated to SGLang, TensorRT-LLM, Modular via code copy-paste' },
      { date: '2025', desc: 'KV-Cache Sharing Prompt Leakage (NDSS\'25): in multi-tenant serving, shared PagedAttention KV-cache allows cross-tenant prompt extraction' }
    ],
    threats: [
      { actor: 'crime', vector: 'Cryptomining on GPU inference servers via RCE (CVE-2025-32444 CVSS 10.0)' },
      { actor: 'opportunist', vector: 'Multi-tenant prompt leakage via shared KV-cache (PagedAttention) \u2014 NDSS\'25 research' },
      { actor: 'supply-chain', vector: 'Malicious dependency in 60+ direct deps (~150 transitive)' }
    ], shape: 'circle' },
  { id: 'onnx',         label: 'ONNX Runtime',     layer: 'serving',   downloads: 22900000,   risk: 68, depRepos: 5000,  maintainers: 'Microsoft', since: 2020,
    blast: '22.9M downloads/mo. Cross-platform inference \u2014 used by Azure, Windows ML, and many edge devices.',
    cves: [{ id: 'CVE-2024-27318', cvss: 7.5, desc: 'ONNX: path traversal via external_data \u2014 arbitrary file read during model loading' }],
    attacks: [
      { date: '2025', desc: 'Path traversal during ONNX model extraction + arbitrary custom operator execution' },
      { date: '2025', desc: 'ONNX Protobuf format: custom ops loading from shared libraries (.so/.dll) \u2014 arbitrary native code execution' }
    ],
    threats: [
      { actor: 'supply-chain', vector: 'Malicious custom operators (.so/.dll) loaded during ONNX model inference' },
      { actor: 'opportunist', vector: 'Path traversal via external_data during model loading (CVE-2024-27318)' }
    ], shape: 'circle' },
  { id: 'triton',       label: 'Triton',           layer: 'serving',   downloads: 35700000,   risk: 75, depRepos: 3000,  maintainers: 'OpenAI/NVIDIA', since: 2020,
    blast: '35.7M downloads/mo. GPU compiler, PyTorch auto-dependency. torchtriton was the target of the 2022 dependency confusion attack.',
    cves: [],
    attacks: [{ date: '2022-12', desc: 'torchtriton dependency confusion \u2014 2,717 malicious package downloads in 24 hours' }],
    threats: [
      { actor: 'supply-chain', vector: 'Dependency confusion \u2014 torchtriton attack (2022) proved this vector works' },
      { actor: 'nation-state', vector: 'GPU compiler backdoor affecting all PyTorch JIT compilation' }
    ], shape: 'circle' },
  // Applications
  { id: 'langchain',    label: 'LangChain',        layer: 'app',       downloads: 187000000,  risk: 75, depRepos: 8000,  maintainers: 'LangChain Inc', since: 2023,
    blast: '187M downloads/mo. LLM application framework \u2014 connects all ecosystem layers in production systems.',
    cves: [
      { id: 'CVE-2025-68664', cvss: 9.3, desc: '"LangGrinch" \u2014 serialization injection, secret leakage and RCE' },
      { id: 'CVE-2025-68665', cvss: 8.6, desc: 'Same for JS version @langchain/core' },
      { id: 'CVE-2025-64439', cvss: 8.4, desc: 'LangGraph checkpoint deserialization RCE \u2014 JsonPlusSerializer fallback reconstructs objects from attacker-controlled payloads' },
      { id: 'CVE-2025-8709', cvss: 8.5, desc: 'SQL injection in LangGraph \u2014 query manipulation via unsanitized input' },
      { id: 'CVE-2025-6985', cvss: 7.8, desc: 'XXE via XSLT processing \u2014 external entity injection in document parsing' },
      { id: 'CVE-2025-2828', cvss: 7.5, desc: 'SSRF in RequestsToolkit \u2014 server-side request forgery via crafted URLs' }
    ],
    attacks: [
      { date: '2025-12', desc: 'LangGrinch CVE-2025-68664 \u2014 API key leakage and RCE via serialization injection' },
      { date: '2025', desc: 'Prompt injection \u2192 Agent RCE: SQL injection via LangChain SQL Agent, data leakage via tool calling' },
      { date: '2024', desc: 'LLMSmith (CCS\'24): systematic RCE discovery tool found real RCE chains in LangChain. Confirms LLM frameworks = persistent RCE surface, not one-off bugs' }
    ],
    threats: [
      { actor: 'crime', vector: 'API key and secret extraction via serialization injection (LangGrinch)' },
      { actor: 'opportunist', vector: 'Systematic RCE surface confirmed by LLMSmith (CCS\'24) + prompt injection \u2192 SQL/OS injection chains' },
      { actor: 'supply-chain', vector: 'Malicious tool/chain in the fast-growing LangChain ecosystem' }
    ], shape: 'circle' },
  // Serving nodes
  { id: 'ollama',       label: 'Ollama',           layer: 'serving',   downloads: 5000000,    risk: 85, depRepos: 3000,  maintainers: 'Ollama Inc (~10)', since: 2023,
    blast: '175K public servers. RCE via OOB-write in GGUF, no authentication. Local LLM inference.',
    cves: [
      { id: 'CVE-2025-63389', cvss: 8.5, desc: 'Missing API authentication \u2014 unauthorized model operations' },
      { id: 'CVE-2025-0315', cvss: 7.5, desc: 'Unlimited memory allocation DoS \u2014 crafted request triggers unbounded memory consumption' },
      { id: 'CVE-2025-0312', cvss: 6.5, desc: 'Null pointer dereference DoS \u2014 crash via malformed input' },
      { id: 'CVE-2024-12886', cvss: 7.5, desc: 'Out-of-memory DoS \u2014 resource exhaustion via large model requests' }
    ],
    attacks: [{ date: '2025', desc: 'GGUF/GGML parsing: OOB write, heap overflow when loading crafted models' }],
    threats: [
      { actor: 'crime', vector: 'Cryptomining on 175K publicly exposed servers with no authentication' },
      { actor: 'opportunist', vector: 'OOB-write RCE via crafted GGUF model files' }
    ], shape: 'circle' },
  { id: 'mlflow',       label: 'MLflow',           layer: 'serving',   downloads: 20000000,   risk: 78, depRepos: 5000,  maintainers: 'LF AI (~20)', since: 2023,
    blast: '20M downloads/mo. ML lifecycle, model registry. Directory traversal \u2192 RCE (CVE-2025-11201).',
    cves: [
      { id: 'CVE-2025-11201', cvss: 8.8, desc: 'Directory traversal in Tracking Server \u2192 remote code execution' },
      { id: 'CVE-2024-1560', cvss: 7.5, desc: 'Path traversal in artifact deletion functionality' },
      { id: 'CVE-2024-1558', cvss: 8.8, desc: 'Arbitrary file overwrite via malicious remote data source \u2192 RCE' },
      { id: 'CVE-2025-14279', cvss: 7.5, desc: 'Origin validation error \u2014 bypass of authentication controls' },
      { id: 'CVE-2025-14297', cvss: 8.1, desc: 'Authentication bypass via GraphQL endpoint \u2014 unauthorized access to model registry' },
      { id: 'CVE-2025-14296', cvss: 7.5, desc: 'SSRF \u2014 server-side request forgery in artifact fetching' },
      { id: 'CVE-2025-10279', cvss: 9.1, desc: 'Privilege escalation \u2192 RCE \u2014 escalation from user to admin with code execution' }
    ], attacks: [],
    threats: [
      { actor: 'opportunist', vector: 'Directory traversal \u2192 RCE on model registry servers (CVE-2025-11201)' },
      { actor: 'crime', vector: 'Model registry poisoning to distribute backdoored production models' }
    ], shape: 'circle' },
  { id: 'jupyter',      label: 'Jupyter',          layer: 'base',      downloads: 30000000,   risk: 65, depRepos: 40000, maintainers: 'Jupyter team (~30)', since: 2020,
    blast: '30M downloads/mo. Primary ML IDE. DOM clobbering via malicious notebooks (CVE-2024-43805).',
    cves: [
      { id: 'CVE-2024-43805', cvss: 7.6, desc: 'DOM Clobbering via malicious Markdown cells in notebooks' }
    ], attacks: [],
    threats: [
      { actor: 'opportunist', vector: 'DOM Clobbering via malicious shared notebooks (CVE-2024-43805)' },
      { actor: 'crime', vector: 'Social engineering via trojanized .ipynb notebooks with hidden code cells' }
    ], shape: 'circle' },
  { id: 'dask',         label: 'Dask',             layer: 'base',      downloads: 30000000,   risk: 70, depRepos: 8000,  maintainers: 'Dask team (~15)', since: 2020,
    blast: '30M downloads/mo. Distributed computing. Pickle deserialization \u2192 RCE (CVE-2024-10096).',
    cves: [
      { id: 'CVE-2024-10096', cvss: 8.0, desc: 'Pickle deserialization in distributed server \u2192 remote command execution' }
    ], attacks: [],
    threats: [
      { actor: 'opportunist', vector: 'Pickle RCE on exposed distributed workers (CVE-2024-10096)' },
      { actor: 'crime', vector: 'Hijacking distributed compute clusters for cryptomining' }
    ], shape: 'circle' },
  { id: 'langflow',     label: 'Langflow',         layer: 'app',       downloads: 2000000,    risk: 88, depRepos: 1500,  maintainers: 'DataStax (~15)', since: 2023,
    blast: '2M downloads/mo. 79K+ GitHub stars. CVE-2025-3248 added to CISA KEV. Active Flodrix botnet exploitation for DDoS and data exfiltration.',
    cves: [
      { id: 'CVE-2025-3248', cvss: 9.8, desc: 'Unauthenticated RCE via /api/v1/validate/code \u2014 arbitrary Python code execution. CISA KEV 2025-05-05' }
    ],
    attacks: [
      { date: '2025-05', desc: 'CVE-2025-3248 added to CISA KEV. Flodrix botnet actively exploiting for DDoS and data exfiltration. Public PoC on GitHub' }
    ],
    threats: [
      { actor: 'opportunist', vector: 'Unauthenticated RCE via /api/v1/validate/code (CVE-2025-3248 CVSS 9.8, CISA KEV)' },
      { actor: 'crime', vector: 'Flodrix botnet: active DDoS and data exfiltration campaign (Trend Micro confirmed)' }
    ], shape: 'circle' },
  { id: 'dify',         label: 'Dify',             layer: 'app',       downloads: 3000000,    risk: 80, depRepos: 2000,  maintainers: 'Dify Inc (~20)', since: 2023,
    blast: '3M downloads/mo. Sandbox escape with root privileges (CVE-2025-3466, CVSS 9.8). LLM platform.',
    cves: [
      { id: 'CVE-2025-3466', cvss: 9.8, desc: 'Sandbox escape \u2014 code execution with root privileges via code node' },
      { id: 'CVE-2025-0185', cvss: 8.5, desc: 'Pandas query injection \u2014 arbitrary code execution via crafted data queries' },
      { id: 'CVE-2025-0184', cvss: 7.5, desc: 'SSRF in WordExtractor \u2014 server-side request forgery via document processing' }
    ], attacks: [],
    threats: [
      { actor: 'opportunist', vector: 'Sandbox escape with root privileges (CVE-2025-3466 CVSS 9.8)' },
      { actor: 'crime', vector: 'Exfiltrating data from self-hosted LLM platform instances' }
    ], shape: 'circle' },
  { id: 'gradio',        label: 'Gradio',           layer: 'app',       downloads: 15000000,   risk: 72, depRepos: 5000,  maintainers: 'HF team (~10)', since: 2024,
    blast: '15M downloads/mo. ML demos and interfaces. Arbitrary file read, SSRF, path traversal history. Primary tool for model demo interfaces.',
    cves: [
      { id: 'CVE-2024-47084', cvss: 8.3, desc: 'SSRF via URL upload \u2014 access to internal services and metadata' },
      { id: 'CVE-2024-47167', cvss: 7.5, desc: 'SSRF via /queue/join endpoint' },
      { id: 'CVE-2024-47164', cvss: 6.5, desc: 'Path traversal via file upload cache' },
      { id: 'CVE-2024-12217', cvss: 7.5, desc: 'Path traversal Windows bypass \u2014 file access via path normalization on Windows' },
      { id: 'CVE-2024-10648', cvss: 6.5, desc: 'File deletion via audio component \u2014 arbitrary file removal' }
    ],
    attacks: [],
    threats: [
      { actor: 'opportunist', vector: 'Arbitrary file read and SSRF via URL upload (CVE-2024-47084)' },
      { actor: 'supply-chain', vector: 'Trojanized Gradio spaces serving malicious model demos' }
    ], shape: 'circle' },
  { id: 'ray',           label: 'Ray',              layer: 'serving',   downloads: 8000000,    risk: 92, depRepos: 4000,  maintainers: 'Anyscale (~20)', since: 2024,
    blast: '8M downloads/mo. 230K+ exposed servers. ShadowRay: CVE-2023-48022 actively exploited, CVE NOT PATCHED (Anyscale considers it design decision). ShadowRay 2.0: self-propagating botnet.',
    cves: [{ id: 'CVE-2023-48022', cvss: 9.8, desc: 'Unauthenticated Ray Dashboard \u2014 RCE via Job Submission API (ShadowRay). NOT PATCHED \u2014 design decision' }],
    attacks: [
      { date: '2024-03', desc: 'ShadowRay: 230K+ exposed Ray servers. Cryptomining (XMRig), data theft, DDoS. Botnet families RondoDox, MooBot, KmsdBot integrated exploit' },
      { date: '2025-11', desc: 'ShadowRay 2.0: self-propagating botnet by IronErn440. AI-generated payloads, worm-like spreading between Ray clusters' },
      { date: '2024', desc: 'Ray ObjectStore: pickle serialization between workers \u2014 RCE upon compromising a single cluster node. No trust boundaries' }
    ],
    threats: [
      { actor: 'crime', vector: 'ShadowRay mass exploitation \u2014 230K+ servers, cryptomining, data theft, DDoS botnets' },
      { actor: 'opportunist', vector: 'CVE NOT PATCHED (design decision) \u2014 any exposed Ray dashboard = immediate RCE' }
    ], shape: 'circle' },
  { id: 'wandb',         label: 'W&B',              layer: 'serving',   downloads: 5000000,    risk: 60, depRepos: 3000,  maintainers: 'Weights & Biases (~15)', since: 2024,
    blast: '5M downloads/mo. Experiment tracking. Artifact deserialization, API key leakage via logs.',
    cves: [], attacks: [],
    threats: [
      { actor: 'crime', vector: 'API key harvesting from leaked experiment logs' },
      { actor: 'supply-chain', vector: 'Trojanized artifact downloads from experiment tracking' }
    ], shape: 'circle' },
  { id: 'llamaindex',    label: 'LlamaIndex',       layer: 'app',       downloads: 8000000,    risk: 70, depRepos: 2000,  maintainers: 'LlamaIndex Inc (~15)', since: 2023,
    blast: '8M downloads/mo. RAG framework. Prompt injection \u2192 data exfiltration via retrieval-augmented generation.',
    cves: [
      { id: 'CVE-2024-45202', cvss: 7.5, desc: 'Prompt injection via poisoned documents in RAG pipeline' },
      { id: 'CVE-2025-1793', cvss: 8.5, desc: 'SQL injection in vector stores \u2014 query manipulation via unsanitized vector search inputs' },
      { id: 'CVE-2025-1750', cvss: 9.1, desc: 'SQL injection in DuckDB \u2192 RCE \u2014 arbitrary code execution via crafted queries' },
      { id: 'CVE-2025-1753', cvss: 8.8, desc: 'CLI command injection \u2014 OS command execution via crafted CLI arguments' }
    ],
    attacks: [
      { date: '2024', desc: 'LLMSmith (CCS\'24): systematic RCE discovery tool found real RCE chains in LlamaIndex. LLM4Shell (BlackHat Asia\'24) demoed practical exploit chains' }
    ],
    threats: [
      { actor: 'crime', vector: 'Data exfiltration from RAG pipelines processing confidential documents' },
      { actor: 'opportunist', vector: 'Systematic RCE surface (LLMSmith CCS\'24) + prompt injection via poisoned documents' }
    ], shape: 'circle' },
  // Serialization format core
  { id: 'llama-cpp',     label: 'llama.cpp',        layer: 'serving',   downloads: 4000000,    risk: 85, depRepos: 6000,  maintainers: 'ggerganov + community (~30)', since: 2023,
    blast: '4M downloads/mo, 75K+ GitHub stars. Core GGUF/GGML parser \u2014 backbone of Ollama, LM Studio, GPT4All. CVE-2024-34359: GGUF metadata Jinja2 injection \u2192 RCE destroys "safe format" assumption.',
    cves: [
      { id: 'CVE-2024-42479', cvss: 9.8, desc: 'GGUF: path traversal \u2192 arbitrary file overwrite during model extraction' },
      { id: 'CVE-2024-34359', cvss: 9.6, desc: 'GGUF metadata Jinja2 template injection \u2192 RCE via crafted model. Destroys "safe format" assumption. Affects llama-cpp-python, LocalAI, Ollama, GPT4All' },
      { id: 'CVE-2024-25294', cvss: 8.8, desc: 'GGUF parser: multiple heap buffer overflows during tensor processing' },
      { id: 'CVE-2024-23605', cvss: 8.2, desc: 'Heap buffer overflow in gguf_fread_str \u2014 RCE via crafted model' }
    ],
    attacks: [
      { date: '2024-08', desc: 'GGUF header manipulation: OOB write via crafted tensor sizes, alignment check bypass' },
      { date: '2024', desc: 'CVE-2024-34359: Jinja2 template injection in GGUF metadata field. GGUF considered "safe" \u2014 this CVE breaks that assumption for entire local inference ecosystem' }
    ],
    threats: [
      { actor: 'supply-chain', vector: 'Malicious GGUF models with Jinja2 payload in metadata \u2014 RCE on Ollama, LM Studio, GPT4All, LocalAI' },
      { actor: 'opportunist', vector: 'Heap buffer overflow + template injection via crafted GGUF models (multiple CVEs)' }
    ], shape: 'circle' },
  // Agentic frameworks — now in 'agents' layer
  { id: 'crewai',        label: 'CrewAI',           layer: 'agents',    downloads: 1000000,    risk: 75, depRepos: 2000,  maintainers: 'CrewAI Inc (~15)', since: 2023,
    blast: '1M downloads/mo. Multi-agent orchestration framework. 60% Fortune 500 claim. Internal GitHub token leak (Dec 2025) exposed all private repos. COLM 2025 research: orchestrator hijacking to download and execute malicious binaries, even bypassing sub-agent refusals.',
    cves: [],
    attacks: [
      { date: '2025-12', desc: 'Uncrew token leak: high-privilege internal GitHub token exposed via improper exception handling, granting full access to all private repos' },
      { date: '2025', desc: 'COLM 2025: control-flow hijacking of CrewAI orchestrators \u2014 sub-agents bypassed, reverse shell executed despite safety refusals' }
    ],
    threats: [
      { actor: 'crime', vector: 'Orchestrator hijacking \u2014 reverse shell via multi-agent control-flow manipulation' },
      { actor: 'supply-chain', vector: 'Exploiting leaked internal tokens (Dec 2025 incident) to poison private repos' }
    ], shape: 'circle' },
  { id: 'autogpt',       label: 'AutoGPT',          layer: 'agents',    downloads: 500000,     risk: 82, depRepos: 3000,  maintainers: 'Significant Gravitas (~20)', since: 2023,
    blast: '166K+ GitHub stars, one of the most starred AI repos. Command denylist bypass (CVSS 9.8) via path normalization. API keys logged in plaintext. Autonomous code execution with minimal guardrails.',
    cves: [
      { id: 'CVE-2024-6091', cvss: 9.8, desc: 'Shell command denylist bypass via path normalization (/bin/./whoami) \u2014 OS command injection' },
      { id: 'CVE-2026-22038', cvss: 8.1, desc: 'API keys and auth secrets logged in plaintext via logger.info() in Stagehand integration' }
    ],
    attacks: [{ date: '2024', desc: 'Prompt injection hijacking: GPT-4 linked to AutoGPT for automated prompt injection via API requests, searches, and code execution' }],
    threats: [
      { actor: 'opportunist', vector: 'Command denylist bypass via path normalization \u2192 OS command injection' },
      { actor: 'crime', vector: 'Autonomous agents executing attacker-controlled code with minimal guardrails' }
    ], shape: 'circle' },
  { id: 'metagpt',       label: 'MetaGPT',          layer: 'agents',    downloads: 200000,     risk: 76, depRepos: 1000,  maintainers: 'Foundation Agents (~15)', since: 2023,
    blast: '45K GitHub stars. Multi-agent software engineering framework. Critical deserialization RCE in deserialize_message (ZDI-26-026). Agents generate and execute code autonomously.',
    cves: [
      { id: 'CVE-2026-0763', cvss: 9.8, desc: 'Deserialization of untrusted data in deserialize_message \u2014 Remote Code Execution (ZDI-26-026)' }
    ],
    attacks: [{ date: '2025', desc: 'Multi-agent code execution: 97% malicious code execution rate for GPT-4o orchestrators interacting with poisoned files (arXiv research)' }],
    threats: [
      { actor: 'opportunist', vector: 'Deserialization RCE in deserialize_message (CVE-2026-0763 CVSS 9.8)' },
      { actor: 'crime', vector: 'Poisoned files triggering 97% malicious code execution rate in multi-agent workflows' }
    ], shape: 'circle' },
  { id: 'n8n',           label: 'n8n',              layer: 'app',       downloads: 2000000,    risk: 88, depRepos: 1500,  maintainers: 'n8n GmbH (~30)', since: 2024,
    blast: '103K+ internet-facing instances. 4 CVSS 9.9-10.0 vulnerabilities in a single month. AI workflow automation platform. Compromise exposes all connected API credentials, OAuth tokens, and database connections.',
    cves: [
      { id: 'CVE-2026-21858', cvss: 10.0, desc: 'Ni8mare: unauthenticated RCE via content-type confusion in webhook handling' },
      { id: 'CVE-2026-21877', cvss: 10.0, desc: 'Unrestricted file upload with dangerous type \u2014 chains with CVE-2026-21858 for full unauth compromise' },
      { id: 'CVE-2025-68613', cvss: 9.9, desc: 'Authenticated RCE via expression injection in workflow definitions' },
      { id: 'CVE-2025-68668', cvss: 9.9, desc: 'N8scape: Pyodide sandbox bypass via _pyodide._base.eval_code() \u2014 arbitrary OS commands' }
    ],
    attacks: [{ date: '2026-01', desc: 'Ni8mare: mass exploitation of 100K+ exposed n8n servers. Government advisories issued by Australia and Canada' }],
    threats: [
      { actor: 'opportunist', vector: '4 CVEs at CVSS 9.9-10.0 \u2014 unauth RCE, sandbox bypass, file upload chains' },
      { actor: 'crime', vector: 'Credential harvesting from 100K+ exposed instances (all connected API keys, OAuth tokens, databases)' }
    ], shape: 'circle' },
  { id: 'haystack',      label: 'Haystack',         layer: 'app',       downloads: 500000,     risk: 68, depRepos: 1500,  maintainers: 'deepset GmbH (~20)', since: 2024,
    blast: '18K GitHub stars. RAG and agent framework. Jinja2 SSTI in 7 components (PromptBuilder, ChatPromptBuilder, OutputAdapter, etc.) \u2014 arbitrary code execution via template injection.',
    cves: [
      { id: 'CVE-2024-41950', cvss: 7.5, desc: 'Server-Side Template Injection (SSTI) via Jinja2 in PromptBuilder and 6 other components \u2014 arbitrary code execution' }
    ],
    attacks: [{ date: '2025', desc: 'Flatt Security case study: Jinja2 SSTI pattern exploitable when user input embedded into prompt templates without sanitization' }],
    threats: [
      { actor: 'opportunist', vector: 'Jinja2 SSTI in 7 components \u2192 arbitrary code execution' },
      { actor: 'supply-chain', vector: 'Template injection via poisoned user input in RAG prompt templates' }
    ], shape: 'circle' },
  // Sightline/huntr vulnerability data
  { id: 'litellm',       label: 'LiteLLM',          layer: 'serving',   downloads: 8000000,    risk: 72, depRepos: 3000,  maintainers: 'BerriAI (~15)', since: 2023,
    blast: 'LLM proxy routing to 100+ model providers. SSRF and auth bypass CVEs. Compromise exposes all API keys for connected LLM providers.',
    cves: [
      { id: 'CVE-2024-6587', cvss: 8.1, desc: 'SSRF in chat completion endpoint' },
      { id: 'CVE-2024-4888', cvss: 7.5, desc: 'Server-side request forgery via /chat/completions' },
      { id: 'CVE-2025-0628', cvss: 8.8, desc: 'Privilege escalation \u2014 unauthorized elevation from user to admin role' },
      { id: 'CVE-2025-0330', cvss: 7.5, desc: 'Langfuse API key leak \u2014 sensitive credentials exposed in responses' },
      { id: 'CVE-2024-9606', cvss: 6.5, desc: 'API key logged in plaintext \u2014 credentials visible in application logs' }
    ],
    attacks: [],
    threats: [
      { actor: 'crime', vector: 'API key harvesting \u2014 proxy stores credentials for OpenAI, Azure, Anthropic, etc.' },
      { actor: 'opportunist', vector: 'SSRF via chat completion endpoint to reach internal services (CVE-2024-6587)' }
    ], shape: 'circle' },
  { id: 'bentoml',       label: 'BentoML',          layer: 'serving',   downloads: 3000000,    risk: 80, depRepos: 2000,  maintainers: 'BentoML Inc (~20)', since: 2023,
    blast: 'Model serving framework. Critical pickle deserialization RCE (CVSS 9.8). Compromise allows arbitrary code execution on inference servers.',
    cves: [
      { id: 'CVE-2025-32375', cvss: 9.8, desc: 'RCE via insecure deserialization in runner server (pickle)' },
      { id: 'CVE-2025-27520', cvss: 9.8, desc: 'Insecure deserialization of untrusted data' },
      { id: 'CVE-2024-9070', cvss: 9.1, desc: 'Deserialization vulnerability in runner server \u2014 arbitrary code execution via crafted payloads' }
    ],
    attacks: [{ date: '2025', desc: 'Pickle-based RCE in BentoML runner server \u2014 replaced with JSON serialization in v1.4.8' }],
    threats: [
      { actor: 'opportunist', vector: 'Pickle deserialization RCE on model serving infrastructure (CVE-2025-32375 CVSS 9.8)' },
      { actor: 'supply-chain', vector: 'Trojanized BentoML service definitions distributed via model hubs' }
    ], shape: 'circle' },
  { id: 'kubeflow',      label: 'Kubeflow',         layer: 'serving',   downloads: 1000000,    risk: 70, depRepos: 2000,  maintainers: 'Kubeflow community (~30)', since: 2023,
    blast: 'ML pipeline orchestration on Kubernetes. Manages training, serving, and experiment tracking at scale. Namespace isolation bypass and privilege escalation risks.',
    cves: [
      { id: 'CVE-2024-5552', cvss: 8.1, desc: 'Kubeflow Notebooks CSRF vulnerability' }
    ],
    attacks: [],
    threats: [
      { actor: 'crime', vector: 'Cluster takeover via unauthenticated Kubeflow dashboard on misconfigured K8s clusters' },
      { actor: 'opportunist', vector: 'CSRF and privilege escalation in Kubeflow Notebooks' }
    ], shape: 'circle' },
  // ── NEW NODES from huntr CSV ──
  { id: 'smolagents',    label: 'smolagents',       layer: 'agents',    downloads: 2000000,    risk: 65, depRepos: 1000,  maintainers: 'HF team (~5)', since: 2024,
    blast: '~2M downloads/mo. HF AI Agent framework. XPath injection and sandbox escape vulnerabilities. Connects to transformers, hf-hub, pytorch.',
    cves: [
      { id: 'CVE-2025-11844', cvss: 7.5, desc: 'XPath injection \u2014 data extraction via crafted XPath queries in agent tools' },
      { id: 'CVE-2025-5120', cvss: 9.1, desc: 'Sandbox escape \u2192 RCE \u2014 arbitrary code execution outside agent sandbox boundaries' }
    ],
    attacks: [],
    threats: [
      { actor: 'opportunist', vector: 'Sandbox escape \u2192 RCE via agent tool execution (CVE-2025-5120 CVSS 9.1)' },
      { actor: 'supply-chain', vector: 'Malicious agent tools distributed through HuggingFace ecosystem' }
    ], shape: 'circle' },
  { id: 'deepspeed',     label: 'DeepSpeed',        layer: 'framework', downloads: 5000000,    risk: 72, depRepos: 3000,  maintainers: 'Microsoft (~15)', since: 2024,
    blast: '~5M downloads/mo. Microsoft distributed training framework. Multiple command injection and pickle deserialization RCE vulnerabilities.',
    cves: [
      { id: 'CVE-2024-43497', cvss: 8.8, desc: 'Command injection \u2014 arbitrary OS command execution via crafted training configurations' },
      { id: 'CVE-2024-43498', cvss: 8.8, desc: 'Pickle deserialization RCE \u2014 arbitrary code execution via untrusted checkpoint loading' }
    ],
    attacks: [],
    threats: [
      { actor: 'opportunist', vector: 'Command injection and pickle RCE via crafted training configs and checkpoints' },
      { actor: 'supply-chain', vector: 'Trojanized training checkpoints distributed via model hubs' }
    ], shape: 'circle' },
  { id: 'librechat',     label: 'LibreChat',        layer: 'app',       downloads: 1000000,    risk: 78, depRepos: 1000,  maintainers: '~15', since: 2024,
    blast: '~1M downloads/mo. Open-source ChatGPT alternative. 15+ huntr disclosures in single wave including path traversal \u2192 RCE and file deletion.',
    cves: [
      { id: 'CVE-2024-11170', cvss: 9.1, desc: 'Path traversal \u2192 RCE \u2014 arbitrary file read/write leading to code execution' },
      { id: 'CVE-2024-10361', cvss: 7.5, desc: 'File deletion \u2014 arbitrary file removal via crafted requests' },
      { id: 'CVE-2024-10360', cvss: 7.5, desc: 'Path traversal \u2014 directory traversal in file handling endpoints' },
      { id: 'CVE-2024-10359', cvss: 6.5, desc: 'Information disclosure \u2014 sensitive data exposure via error messages' }
    ],
    attacks: [{ date: '2024-11', desc: '15+ huntr vulnerability disclosures in a single wave \u2014 path traversal, file deletion, info disclosure' }],
    threats: [
      { actor: 'opportunist', vector: 'Path traversal \u2192 RCE on self-hosted ChatGPT alternative instances (CVE-2024-11170)' },
      { actor: 'crime', vector: 'Exfiltrating conversation data from self-hosted chat instances' }
    ], shape: 'circle' },
  { id: 'open-webui',    label: 'Open WebUI',       layer: 'app',       downloads: 3000000,    risk: 80, depRepos: 2000,  maintainers: '~20', since: 2023,
    blast: '~3M downloads/mo. Most popular self-hosted LLM UI. 25+ huntr CVEs total including multiple DoS and auth bypass vulnerabilities.',
    cves: [
      { id: 'CVE-2024-12868', cvss: 7.5, desc: 'DoS \u2014 denial of service via crafted requests causing resource exhaustion' },
      { id: 'CVE-2024-12537', cvss: 8.1, desc: 'Unauthenticated DoS \u2014 service disruption without authentication' },
      { id: 'CVE-2024-9840', cvss: 7.5, desc: 'DoS \u2014 application crash via malformed input processing' },
      { id: 'CVE-2024-9814', cvss: 6.5, desc: 'Information disclosure \u2014 sensitive configuration data exposure' },
      { id: 'CVE-2024-9813', cvss: 7.5, desc: 'Authentication bypass \u2014 unauthorized access to admin functions' }
    ],
    attacks: [{ date: '2024-10', desc: '25+ huntr CVEs disclosed \u2014 DoS, auth bypass, info disclosure across multiple components' }],
    threats: [
      { actor: 'opportunist', vector: 'Multiple DoS vectors and auth bypass on self-hosted LLM UI instances' },
      { actor: 'crime', vector: 'Unauthorized access to conversation histories and connected LLM API keys' }
    ], shape: 'circle' },
  { id: 'composio',      label: 'Composio',         layer: 'agents',    downloads: 500000,     risk: 72, depRepos: 500,   maintainers: '~15', since: 2024,
    blast: '~500K downloads/mo. Agent tooling platform. Critical auth bypass (CVSS 9.1), unsafe eval, and SSRF vulnerabilities.',
    cves: [
      { id: 'CVE-2024-8954', cvss: 9.1, desc: 'Authentication bypass \u2014 unauthorized access to all agent tooling operations (CVSS 9.1)' },
      { id: 'CVE-2024-8953', cvss: 8.8, desc: 'Unsafe eval \u2014 arbitrary code execution via crafted input to eval() calls' },
      { id: 'CVE-2024-8952', cvss: 7.5, desc: 'SSRF \u2014 server-side request forgery in tool integration endpoints' }
    ],
    attacks: [],
    threats: [
      { actor: 'opportunist', vector: 'Auth bypass + unsafe eval chain \u2192 full compromise of agent tooling platform (CVE-2024-8954 CVSS 9.1)' },
      { actor: 'crime', vector: 'Unauthorized access to all connected service credentials via agent tooling' }
    ], shape: 'circle' },
  // ── LLM Provider SDKs ──
  { id: 'openai-sdk',     label: 'OpenAI SDK',       layer: 'serving',   downloads: 125000000,  risk: 85, depRepos: 50000, maintainers: 'OpenAI (~10)', since: 2020,
    blast: '125M downloads/mo. Core Python SDK for GPT-4, o1, DALL-E, Whisper. Used by nearly every LLM application directly or transitively. Compromise exposes all API keys and allows MITM on model responses.',
    cves: [],
    attacks: [
      { date: '2024', desc: 'CVE-2024-27564: SSRF in ChatGPT infrastructure actively exploited — 10K+ attack attempts from single IP, 35% of organizations unprotected' },
      { date: '2025', desc: 'CVE-2025-61260: Codex CLI arbitrary command execution via project config — implicitly trusted local configs' }
    ],
    threats: [
      { actor: 'supply-chain', vector: 'Compromised release would affect 125M monthly installs — largest LLM SDK attack surface' },
      { actor: 'crime', vector: 'API key harvesting from leaked environment variables and logs' }
    ], shape: 'circle' },
  { id: 'anthropic-sdk',  label: 'Anthropic SDK',    layer: 'serving',   downloads: 44000000,   risk: 72, depRepos: 15000, maintainers: 'Anthropic (~10)', since: 2023,
    blast: '44M downloads/mo. SDK for Claude models. MCP ecosystem has critical CVEs (Inspector RCE CVSS 9.4, mcp-remote RCE CVSS 9.6). Compromise exposes Claude API keys.',
    cves: [],
    attacks: [
      { date: '2025', desc: 'CVE-2025-49596: Critical RCE in MCP Inspector (CVSS 9.4) — browser-based exploit via DNS rebinding + CSRF' },
      { date: '2025', desc: 'CVE-2025-52882: WebSocket auth bypass in Claude Code extensions (CVSS 8.8)' },
      { date: '2025', desc: 'CVE-2025-53109/53110: Filesystem MCP Server sandbox escapes — symlink bypass + directory containment bypass' }
    ],
    threats: [
      { actor: 'supply-chain', vector: 'Compromised SDK would expose all Claude API keys across 44M monthly installs' },
      { actor: 'opportunist', vector: 'MCP ecosystem attack surface — Inspector, filesystem server, SQLite server all had critical CVEs' }
    ], shape: 'circle' },
  { id: 'google-genai',   label: 'Google GenAI',     layer: 'serving',   downloads: 238000000,  risk: 78, depRepos: 20000, maintainers: 'Google (~15)', since: 2024,
    blast: '238M downloads/mo — highest download count of any LLM SDK. Unified SDK for Gemini, Vertex AI, Imagen, Veo. Replaced deprecated google-generativeai. Compromise would be catastrophic.',
    cves: [],
    attacks: [],
    threats: [
      { actor: 'supply-chain', vector: '238M monthly downloads — single largest LLM SDK target. PyPI typosquatting campaigns have targeted Google AI packages' },
      { actor: 'crime', vector: 'Credential harvesting for Google Cloud / Vertex AI service accounts' }
    ], shape: 'circle' },
  { id: 'mistralai-sdk',  label: 'Mistral SDK',      layer: 'serving',   downloads: 5700000,    risk: 50, depRepos: 3000,  maintainers: 'Mistral AI (~10)', since: 2024,
    blast: '5.7M downloads/mo. Python SDK for Mistral AI models. European AI leader. Auto-generated SDK — manual changes overwritten on regeneration.',
    cves: [],
    attacks: [],
    threats: [
      { actor: 'supply-chain', vector: 'Auto-generated SDK code — compromise of generation pipeline affects all releases' },
      { actor: 'crime', vector: 'API key extraction from Mistral-powered applications' }
    ], shape: 'circle' },
  { id: 'cohere-sdk',     label: 'Cohere SDK',       layer: 'serving',   downloads: 7500000,    risk: 50, depRepos: 2000,  maintainers: 'Cohere (~10)', since: 2023,
    blast: '7.5M downloads/mo. Enterprise AI SDK supporting Cohere platform, AWS Bedrock, Azure, GCP, and Oracle OCI.',
    cves: [],
    attacks: [],
    threats: [
      { actor: 'supply-chain', vector: 'Multi-cloud SDK — compromise exposes credentials for AWS, Azure, GCP, OCI simultaneously' },
      { actor: 'crime', vector: 'Enterprise API key harvesting from cloud deployments' }
    ], shape: 'circle' },
  { id: 'gigachat-sdk',   label: 'GigaChat SDK',     layer: 'serving',   downloads: 54000,      risk: 45, depRepos: 200,   maintainers: 'Sber AI (~5)', since: 2023,
    blast: '54K downloads/mo. Sber GigaChat REST API SDK. Part of GigaChain ecosystem with langchain-gigachat.',
    cves: [],
    attacks: [],
    threats: [
      { actor: 'supply-chain', vector: 'Smaller ecosystem SDK — less community security review than major providers' },
      { actor: 'crime', vector: 'Enterprise API key harvesting from GigaChat deployments' }
    ], shape: 'circle' },
  { id: 'groq-sdk',       label: 'Groq SDK',         layer: 'serving',   downloads: 1900000,    risk: 48, depRepos: 1000,  maintainers: 'Groq (~10)', since: 2024,
    blast: '1.9M downloads/mo. SDK for Groq ultra-fast LPU inference. Growing rapidly as fastest inference provider.',
    cves: [],
    attacks: [],
    threats: [
      { actor: 'supply-chain', vector: 'Fast-growing SDK — rapidly increasing attack surface as Groq adoption grows' },
      { actor: 'crime', vector: 'API key theft targeting high-performance inference endpoints' }
    ], shape: 'circle' },
  // ── Enrichment: Base Libraries ──
  { id: 'protobuf',      label: 'protobuf',         layer: 'base',      downloads: 300000000,  risk: 82, depRepos: 40000, maintainers: 'Google (~10)', since: 2020,
    blast: '300M downloads/mo. Google Protocol Buffers — serialization for TensorFlow, ONNX, gRPC. Compromise = compromise of all model serving.',
    cves: [
      { id: 'CVE-2025-4565', cvss: 8.2, desc: 'Uncontrolled recursion in Pure-Python backend — DoS via recursive group/message/SGROUP parsing' },
      { id: 'CVE-2024-7254', cvss: 7.5, desc: 'Stack Overflow — unbounded recursion via nested groups and map fields in DiscardUnknownFieldsParser' }
    ], attacks: [],
    threats: [
      { actor: 'supply-chain', vector: 'Foundation serialization for TF/ONNX/gRPC — compromise propagates to entire model serving stack' },
      { actor: 'opportunist', vector: 'DoS via recursive message parsing (CVE-2025-4565 CVSS 8.2)' }
    ], shape: 'circle' },
  { id: 'opencv-python', label: 'OpenCV',           layer: 'base',      downloads: 90000000,   risk: 78, depRepos: 20000, maintainers: 'OpenCV team (~15)', since: 2020,
    blast: '90M downloads/mo. Computer Vision C++ library. Crafted image → RCE on inference servers. All CV pipelines (YOLO, diffusers) depend on it.',
    cves: [
      { id: 'CVE-2025-53644', cvss: 8.8, desc: 'Uninitialized pointer → arbitrary heap buffer write via crafted JPEG' },
      { id: 'CVE-2019-5063', cvss: 8.8, desc: 'Heap buffer overflow in imgcodecs — RCE via crafted image files' },
      { id: 'CVE-2017-15293', cvss: 7.5, desc: 'Unauthorized access to RTSP streams without authentication' }
    ], attacks: [],
    threats: [
      { actor: 'opportunist', vector: 'Heap buffer overflow via crafted images — RCE on inference servers processing untrusted input' },
      { actor: 'supply-chain', vector: 'Native C++ code — malicious release with backdoor in image processing routines' }
    ], shape: 'circle' },
  { id: 'pyarrow',       label: 'PyArrow',          layer: 'base',      downloads: 200000000,  risk: 90, depRepos: 25000, maintainers: 'Apache Arrow (~20)', since: 2020,
    blast: '200M downloads/mo. Apache Arrow Python bindings. CVE-2023-47248 CVSS 9.8, EPSS 87% — RCE via any .parquet file. Foundation for Pandas 2.0+, HF datasets, Spark.',
    cves: [
      { id: 'CVE-2023-47248', cvss: 9.8, desc: 'Deserialization of untrusted data in IPC/Parquet/Feather → arbitrary code execution (EPSS 87.29%)' }
    ],
    attacks: [{ date: '2023', desc: 'CVE-2023-47248: actively exploited — RCE via .parquet/.feather/.arrow files. Versions 0.14.0–14.0.0' }],
    threats: [
      { actor: 'opportunist', vector: 'RCE via untrusted .parquet files — EPSS 87%, one of most exploited ML CVEs (CVE-2023-47248)' },
      { actor: 'supply-chain', vector: 'Foundation for Pandas/HF datasets/Spark — single CVE propagates to entire data pipeline' }
    ], shape: 'circle' },
  { id: 'pydantic',      label: 'Pydantic',         layer: 'base',      downloads: 370000000,  risk: 55, depRepos: 50000, maintainers: 'Samuel Colvin (~5)', since: 2020,
    blast: '370M downloads/mo. Data validation gate-keeper for FastAPI, LangChain, vLLM, OpenAI SDK. If pydantic is bypassed, all downstream validation fails.',
    cves: [], attacks: [],
    threats: [
      { actor: 'supply-chain', vector: 'Validation gate-keeper — compromise bypasses input validation in FastAPI/LangChain/vLLM/OpenAI SDK' },
      { actor: 'insider', vector: 'Small maintainer team (~5) for 370M monthly downloads — high concentration risk' }
    ], shape: 'circle' },
  { id: 'setuptools',    label: 'setuptools',       layer: 'base',      downloads: 300000000,  risk: 85, depRepos: 100000, maintainers: 'PyPA (~10)', since: 2020,
    blast: '300M downloads/mo. Python build system. setup.py install hooks = arbitrary code execution by design. Root vector for ALL pip install supply chain attacks.',
    cves: [], attacks: [
      { date: '2024', desc: 'setup.py install hooks — arbitrary code execution on pip install. Used in all malicious PyPI packages (Ultralytics, torchtriton, etc.)' }
    ],
    threats: [
      { actor: 'supply-chain', vector: 'ROOT attack vector — setup.py hooks execute arbitrary code during pip install. Used in every PyPI supply chain attack' },
      { actor: 'crime', vector: 'Malicious packages exploit setup.py for cryptomining, credential theft, reverse shells' }
    ], shape: 'circle' },
  // ── Enrichment: ML Frameworks ──
  { id: 'jax',           label: 'JAX',              layer: 'framework', downloads: 15000000,   risk: 68, depRepos: 5000,  maintainers: 'Google Brain (~20)', since: 2020,
    blast: '15M downloads/mo. Google ML framework with XLA compiler. Used for Gemini training. Separate Google ML stack branch not otherwise represented.',
    cves: [], attacks: [
      { date: '2024', desc: 'Pickle serialization by default for JAX arrays — same RCE vectors as PyTorch pickle' }
    ],
    threats: [
      { actor: 'supply-chain', vector: 'Parallel GPU stack (JAX → XLA → CUDA) — separate attack surface from PyTorch chain' },
      { actor: 'opportunist', vector: 'Default pickle serialization for model checkpoints — RCE via untrusted JAX models' }
    ], shape: 'circle' },
  { id: 'xgboost',       label: 'XGBoost',          layer: 'framework', downloads: 30000000,   risk: 70, depRepos: 8000,  maintainers: 'DMLC (~15)', since: 2020,
    blast: '30M downloads/mo. Dominant gradient boosting in production ML (banking, fintech, healthcare). Pickle model serialization → RCE.',
    cves: [
      { id: 'CVE-2024-37056', cvss: 8.5, desc: 'Deserialization of untrusted XGBoost/LightGBM models via MLflow → arbitrary code execution' }
    ],
    attacks: [{ date: '2024', desc: 'Pickle serialization of XGBoost models — RCE when loading untrusted .pkl model files in production' }],
    threats: [
      { actor: 'opportunist', vector: 'Pickle model deserialization → RCE in production banking/fintech/healthcare ML systems' },
      { actor: 'supply-chain', vector: 'Trojanized XGBoost models distributed via MLflow/model registries' }
    ], shape: 'circle' },
  { id: 'ultralytics',   label: 'Ultralytics',      layer: 'framework', downloads: 25000000,   risk: 88, depRepos: 10000, maintainers: 'Ultralytics Inc (~15)', since: 2023,
    blast: '25M downloads/mo. YOLOv8/v11 computer vision. 33K+ GitHub stars. Supply chain compromise Dec 2024 — XMRig cryptominer in official PyPI release via GitHub Actions CI/CD injection.',
    cves: [],
    attacks: [
      { date: '2024-12', desc: 'Supply chain compromise: versions 8.3.41/42/45/46 contained XMRig cryptominer. GitHub Actions script injection via malicious branch name. Fix version also compromised' }
    ],
    threats: [
      { actor: 'supply-chain', vector: 'Canonical ML supply chain attack — CI/CD pipeline compromise via GitHub Actions script injection' },
      { actor: 'crime', vector: 'Cryptomining via compromised official PyPI releases affecting 60M+ total downloads' }
    ], shape: 'circle' },
  // ── Enrichment: Serving & Infrastructure ──
  { id: 'fastapi',       label: 'FastAPI',          layer: 'serving',   downloads: 40000000,   risk: 80, depRepos: 50000, maintainers: 'Sebastián Ramírez (~5)', since: 2020,
    blast: '40M downloads/mo. THE Python web framework for ML serving. vLLM, BentoML, Gradio, LangServe, MLflow ALL built on FastAPI. Vulnerability here = vulnerability in all ML serving.',
    cves: [
      { id: 'CVE-2024-47874', cvss: 8.7, desc: 'Critical vulnerability in Starlette ASGI framework (base of FastAPI)' },
      { id: 'CVE-2024-24762', cvss: 7.5, desc: 'ReDoS in python-multipart — DoS via crafted Content-Type header' },
      { id: 'CVE-2025-68481', cvss: 8.1, desc: 'OAuth Account Takeover in FastAPI Users — unvalidated OAuth tokens' },
      { id: 'CVE-2025-14546', cvss: 7.5, desc: 'CSRF in fastapi-sso — improper OAuth state validation' }
    ], attacks: [],
    threats: [
      { actor: 'supply-chain', vector: 'Foundation for ALL ML serving (vLLM, BentoML, Gradio, MLflow) — single point of failure' },
      { actor: 'opportunist', vector: 'Starlette/ASGI vulnerabilities propagate to every FastAPI-based ML API' }
    ], shape: 'circle' },
  { id: 'sglang',        label: 'SGLang',           layer: 'serving',   downloads: 2000000,    risk: 82, depRepos: 1000,  maintainers: 'Berkeley (~15)', since: 2024,
    blast: 'Berkeley LLM inference server, vLLM competitor. ShadowMQ: same pickle/ZMQ vulnerability as vLLM — code literally copy-pasted. CVE-2025-10164 unsafe deserialization → RCE on GPU servers.',
    cves: [
      { id: 'CVE-2025-10164', cvss: 8.0, desc: 'Unsafe deserialization in /update_weights_from_tensor → RCE on GPU servers via pickle' }
    ],
    attacks: [
      { date: '2025', desc: 'ShadowMQ: pickle/ZMQ vulnerability propagated from vLLM via code copy-paste. Thousands of exposed ZMQ sockets on public internet' },
      { date: '2025', desc: 'KV-Cache Sharing Prompt Leakage (NDSS\'25): RadixAttention shared KV-cache allows cross-tenant prompt extraction in multi-tenant serving' }
    ],
    threats: [
      { actor: 'opportunist', vector: 'Pickle deserialization RCE via ZeroMQ (CVE-2025-10164) + multi-tenant prompt leakage' },
      { actor: 'supply-chain', vector: 'ShadowMQ demonstrates vulnerability propagation through code reuse between inference engines' }
    ], shape: 'circle' },
  { id: 'tgi',           label: 'TGI',              layer: 'serving',   downloads: 1000000,    risk: 68, depRepos: 2000,  maintainers: 'HuggingFace (~15)', since: 2023,
    blast: 'HuggingFace Text Generation Inference. Rust-based, Docker-delivered. KV-Cache sharing in multi-tenant deployments allows cross-tenant prompt leakage (NDSS\'25).',
    cves: [],
    attacks: [
      { date: '2025', desc: 'KV-Cache Sharing Prompt Leakage (NDSS\'25): shared KV-cache in multi-tenant serving allows cross-tenant prompt extraction' }
    ],
    threats: [
      { actor: 'supply-chain', vector: 'Docker image supply chain — container-level compromise of official HF inference server' },
      { actor: 'opportunist', vector: 'Multi-tenant prompt leakage via shared KV-cache + HF model loading attack surface' }
    ], shape: 'circle' },
  // ── Enrichment: Agents ──
  { id: 'ag2',           label: 'AG2',              layer: 'agents',    downloads: 500000,     risk: 72, depRepos: 1000,  maintainers: 'Linux Foundation (~20)', since: 2024,
    blast: 'AG2 (formerly Microsoft AutoGen). Enterprise multi-agent framework, Azure integration. Main risks: arbitrary code execution via agent code generation, tool calling injection.',
    cves: [], attacks: [],
    threats: [
      { actor: 'crime', vector: 'Arbitrary code execution via agent code generation in enterprise multi-agent workflows' },
      { actor: 'opportunist', vector: 'Tool calling injection — hijacking agent tool calls to execute malicious actions' }
    ], shape: 'circle' },
  { id: 'browser-use',   label: 'Browser Use',      layer: 'agents',    downloads: 500000,     risk: 78, depRepos: 500,   maintainers: '~10', since: 2024,
    blast: '50K+ GitHub stars. Browser automation agent. New attack surface: web content = indirect prompt injection → action execution in browser context.',
    cves: [], attacks: [
      { date: '2025', desc: 'Cyberhaven Labs: web page content triggers indirect prompt injection — "ChatGPT, navigate to X" redirects agentic browser' }
    ],
    threats: [
      { actor: 'opportunist', vector: 'Indirect prompt injection via web content → browser action execution (new agent attack class)' },
      { actor: 'crime', vector: 'Credential theft via agentic browser navigating to attacker-controlled pages' }
    ], shape: 'circle' },
  // ── Enrichment: Applications ──
  { id: 'streamlit',     label: 'Streamlit',        layer: 'app',       downloads: 30000000,   risk: 75, depRepos: 15000, maintainers: 'Snowflake (~20)', since: 2020,
    blast: '30M downloads/mo. ML app builder (Snowflake). Critical pyarrow dependency inherits CVE-2023-47248. Path traversal on Windows, arbitrary file upload bypass → cloud ATO.',
    cves: [
      { id: 'CVE-2024-42474', cvss: 5.9, desc: 'Path traversal on Windows via static file sharing → password hash leak' },
      { id: 'CVE-2025-1684', cvss: 8.8, desc: 'Arbitrary file upload bypass — server-side validation absent → SSH key overwrite → cloud ATO' }
    ],
    attacks: [{ date: '2025', desc: 'CVE-2025-1684: st.file_uploader client-side-only type check bypass → arbitrary file upload → cloud account takeover' }],
    threats: [
      { actor: 'opportunist', vector: 'File upload bypass → cloud account takeover via SSH key overwrite (CVE-2025-1684)' },
      { actor: 'supply-chain', vector: 'Critical pyarrow dependency chain — inherits CVE-2023-47248 CVSS 9.8 RCE via .parquet' }
    ], shape: 'circle' },
  { id: 'flowise',       label: 'Flowise',          layer: 'app',       downloads: 500000,     risk: 90, depRepos: 1000,  maintainers: '~10', since: 2023,
    blast: '30K+ GitHub stars. Visual LLM builder. Multiple critical CVEs: CVSS 9.8 unauthenticated ATO, RCE via MCP and Supabase, trivial auth bypass via case sensitivity.',
    cves: [
      { id: 'CVE-2025-58434', cvss: 9.8, desc: 'Unauthenticated password reset token disclosure → full account takeover' },
      { id: 'CVE-2024-31621', cvss: 8.1, desc: 'Authentication bypass via case sensitivity (/API/V1 vs /api/v1) — EPSS 60.74%' },
      { id: 'CVE-2025-26319', cvss: 8.0, desc: 'Arbitrary file upload via /api/v1/attachments' }
    ],
    attacks: [{ date: '2025', desc: 'GHSA-3gcm-f6qx-ff7p: RCE via CustomMCP node. GHSA-7944-7c6r-55vv: RCE via Supabase RPC Filter → execSync()' }],
    threats: [
      { actor: 'opportunist', vector: 'Trivial auth bypass (case sensitivity) + unauthenticated ATO (CVE-2025-58434 CVSS 9.8)' },
      { actor: 'crime', vector: 'RCE via MCP and Supabase integrations in visual LLM workflows' }
    ], shape: 'circle' },
  { id: 'chainlit',      label: 'Chainlit',         layer: 'app',       downloads: 1000000,    risk: 55, depRepos: 500,   maintainers: '~10', since: 2023,
    blast: '~1M downloads/mo. ChatGPT-like UI builder for LLM apps. Integrates with LangChain, LlamaIndex. UI layer for production LLM applications.',
    cves: [], attacks: [],
    threats: [
      { actor: 'supply-chain', vector: 'UI layer for LLM apps — compromise exposes all user interactions and API keys' },
      { actor: 'opportunist', vector: 'XSS or injection in chat UI affecting downstream LLM application users' }
    ], shape: 'circle' },
  // ── Enrichment v2: Serving ──
  { id: 'torchserve',    label: 'TorchServe',       layer: 'serving',   downloads: 2000000,    risk: 85, depRepos: 3000,  maintainers: 'PyTorch/Meta (~15)', since: 2020,
    blast: 'Official PyTorch model serving. Shelltorch (2023): Management API without auth on 0.0.0.0:8081 by default → trivial RCE. SSRF + SnakeYAML deserialization. Tens of thousands exposed on public internet.',
    cves: [],
    attacks: [
      { date: '2023-10', desc: 'Shelltorch (Oligo Security): Management API without auth exposed on 0.0.0.0:8081. SSRF + SnakeYAML deserialization \u2192 RCE. Tens of thousands of instances exposed' }
    ],
    threats: [
      { actor: 'opportunist', vector: 'Unauthenticated Management API \u2192 load malicious model from arbitrary URL \u2192 RCE on GPU server' },
      { actor: 'crime', vector: 'Mass exploitation of exposed TorchServe instances \u2014 model theft and data exfiltration' }
    ], shape: 'circle' },
  // ── Enrichment v2: Agents/Safety ──
  { id: 'guardrails-ai', label: 'Guardrails AI',    layer: 'agents',    downloads: 500000,     risk: 72, depRepos: 500,   maintainers: '~15', since: 2023,
    blast: 'LLM output validation and safety framework. If guardrails compromised \u2192 bypass ALL safety filters. Trust boundary between LLM output and downstream actions.',
    cves: [],
    attacks: [
      { date: '2024-09', desc: 'HiddenLayer: multiple vulnerabilities in validation logic. Arbitrary code execution via custom validator definitions' }
    ],
    threats: [
      { actor: 'supply-chain', vector: 'Compromised guardrails = bypass of all safety filters between LLM output and downstream actions' },
      { actor: 'opportunist', vector: 'Arbitrary code execution via custom validator definitions (HiddenLayer report)' }
    ], shape: 'circle' },
  // ── Enrichment: Hardware ──
  { id: 'amd-rocm',      label: 'AMD ROCm',         layer: 'hardware',  downloads: 0,          risk: 70, depRepos: 0,     maintainers: 'AMD', since: 2020,
    blast: 'AMD ROCm/MI300X — 8% AI training market. CUDA alternative with separate dependency chain. Used in large-scale deployments.',
    cves: [], attacks: [],
    threats: [
      { actor: 'nation-state', vector: 'Alternative hardware stack — separate supply chain risk from NVIDIA/CUDA' },
      { actor: 'supply-chain', vector: 'ROCm toolkit and driver supply chain — independent from CUDA but same attack patterns' }
    ], shape: 'hex' },
  // ── Enrichment: Vector Databases ──
  { id: 'chromadb', label: 'ChromaDB', layer: 'vectordb', downloads: 4000000, risk: 78, depRepos: 3000, maintainers: 'Chroma Inc (~15)', since: 2023,
    blast: '4M downloads/mo. Embedded vector DB for RAG. CVE-2024-6834 path traversal. Many instances run without authentication.',
    cves: [
      { id: 'CVE-2024-6834', cvss: 7.5, desc: 'Path traversal — arbitrary file read via crafted collection names' }
    ],
    attacks: [],
    threats: [
      { actor: 'opportunist', vector: 'Path traversal on unauthenticated ChromaDB instances used in RAG pipelines' },
      { actor: 'crime', vector: 'Data exfiltration from RAG knowledge bases containing confidential documents' }
    ], shape: 'circle' },
  { id: 'milvus', label: 'Milvus', layer: 'vectordb', downloads: 2000000, risk: 80, depRepos: 2000, maintainers: 'Zilliz (~30)', since: 2023,
    blast: '2M downloads/mo. Production vector DB (Zilliz). CVE-2024-45750 RCE, CVE-2024-37035. Used in enterprise RAG deployments.',
    cves: [
      { id: 'CVE-2024-45750', cvss: 9.0, desc: 'Remote code execution via crafted search request' },
      { id: 'CVE-2024-37035', cvss: 7.5, desc: 'Authentication bypass — unauthorized access to vector collections' }
    ],
    attacks: [],
    threats: [
      { actor: 'opportunist', vector: 'RCE via crafted search request (CVE-2024-45750 CVSS 9.0)' },
      { actor: 'crime', vector: 'Unauthorized access to enterprise vector stores containing proprietary embeddings' }
    ], shape: 'circle' },
  { id: 'qdrant', label: 'Qdrant', layer: 'vectordb', downloads: 7000000, risk: 72, depRepos: 2000, maintainers: 'Qdrant (~20)', since: 2023,
    blast: '7M downloads/mo. Rust vector DB. API without authentication by default. Growing rapidly in production RAG deployments.',
    cves: [],
    attacks: [],
    threats: [
      { actor: 'opportunist', vector: 'Default no-auth API — any exposed instance allows full read/write to vector collections' },
      { actor: 'crime', vector: 'Mass scanning for exposed Qdrant instances to extract RAG knowledge bases' }
    ], shape: 'circle' },
  { id: 'weaviate', label: 'Weaviate', layer: 'vectordb', downloads: 1500000, risk: 68, depRepos: 1000, maintainers: 'Weaviate (~30)', since: 2023,
    blast: '1.5M downloads/mo. Vector DB with SSRF and auth bypass history. Multi-modal search engine.',
    cves: [],
    attacks: [],
    threats: [
      { actor: 'opportunist', vector: 'SSRF and authentication bypass in multi-tenant vector search deployments' },
      { actor: 'supply-chain', vector: 'Compromised module integrations in Weaviate plugin ecosystem' }
    ], shape: 'circle' },
  { id: 'faiss', label: 'FAISS', layer: 'vectordb', downloads: 40000000, risk: 75, depRepos: 5000, maintainers: 'Meta AI (~10)', since: 2020,
    blast: '40M downloads/mo. Meta similarity search. Pickle deserialization for index files — faiss.read_index() on untrusted files = RCE.',
    cves: [],
    attacks: [
      { date: '2025', desc: 'faiss.read_index() uses pickle deserialization — RCE via crafted .faiss index files' }
    ],
    threats: [
      { actor: 'opportunist', vector: 'Pickle deserialization RCE via untrusted .faiss index files (faiss.read_index)' },
      { actor: 'supply-chain', vector: 'Trojanized FAISS indexes distributed via model hubs and shared datasets' }
    ], shape: 'circle' },
  { id: 'pgvector', label: 'pgvector', layer: 'vectordb', downloads: 5000000, risk: 60, depRepos: 3000, maintainers: 'Andrew Kane + community (~5)', since: 2023,
    blast: '5M downloads/mo. PostgreSQL vector extension. Inherits entire PostgreSQL attack surface + SQL injection in vector queries.',
    cves: [],
    attacks: [],
    threats: [
      { actor: 'opportunist', vector: 'SQL injection via unsanitized vector search queries — inherits full PostgreSQL attack surface' },
      { actor: 'insider', vector: 'Small maintainer team (~5) for widely deployed PostgreSQL extension' }
    ], shape: 'circle' },
  // ── Enrichment: MCP Ecosystem ──
  { id: 'mcp-sdk', label: 'MCP SDK', layer: 'agents', downloads: 500000, risk: 85, depRepos: 1000, maintainers: 'Anthropic (~10)', since: 2024,
    blast: 'Model Context Protocol SDK. CVE-2025-6514 mcp-remote RCE (CVSS 9.6, 437K downloads). CVE-2025-49596 Inspector DNS rebinding (CVSS 9.4). Foundation for all MCP tool integrations.',
    cves: [
      { id: 'CVE-2025-6514', cvss: 9.6, desc: 'mcp-remote: RCE via malicious MCP server response — arbitrary code execution on client (437K downloads)' },
      { id: 'CVE-2025-49596', cvss: 9.4, desc: 'MCP Inspector: browser-based RCE via DNS rebinding + CSRF' },
      { id: 'CVE-2025-53109', cvss: 8.0, desc: 'Filesystem MCP Server: symlink sandbox escape — access files outside allowed directories' },
      { id: 'CVE-2025-53110', cvss: 7.5, desc: 'Filesystem MCP Server: directory containment bypass' }
    ],
    attacks: [
      { date: '2025-04', desc: 'Invariant Labs: MCP tool poisoning via hidden instructions in tool descriptions. 43% of MCP implementations had command injection. WhatsApp histories, SSH keys, GitHub repos exfiltrated' },
      { date: '2025', desc: 'CVE-2025-52882: WebSocket auth bypass in Claude Code extensions (CVSS 8.8)' }
    ],
    threats: [
      { actor: 'supply-chain', vector: 'Malicious MCP servers — tool descriptions contain hidden prompt injection payloads' },
      { actor: 'opportunist', vector: 'mcp-remote RCE (CVE-2025-6514 CVSS 9.6) + Inspector DNS rebinding (CVE-2025-49596 CVSS 9.4)' }
    ], shape: 'circle' },
  // ── Enrichment: Serving / Inference ──
  { id: 'tensorrt-llm', label: 'TensorRT-LLM', layer: 'serving', downloads: 3000000, risk: 82, depRepos: 2000, maintainers: 'NVIDIA (~20)', since: 2023,
    blast: 'NVIDIA LLM inference optimization. ShadowMQ: CVE-2025-23254 (CVSS 8.8) pickle/ZMQ vulnerability propagated from vLLM via code copy-paste.',
    cves: [
      { id: 'CVE-2025-23254', cvss: 8.8, desc: 'Unsafe pickle deserialization via ZeroMQ — RCE on inference servers (ShadowMQ propagation)' }
    ],
    attacks: [
      { date: '2025', desc: 'ShadowMQ: pickle/ZMQ vulnerability propagated from vLLM via code copy-paste to TensorRT-LLM' }
    ],
    threats: [
      { actor: 'supply-chain', vector: 'ShadowMQ demonstrates vulnerability propagation through code reuse between NVIDIA inference engines' },
      { actor: 'opportunist', vector: 'Pickle deserialization RCE via ZeroMQ (CVE-2025-23254 CVSS 8.8)' }
    ], shape: 'circle' },
  { id: 'localai', label: 'LocalAI', layer: 'serving', downloads: 500000, risk: 78, depRepos: 1000, maintainers: '~10', since: 2023,
    blast: '25K+ GitHub stars. Local inference server. Affected by CVE-2024-34359 (GGUF Jinja2 template injection). Drop-in OpenAI API replacement.',
    cves: [],
    attacks: [
      { date: '2024', desc: 'Affected by CVE-2024-34359: GGUF metadata Jinja2 template injection → RCE via crafted model files' }
    ],
    threats: [
      { actor: 'supply-chain', vector: 'GGUF models with Jinja2 payload in metadata — RCE on local inference (CVE-2024-34359 propagation)' },
      { actor: 'opportunist', vector: 'Drop-in OpenAI API replacement often deployed without additional security hardening' }
    ], shape: 'circle' },
  { id: 'gpt4all', label: 'GPT4All', layer: 'serving', downloads: 500000, risk: 72, depRepos: 1000, maintainers: 'Nomic AI (~15)', since: 2023,
    blast: '70K+ GitHub stars. Desktop LLM client. Affected by llama.cpp GGUF CVEs. Targets non-technical users with minimal security awareness.',
    cves: [],
    attacks: [
      { date: '2024', desc: 'Inherits all llama.cpp GGUF parser vulnerabilities — heap overflow, path traversal, Jinja2 injection' }
    ],
    threats: [
      { actor: 'supply-chain', vector: 'Malicious GGUF models targeting non-technical desktop users via model download UI' },
      { actor: 'opportunist', vector: 'Inherited llama.cpp CVEs in GGUF parser (CVE-2024-42479, CVE-2024-34359)' }
    ], shape: 'circle' },
  { id: 'triton-server', label: 'Triton Server', layer: 'serving', downloads: 2000000, risk: 78, depRepos: 3000, maintainers: 'NVIDIA (~20)', since: 2020,
    blast: 'NVIDIA Triton Inference Server (distinct from OpenAI Triton compiler). Docker-delivered. Custom backend loading — arbitrary shared library execution by design.',
    cves: [],
    attacks: [],
    threats: [
      { actor: 'supply-chain', vector: 'Custom model backends (.so/.dll) loaded at runtime — arbitrary native code execution by design' },
      { actor: 'crime', vector: 'Name confusion with OpenAI Triton compiler — typosquatting and misdirection attacks' }
    ], shape: 'circle' },
  // ── Enrichment: Base Libraries ──
  { id: 'tiktoken', label: 'tiktoken', layer: 'base', downloads: 130000000, risk: 55, depRepos: 20000, maintainers: 'OpenAI (~5)', since: 2023,
    blast: '130M downloads/mo. OpenAI BPE tokenizer (Rust core). Used by OpenAI SDK, LangChain, LiteLLM, LlamaIndex for token counting.',
    cves: [],
    attacks: [],
    threats: [
      { actor: 'supply-chain', vector: '130M downloads — compromised release would affect all OpenAI-integrated applications' },
      { actor: 'insider', vector: 'Small maintainer team (~5) for widely deployed tokenizer' }
    ], shape: 'circle' },
  { id: 'h5py', label: 'h5py', layer: 'base', downloads: 50000000, risk: 65, depRepos: 15000, maintainers: '~10', since: 2020,
    blast: '50M downloads/mo. HDF5 Python bindings. Keras .h5 models = h5py + pickle. C extension with historical buffer overflow CVEs.',
    cves: [],
    attacks: [],
    threats: [
      { actor: 'supply-chain', vector: 'Foundation for Keras .h5 model format — compromise propagates to all legacy Keras model loading' },
      { actor: 'opportunist', vector: 'C extension with historical buffer overflow patterns in HDF5 parsing' }
    ], shape: 'circle' },
  { id: 'cloudpickle', label: 'cloudpickle', layer: 'base', downloads: 40000000, risk: 80, depRepos: 10000, maintainers: '~5', since: 2020,
    blast: '40M downloads/mo. Extended pickle used by Ray, Dask, Spark, MLflow for serialization. Extended pickle = extended RCE surface.',
    cves: [],
    attacks: [
      { date: '2025', desc: 'cloudpickle extends pickle with cross-process serialization — all pickle RCE vectors apply with broader scope' }
    ],
    threats: [
      { actor: 'supply-chain', vector: 'Core serialization library for Ray/Dask/Spark — compromise = RCE across all distributed compute' },
      { actor: 'insider', vector: 'Only ~5 maintainers for 40M monthly downloads of extended pickle' }
    ], shape: 'circle' },
  { id: 'sentencepiece', label: 'sentencepiece', layer: 'base', downloads: 30000000, risk: 60, depRepos: 5000, maintainers: 'Google (~5)', since: 2020,
    blast: '30M downloads/mo. Google tokenizer (C++ native). Used by T5, LLaMA, Gemma. C++ native code = buffer overflow risk on crafted .model files.',
    cves: [],
    attacks: [],
    threats: [
      { actor: 'opportunist', vector: 'C++ native code — buffer overflow potential via crafted .model tokenizer files' },
      { actor: 'supply-chain', vector: 'Compromised tokenizer model files could inject subtle data corruption into NLP pipelines' }
    ], shape: 'circle' },
  // ── Enrichment: ML Frameworks ──
  { id: 'sentence-transformers', label: 'sentence-transformers', layer: 'framework', downloads: 30000000, risk: 65, depRepos: 8000, maintainers: 'UKP Lab (~10)', since: 2020,
    blast: '30M downloads/mo. Embedding models for semantic search and RAG. Depends on transformers + HF Hub. Models loaded via trust_remote_code.',
    cves: [],
    attacks: [],
    threats: [
      { actor: 'supply-chain', vector: 'Malicious embedding models on HF Hub — trust_remote_code in sentence-transformers model loading' },
      { actor: 'crime', vector: 'Backdoored embedding models producing biased similarity scores in RAG pipelines' }
    ], shape: 'circle' },
  { id: 'lightgbm', label: 'LightGBM', layer: 'framework', downloads: 15000000, risk: 68, depRepos: 6000, maintainers: 'Microsoft (~15)', since: 2020,
    blast: '15M downloads/mo. Microsoft gradient boosting. Pickle model serialization → RCE. Used in fintech, banking, healthcare alongside XGBoost.',
    cves: [
      { id: 'CVE-2024-37056', cvss: 8.5, desc: 'Deserialization of untrusted LightGBM models via MLflow → arbitrary code execution' }
    ],
    attacks: [],
    threats: [
      { actor: 'opportunist', vector: 'Pickle model deserialization → RCE in production ML systems (same vector as XGBoost)' },
      { actor: 'supply-chain', vector: 'Trojanized LightGBM models distributed via MLflow/model registries' }
    ], shape: 'circle' },
  { id: 'timm', label: 'timm', layer: 'framework', downloads: 10000000, risk: 62, depRepos: 4000, maintainers: 'Ross Wightman (~3)', since: 2020,
    blast: '10M downloads/mo. PyTorch Image Models — 1200+ pretrained models. Single primary maintainer for 10M monthly downloads.',
    cves: [],
    attacks: [],
    threats: [
      { actor: 'insider', vector: 'Single primary maintainer for 1200+ pretrained vision models and 10M monthly downloads' },
      { actor: 'supply-chain', vector: 'Trojanized pretrained vision models (1200+ available) on HF Hub' }
    ], shape: 'circle' },
  { id: 'spacy', label: 'spaCy', layer: 'framework', downloads: 10000000, risk: 62, depRepos: 5000, maintainers: 'Explosion (~15)', since: 2020,
    blast: '10M downloads/mo. NLP pipeline with custom model loading and arbitrary Python component execution.',
    cves: [],
    attacks: [],
    threats: [
      { actor: 'supply-chain', vector: 'Custom pipeline components execute arbitrary Python — malicious spaCy models = RCE' },
      { actor: 'opportunist', vector: 'Model package installation via pip runs setup.py hooks — same as PyPI supply chain vector' }
    ], shape: 'circle' },
  // ── Enrichment: Agents ──
  { id: 'openai-agents', label: 'OpenAI Agents SDK', layer: 'agents', downloads: 1000000, risk: 72, depRepos: 500, maintainers: 'OpenAI (~10)', since: 2025,
    blast: 'OpenAI Agents SDK (Q1 2025). Tool calls without sandbox by default. Handoffs between agents can propagate compromised context.',
    cves: [],
    attacks: [],
    threats: [
      { actor: 'opportunist', vector: 'Tool calls without sandbox — prompt injection → arbitrary tool execution' },
      { actor: 'supply-chain', vector: 'Malicious tools in OpenAI tool ecosystem can execute during agent handoffs' }
    ], shape: 'circle' },
  { id: 'semantic-kernel', label: 'Semantic Kernel', layer: 'agents', downloads: 500000, risk: 65, depRepos: 1000, maintainers: 'Microsoft (~20)', since: 2023,
    blast: 'Microsoft enterprise agent framework. Azure integration. Plugin system allows arbitrary code execution via skill loading.',
    cves: [],
    attacks: [],
    threats: [
      { actor: 'supply-chain', vector: 'Malicious plugins in Semantic Kernel plugin ecosystem — arbitrary code execution via skill loading' },
      { actor: 'crime', vector: 'Enterprise credential harvesting via Azure-integrated agent workflows' }
    ], shape: 'circle' },
  // ── Enrichment: Applications ──
  { id: 'anythingllm', label: 'AnythingLLM', layer: 'app', downloads: 500000, risk: 75, depRepos: 500, maintainers: 'Mintplex Labs (~10)', since: 2023,
    blast: '180K+ GitHub stars. Self-hosted RAG platform. Path traversal, SSRF, and auth bypass CVE history.',
    cves: [
      { id: 'CVE-2024-13059', cvss: 8.1, desc: 'Path traversal — arbitrary file read via document processing' },
      { id: 'CVE-2024-13060', cvss: 7.5, desc: 'SSRF — server-side request forgery via URL import functionality' }
    ],
    attacks: [],
    threats: [
      { actor: 'opportunist', vector: 'Path traversal and SSRF on self-hosted RAG instances (CVE-2024-13059)' },
      { actor: 'crime', vector: 'Data exfiltration from private document RAG deployments' }
    ], shape: 'circle' },
];

// Edges: source DEPENDS ON target (arrow from source → target)
const EDGES = [
  // Everything → numpy
  { source: 'scipy',        target: 'numpy' },
  { source: 'pandas',       target: 'numpy' },
  { source: 'pytorch',      target: 'numpy' },
  { source: 'tensorflow',   target: 'numpy' },
  { source: 'transformers', target: 'numpy' },
  { source: 'datasets',     target: 'numpy' },
  { source: 'onnx',         target: 'numpy' },
  { source: 'vllm',         target: 'numpy' },
  { source: 'accelerate',   target: 'numpy' },
  // Frameworks → CUDA
  { source: 'pytorch',      target: 'cuda' },
  { source: 'tensorflow',   target: 'cuda' },
  // HF cluster → hf-hub + pytorch
  { source: 'transformers', target: 'hf-hub' },
  { source: 'transformers', target: 'pytorch' },
  { source: 'transformers', target: 'tokenizers' },
  { source: 'transformers', target: 'safetensors' },
  { source: 'tokenizers',   target: 'hf-hub' },
  // safetensors is standalone (zero Python deps), no edge to hf-hub
  { source: 'datasets',     target: 'hf-hub' },
  { source: 'accelerate',   target: 'pytorch' },
  { source: 'accelerate',   target: 'hf-hub' },
  { source: 'diffusers',    target: 'transformers' },
  { source: 'diffusers',    target: 'pytorch' },
  { source: 'diffusers',    target: 'hf-hub' },
  { source: 'diffusers',    target: 'safetensors' },
  { source: 'diffusers',    target: 'accelerate' },
  { source: 'diffusers',    target: 'pillow' },
  { source: 'peft',         target: 'transformers' },
  { source: 'peft',         target: 'pytorch' },
  { source: 'peft',         target: 'hf-hub' },
  { source: 'peft',         target: 'accelerate' },
  // vLLM
  { source: 'vllm',         target: 'pytorch' },
  { source: 'vllm',         target: 'transformers' },
  { source: 'vllm',         target: 'triton' },
  { source: 'vllm',         target: 'cuda' },
  { source: 'vllm',         target: 'hf-hub' },
  { source: 'vllm',         target: 'safetensors' },
  // Triton + pytorch → triton (torchtriton — inc1 attack vector)
  { source: 'pytorch',      target: 'triton' },
  { source: 'triton',       target: 'cuda' },
  // ONNX
  { source: 'onnx',         target: 'pytorch' },
  // Hardware chain
  { source: 'cuda',         target: 'tsmc' },
  { source: 'tsmc',         target: 'asml' },
  // LangChain (LLM-agnostic: no hard deps on transformers/pytorch)
  { source: 'langchain',    target: 'hf-hub' },  // via optional langchain-huggingface
  // scipy → pandas
  { source: 'pandas',       target: 'scipy' },
  // scikit-learn
  { source: 'scikit-learn', target: 'numpy' },
  { source: 'scikit-learn', target: 'scipy' },
  // keras
  { source: 'keras',        target: 'tensorflow' },
  { source: 'keras',        target: 'numpy' },
  // pillow
  { source: 'pillow',       target: 'numpy' },
  // matplotlib
  { source: 'matplotlib',   target: 'numpy' },
  // trl
  { source: 'trl',          target: 'transformers' },
  { source: 'trl',          target: 'pytorch' },
  { source: 'trl',          target: 'hf-hub' },
  { source: 'trl',          target: 'peft' },
  { source: 'trl',          target: 'accelerate' },
  { source: 'trl',          target: 'datasets' },
  // Ollama
  { source: 'ollama',       target: 'llama-cpp' },
  { source: 'ollama',       target: 'cuda' },
  // llama.cpp
  { source: 'llama-cpp',    target: 'cuda' },
  // MLflow
  { source: 'mlflow',       target: 'pytorch' },
  { source: 'mlflow',       target: 'tensorflow' },
  { source: 'mlflow',       target: 'numpy' },
  { source: 'mlflow',       target: 'hf-hub' },
  // Jupyter
  { source: 'jupyter',      target: 'numpy' },
  { source: 'jupyter',      target: 'scipy' },
  { source: 'jupyter',      target: 'pandas' },
  { source: 'jupyter',      target: 'matplotlib' },
  // Dask
  { source: 'dask',         target: 'numpy' },
  { source: 'dask',         target: 'scipy' },
  { source: 'dask',         target: 'pandas' },
  // Langflow
  { source: 'langflow',     target: 'langchain' },
  { source: 'langflow',     target: 'transformers' },
  { source: 'langflow',     target: 'hf-hub' },
  // Dify (removed LangChain from codebase; uses own framework + LiteLLM)
  { source: 'dify',         target: 'litellm' },
  { source: 'dify',         target: 'ollama' },
  // Gradio (UI framework; no hard dep on transformers/pytorch)
  { source: 'gradio',       target: 'hf-hub' },
  { source: 'gradio',       target: 'numpy' },
  { source: 'gradio',       target: 'pillow' },
  // Ray
  { source: 'ray',          target: 'pytorch' },
  { source: 'ray',          target: 'numpy' },
  { source: 'ray',          target: 'cuda' },
  // W&B
  { source: 'wandb',        target: 'pytorch' },
  { source: 'wandb',        target: 'tensorflow' },
  { source: 'wandb',        target: 'numpy' },
  { source: 'wandb',        target: 'hf-hub' },
  // LlamaIndex
  { source: 'llamaindex',   target: 'langchain' },
  { source: 'llamaindex',   target: 'transformers' },
  { source: 'llamaindex',   target: 'hf-hub' },
  { source: 'llamaindex',   target: 'pytorch' },
  // CrewAI (independent since v0.175+, uses LiteLLM for multi-provider LLM)
  { source: 'crewai',       target: 'litellm' },
  // AutoGPT (API-based, no pytorch; historical langchain integration)
  { source: 'autogpt',      target: 'langchain' },
  // n8n (Node.js app; connects to Python services via API)
  { source: 'n8n',          target: 'ollama' },  // n8n Ollama integration node
  // Haystack
  { source: 'haystack',     target: 'transformers' },
  { source: 'haystack',     target: 'hf-hub' },
  { source: 'haystack',     target: 'pytorch' },
  // MetaGPT (API-based; optional transformers via extras)
  { source: 'metagpt',      target: 'transformers' },  // optional extra
  // LiteLLM (API proxy; uses tokenizers for token counting, not full transformers)
  { source: 'litellm',      target: 'tokenizers' },
  { source: 'litellm',      target: 'hf-hub' },  // transitive via tokenizers
  // BentoML
  { source: 'bentoml',      target: 'pytorch' },
  { source: 'bentoml',      target: 'transformers' },
  { source: 'bentoml',      target: 'numpy' },
  // Kubeflow
  { source: 'kubeflow',     target: 'pytorch' },
  { source: 'kubeflow',     target: 'tensorflow' },
  { source: 'kubeflow',     target: 'mlflow' },
  // smolagents
  { source: 'smolagents',   target: 'transformers' },
  { source: 'smolagents',   target: 'hf-hub' },
  { source: 'smolagents',   target: 'pytorch' },
  // DeepSpeed
  { source: 'deepspeed',    target: 'pytorch' },
  { source: 'deepspeed',    target: 'cuda' },
  { source: 'deepspeed',    target: 'numpy' },
  // LibreChat
  { source: 'librechat',    target: 'langchain' },
  { source: 'librechat',    target: 'ollama' },
  { source: 'librechat',    target: 'hf-hub' },
  // Open WebUI
  { source: 'open-webui',   target: 'ollama' },
  { source: 'open-webui',   target: 'hf-hub' },
  { source: 'open-webui',   target: 'langchain' },
  // Composio (core has no langchain/transformers dep; optional integrations only)
  { source: 'composio',     target: 'hf-hub' },  // optional integration
  // LLM Provider SDKs (standalone HTTP clients — other packages depend ON them)
  { source: 'litellm',      target: 'openai-sdk' },   // litellm uses openai SDK as core dep
  { source: 'crewai',       target: 'openai-sdk' },   // crewai uses openai as default provider
  { source: 'autogpt',      target: 'openai-sdk' },   // AutoGPT uses openai SDK
  { source: 'metagpt',      target: 'openai-sdk' },   // MetaGPT uses openai SDK
  { source: 'dify',         target: 'openai-sdk' },   // Dify supports OpenAI-compatible APIs
  { source: 'haystack',     target: 'openai-sdk' },   // Haystack has openai integration
  { source: 'langflow',     target: 'openai-sdk' },   // via langchain-openai
  { source: 'llamaindex',   target: 'openai-sdk' },   // LlamaIndex uses openai as default LLM
  { source: 'litellm',      target: 'anthropic-sdk' }, // litellm proxies to Anthropic
  { source: 'litellm',      target: 'cohere-sdk' },   // litellm proxies to Cohere
  { source: 'litellm',      target: 'mistralai-sdk' },// litellm proxies to Mistral
  { source: 'litellm',      target: 'groq-sdk' },     // litellm proxies to Groq
  { source: 'gigachat-sdk', target: 'hf-hub' },       // GigaChain ecosystem
  { source: 'gigachat-sdk', target: 'langchain' },    // langchain-gigachat integration
  // ── Enrichment: Missing edges for EXISTING nodes ──
  { source: 'langchain',    target: 'openai-sdk' },   // langchain-openai primary LLM provider
  { source: 'langchain',    target: 'anthropic-sdk' }, // langchain-anthropic integration
  { source: 'vllm',         target: 'ray' },           // distributed inference via Ray clusters
  { source: 'n8n',          target: 'langchain' },     // LangChain integration node in n8n
  { source: 'dify',         target: 'hf-hub' },        // model loading via HuggingFace Hub
  { source: 'gradio',       target: 'transformers' },  // canonical transformers.pipeline + gradio.Interface
  { source: 'scikit-learn', target: 'pandas' },        // common data loading dependency
  // ── Enrichment: New node edges — protobuf ──
  { source: 'tensorflow',   target: 'protobuf' },     // TF serialization format
  { source: 'onnx',         target: 'protobuf' },     // ONNX model format
  { source: 'vllm',         target: 'protobuf' },     // gRPC/serialization
  { source: 'triton',       target: 'protobuf' },     // Triton model config
  // ── opencv-python ──
  { source: 'opencv-python', target: 'numpy' },       // core numerical dep
  // ── pyarrow ──
  { source: 'pyarrow',      target: 'numpy' },        // core numerical dep
  { source: 'datasets',     target: 'pyarrow' },      // HF datasets uses Arrow format
  { source: 'pandas',       target: 'pyarrow' },      // Pandas 2.0+ uses pyarrow backend
  // ── pydantic ──
  { source: 'fastapi',      target: 'pydantic' },     // FastAPI built on pydantic
  { source: 'langchain',    target: 'pydantic' },     // LangChain uses pydantic models
  { source: 'vllm',         target: 'pydantic' },     // vLLM API uses pydantic
  { source: 'openai-sdk',   target: 'pydantic' },     // OpenAI SDK uses pydantic models
  // ── jax ──
  { source: 'jax',          target: 'cuda' },         // GPU backend
  { source: 'jax',          target: 'numpy' },        // core numerical dep
  { source: 'jax',          target: 'scipy' },        // optimization algorithms
  { source: 'jax',          target: 'amd-rocm' },     // ROCm backend
  // ── xgboost ──
  { source: 'xgboost',      target: 'numpy' },        // core numerical dep
  { source: 'xgboost',      target: 'scipy' },        // optimization algorithms
  { source: 'xgboost',      target: 'mlflow' },       // model tracking/registry
  // ── ultralytics ──
  { source: 'ultralytics',  target: 'pytorch' },      // YOLO built on PyTorch
  { source: 'ultralytics',  target: 'opencv-python' },// image processing
  { source: 'ultralytics',  target: 'numpy' },        // core numerical dep
  // ── fastapi (others depend on it) ──
  { source: 'vllm',         target: 'fastapi' },      // vLLM API server built on FastAPI
  { source: 'gradio',       target: 'fastapi' },      // Gradio server built on FastAPI
  { source: 'bentoml',      target: 'fastapi' },      // BentoML HTTP server uses FastAPI
  { source: 'mlflow',       target: 'fastapi' },      // MLflow model serving
  { source: 'langflow',     target: 'fastapi' },      // Langflow API built on FastAPI
  // ── sglang ──
  { source: 'sglang',       target: 'pytorch' },      // SGLang inference on PyTorch
  { source: 'sglang',       target: 'cuda' },         // GPU inference
  { source: 'sglang',       target: 'transformers' }, // model loading
  // ── tgi ──
  { source: 'tgi',          target: 'transformers' }, // HF model support
  { source: 'tgi',          target: 'hf-hub' },       // model loading from Hub
  { source: 'tgi',          target: 'safetensors' },  // safe model format
  // ── ag2 ──
  { source: 'ag2',          target: 'openai-sdk' },   // primary LLM provider
  { source: 'ag2',          target: 'anthropic-sdk' },// Claude integration
  { source: 'ag2',          target: 'langchain' },    // agent orchestration
  // ── browser_use ──
  { source: 'browser-use',  target: 'openai-sdk' },   // LLM provider
  { source: 'browser-use',  target: 'anthropic-sdk' },// LLM provider
  { source: 'browser-use',  target: 'langchain' },    // agent framework
  // ── streamlit ──
  { source: 'streamlit',    target: 'pyarrow' },      // critical data dependency
  { source: 'streamlit',    target: 'numpy' },        // data processing
  // ── flowise ──
  { source: 'flowise',      target: 'langchain' },    // workflow builder for LangChain
  { source: 'flowise',      target: 'openai-sdk' },   // LLM provider
  { source: 'flowise',      target: 'hf-hub' },       // model loading
  // ── chainlit ──
  { source: 'chainlit',     target: 'langchain' },    // agent framework
  { source: 'chainlit',     target: 'llamaindex' },   // RAG framework
  { source: 'chainlit',     target: 'openai-sdk' },   // LLM provider
  // ── amd-rocm ──
  { source: 'pytorch',      target: 'amd-rocm' },     // ROCm backend for PyTorch
  { source: 'amd-rocm',     target: 'tsmc' },         // AMD chips manufactured by TSMC
  // ── Enrichment v2: new edges ──
  { source: 'llama-cpp',    target: 'hf-hub' },       // GGUF models hosted on HF Hub
  { source: 'torchserve',   target: 'pytorch' },      // official PyTorch serving
  { source: 'guardrails-ai', target: 'openai-sdk' },  // LLM provider integration
  { source: 'guardrails-ai', target: 'langchain' },   // agent framework integration
  { source: 'guardrails-ai', target: 'anthropic-sdk' },// Claude integration
  { source: 'hf-hub',       target: 'safetensors' },  // primary safe format on HF Hub
  // ── Enrichment: Vector Database edges ──
  { source: 'chromadb',    target: 'numpy' },
  { source: 'milvus',      target: 'numpy' },
  { source: 'faiss',       target: 'numpy' },
  { source: 'langchain',    target: 'chromadb' },  // default vector store
  { source: 'langchain',    target: 'faiss' },     // FAISS integration
  { source: 'langchain',    target: 'qdrant' },    // Qdrant integration
  { source: 'langchain',    target: 'pgvector' },  // pgvector integration
  { source: 'langchain',    target: 'milvus' },    // Milvus integration
  { source: 'langchain',    target: 'weaviate' },  // Weaviate integration
  { source: 'llamaindex',   target: 'chromadb' },  // default vector store
  { source: 'llamaindex',   target: 'faiss' },
  { source: 'llamaindex',   target: 'qdrant' },
  { source: 'llamaindex',   target: 'milvus' },
  { source: 'haystack',     target: 'qdrant' },
  { source: 'haystack',     target: 'weaviate' },
  { source: 'dify',         target: 'qdrant' },
  { source: 'dify',         target: 'weaviate' },
  { source: 'anythingllm',  target: 'chromadb' },
  { source: 'anythingllm',  target: 'qdrant' },
  // ── Enrichment: MCP edges ──
  { source: 'mcp-sdk',        target: 'anthropic-sdk' },  // Anthropic MCP protocol
  { source: 'langchain',      target: 'mcp-sdk' },        // LangChain MCP integration
  { source: 'flowise',        target: 'mcp-sdk' },        // Flowise MCP nodes
  { source: 'crewai',         target: 'mcp-sdk' },        // CrewAI MCP tools
  { source: 'ag2',            target: 'mcp-sdk' },        // AG2 MCP integration
  // ── Enrichment: Serving edges ──
  { source: 'tensorrt-llm',   target: 'cuda' },
  { source: 'tensorrt-llm',   target: 'pytorch' },
  { source: 'tensorrt-llm',   target: 'transformers' },
  { source: 'localai',        target: 'llama-cpp' },
  { source: 'localai',        target: 'cuda' },
  { source: 'gpt4all',        target: 'llama-cpp' },
  { source: 'triton-server',  target: 'cuda' },
  { source: 'triton-server',  target: 'pytorch' },
  { source: 'triton-server',  target: 'tensorflow' },
  { source: 'triton-server',  target: 'onnx' },
  // ── Enrichment: Base library edges ──
  { source: 'tiktoken',       target: 'numpy' },
  { source: 'openai-sdk',     target: 'tiktoken' },   // token counting
  { source: 'litellm',        target: 'tiktoken' },   // token counting
  { source: 'langchain',      target: 'tiktoken' },   // token counting
  { source: 'h5py',           target: 'numpy' },
  { source: 'keras',          target: 'h5py' },        // .h5 model format
  { source: 'cloudpickle',    target: 'numpy' },       // extended pickle
  { source: 'ray',            target: 'cloudpickle' }, // distributed serialization
  { source: 'dask',           target: 'cloudpickle' }, // distributed serialization
  { source: 'mlflow',         target: 'cloudpickle' }, // model serialization
  // ── Enrichment: Framework edges ──
  { source: 'sentence-transformers', target: 'transformers' },
  { source: 'sentence-transformers', target: 'hf-hub' },
  { source: 'sentence-transformers', target: 'pytorch' },
  { source: 'lightgbm',       target: 'numpy' },
  { source: 'lightgbm',       target: 'scipy' },
  { source: 'lightgbm',       target: 'mlflow' },
  { source: 'timm',           target: 'pytorch' },
  { source: 'timm',           target: 'hf-hub' },
  { source: 'spacy',          target: 'numpy' },
  { source: 'spacy',          target: 'hf-hub' },      // spaCy transformers pipeline
  // ── Enrichment: Agent edges ──
  { source: 'openai-agents',   target: 'openai-sdk' },
  { source: 'openai-agents',   target: 'mcp-sdk' },     // MCP tool integration
  { source: 'semantic-kernel', target: 'openai-sdk' },
  { source: 'semantic-kernel', target: 'anthropic-sdk' },
  { source: 'semantic-kernel', target: 'langchain' },
  // ── Enrichment: Application edges ──
  { source: 'anythingllm',    target: 'ollama' },
  { source: 'anythingllm',    target: 'openai-sdk' },
  { source: 'anythingllm',    target: 'langchain' },
  { source: 'anythingllm',    target: 'hf-hub' },
  // ── Fix: isolated nodes ──
  { source: 'litellm',        target: 'google-genai' },  // litellm proxies to Google GenAI
  { source: 'langchain',      target: 'google-genai' },  // langchain-google-genai integration
  { source: 'transformers',   target: 'sentencepiece' }, // tokenizer backend for LLaMA, T5, etc.
  { source: 'llama-cpp',      target: 'sentencepiece' }, // GGUF tokenization
  { source: 'setuptools',     target: 'numpy' },          // build dependency
];

const INCIDENTS = [
  { id: 'inc1', date: '2022-12', label: 'PyTorch torchtriton dependency confusion', nodes: ['pytorch', 'triton'],
    desc: 'Attacker registered malicious torchtriton on PyPI. 2,717 downloads, SSH key exfiltration via DNS tunneling.' },
  { id: 'inc2', date: '2024-02', label: '100 malicious models on HF', nodes: ['hf-hub', 'transformers'],
    desc: 'JFrog discovered ~100 models with reverse shell payload via pickle __reduce__. After removal \u2014 re-uploads with new IPs.' },
  { id: 'inc3', date: '2024-02', label: 'Safetensors converter hijack', nodes: ['safetensors', 'hf-hub'],
    desc: 'HiddenLayer: official HF conversion bot could be hijacked to send malicious PRs to any platform repository.' },
  { id: 'inc4', date: '2025-02', label: 'nullifAI Picklescan bypass', nodes: ['hf-hub', 'transformers', 'safetensors'],
    desc: 'ReversingLabs: 7z instead of ZIP to bypass scanner. Payload executed before parser error. Cross-platform reverse shells.' },
  { id: 'inc5', date: '2025-04', label: 'CVE-2025-32434 CVSS 9.3', nodes: ['pytorch'],
    desc: 'weights_only=True bypass in torch.load() \u2014 RCE via "safe" loading. All PyTorch versions \u22642.5.1 affected.' },
  { id: 'inc6', date: '2025-04', label: 'vLLM Mooncake RCE CVSS 10.0', nodes: ['vllm'],
    desc: 'CVE-2025-32444: pickle deserialization via ZeroMQ in Mooncake integration. CVSS 10.0, unauthorized RCE.' },
  { id: 'inc7', date: '2025-12', label: 'LangGrinch \u2014 secret leakage', nodes: ['langchain'],
    desc: 'CVE-2025-68664: serialization injection in langchain-core. API key leakage via prompt injection + RCE.' },
  { id: 'inc8', date: '2026-01', label: 'Ni8mare: n8n unauth RCE', nodes: ['n8n', 'langflow', 'dify'],
    desc: 'CVE-2026-21858 CVSS 10.0: unauthenticated RCE in n8n. 100K+ servers vulnerable. Government advisories from Australia and Canada. Wave of attacks on AI-workflow platforms.' },
  { id: 'inc9', date: '2024-11', label: 'Checkmarx Free Hugs: HF ecosystem exploits', nodes: ['transformers', 'hf-hub', 'safetensors'],
    desc: 'Checkmarx Free Hugs Parts 1-4 series: trust_remote_code obfuscation, pickle protocol 4 scanner bypass, bdb/pdb gadgets, exploit persistence across TF versions.' },
  { id: 'inc10', date: '2024-08', label: 'GGUF parser RCE: llama.cpp heap overflows', nodes: ['llama-cpp', 'ollama'],
    desc: 'Series of critical CVEs in llama.cpp GGUF parser: heap buffer overflow (CVE-2024-25294), OOB write, path traversal (CVE-2024-42479 CVSS 9.8). Ollama, LM Studio, GPT4All affected.' },
  { id: 'inc11', date: '2024-06', label: 'AutoGPT CVSS 9.8: command denylist bypass', nodes: ['autogpt'],
    desc: 'CVE-2024-6091: shell command denylist bypass via path normalization (/bin/./whoami). 166K+ starred project. OS command injection in autonomous AI agent.' },
  { id: 'inc12', date: '2025-04', label: 'MCP tool poisoning: agent supply chain attacks', nodes: ['langchain', 'crewai', 'llamaindex'],
    desc: 'Invariant Labs: MCP tool poisoning via hidden instructions in tool descriptions. 43% of MCP implementations had command injection. WhatsApp histories, SSH keys, GitHub repos exfiltrated. CVE-2025-6514 CVSS 9.6: mcp-remote RCE (437K downloads).' },
  { id: 'inc13', date: '2024-10', label: 'Open WebUI: 25+ CVEs on huntr', nodes: ['open-webui'],
    desc: '25+ CVEs disclosed on huntr targeting Open WebUI. Multiple DoS, authentication bypass, and information disclosure vulnerabilities across the most popular self-hosted LLM UI.' },
  { id: 'inc14', date: '2024-11', label: 'LibreChat: 15+ CVEs disclosure wave', nodes: ['librechat'],
    desc: '15+ vulnerability disclosures in a single wave on huntr targeting LibreChat. Path traversal leading to RCE, arbitrary file deletion, and information disclosure across the open-source ChatGPT alternative.' },
  // ── Enrichment: New incidents ──
  { id: 'inc15', date: '2024-12', label: 'Ultralytics PyPI Supply Chain Compromise', nodes: ['ultralytics'],
    desc: 'Versions 8.3.41/42/45/46 compromised via GitHub Actions script injection. XMRig cryptominer in official PyPI release. 60M+ downloads. Attacker @openimbot used malicious branch name for CI/CD code injection. Fix version 8.3.42 was also compromised. First major ML supply chain attack through CI/CD.' },
  { id: 'inc16', date: '2024-03', label: 'ShadowRay: Mass exploitation of Ray clusters', nodes: ['ray'],
    desc: 'CVE-2023-48022 (CVSS 9.8) actively exploited. 230K+ Ray servers exposed. Cryptomining (XMRig), data theft, DDoS. ShadowRay 2.0 (Nov 2025): self-propagating botnet with AI-generated payloads by IronErn440. Anyscale considers it a design decision — CVE NOT PATCHED.' },
  { id: 'inc17', date: '2025-11', label: 'ShadowMQ: Cross-framework pickle RCE propagation', nodes: ['vllm', 'sglang', 'ray'],
    desc: 'Unsafe pickle deserialization via ZeroMQ propagated through code copy-paste: Meta Llama Stack → vLLM → SGLang → NVIDIA TensorRT-LLM → Modular Max Server. CVE-2025-30165 (vLLM CVSS 8.0), CVE-2025-10164 (SGLang), CVE-2025-23254 (TensorRT-LLM CVSS 8.8). Thousands of exposed ZMQ sockets on public internet.' },
  { id: 'inc18', date: '2025-01', label: 'Picklescan Bypass: 4 CVEs in HF scanner', nodes: ['hf-hub', 'safetensors'],
    desc: 'Sonatype disclosure: 4 CVEs bypassing picklescan (HF malicious pickle detector). CVE-2025-1716 (static analysis bypass → ACE), CVE-2025-1889 (hidden files via extension), CVE-2025-1944 (ZIP filename tampering), CVE-2025-1945 (ZIP flag bits). Attackers can bypass malware scanning on HuggingFace Hub.' },
  { id: 'inc19', date: '2023-11', label: 'PyArrow CVSS 9.8: arbitrary code execution', nodes: ['pyarrow'],
    desc: 'CVE-2023-47248 (CVSS 9.8, EPSS 87.29%). Deserialization of untrusted data in IPC/Parquet/Feather readers. All versions 0.14.0–14.0.0. Affects Streamlit, Pandas, Spark, HF datasets. One of the most widely exploited ML CVEs.' },
  { id: 'inc20', date: '2025-05', label: 'Langflow active exploitation: Flodrix botnet', nodes: ['langflow'],
    desc: 'CVE-2025-3248 actively exploited. Added to CISA KEV 2025-05-05. Flodrix botnet uses RCE for DDoS and data exfiltration. Public PoC on GitHub. Trend Micro confirms active campaign targeting 79K+ GitHub stars project.' },
  // ── Enrichment v2: new incidents ──
  { id: 'inc21', date: '2023-12', label: 'HuggingFace API Token Mass Exposure', nodes: ['hf-hub'],
    desc: 'Lasso Security: 1500+ HuggingFace API tokens found on GitHub. Includes write-access tokens to Meta-Llama, BigScience Bloom, EleutherAI Pythia. Could modify models, inject backdoors into weights, poison training data. Millions of downstream users potentially affected.' },
  { id: 'inc22', date: '2024-01', label: 'HuggingFace AI Jacking: CI/CD pipeline hijack', nodes: ['hf-hub'],
    desc: 'Legit Security: vulnerability in HuggingFace CI/CD allowed hijack of popular repos via malicious pull request. Attacker could gain write-access to any HF repo through CI pipeline injection. Tens of thousands of developers potentially impacted.' },
  { id: 'inc23', date: '2023-10', label: 'Shelltorch: TorchServe mass exposure', nodes: ['torchserve', 'pytorch'],
    desc: 'Oligo Security: 3 vulnerabilities in TorchServe. Management API without auth on 0.0.0.0:8081 → RCE via model registration from arbitrary URL. SSRF + SnakeYAML deserialization → RCE. Tens of thousands of instances exposed on public internet.' },
  // ── Enrichment: New incidents ──
  { id: 'inc24', date: '2024-04', label: 'Wiz: HuggingFace cross-tenant container escape', nodes: ['hf-hub'],
    desc: 'Wiz Research: cross-tenant attack on HF Inference API — container escape via shared infrastructure → access to other users\' models and data. Full read access to other tenants\' model artifacts.' },
  { id: 'inc25', date: '2024-03', label: 'CVE-2024-3660: Keras Lambda arbitrary code execution', nodes: ['keras', 'tensorflow'],
    desc: 'CVE-2024-3660 CVSS 9.8: Keras 2 Lambda Layers allow arbitrary code injection via Lambda in .h5/SavedModel. Any model.load() with Lambda = code execution. CERT/CC VU#253266.' },
  { id: 'inc26', date: '2025-04', label: 'MCP tool poisoning & mcp-remote RCE', nodes: ['mcp-sdk', 'langchain', 'crewai'],
    desc: 'Invariant Labs: MCP tool poisoning via hidden instructions in tool descriptions. 43% of MCP implementations had command injection. CVE-2025-6514: mcp-remote RCE (CVSS 9.6, 437K downloads). WhatsApp histories, SSH keys, GitHub repos exfiltrated via tool calls.' },
  { id: 'inc27', date: '2025-11', label: 'TensorRT-LLM ShadowMQ propagation', nodes: ['tensorrt-llm', 'vllm', 'sglang'],
    desc: 'CVE-2025-23254 (CVSS 8.8): unsafe pickle deserialization via ZeroMQ propagated from vLLM to NVIDIA TensorRT-LLM via code copy-paste. Same vulnerability pattern in 5+ inference engines.' },
  { id: 'inc28', date: '2024-06', label: 'PyPI ML typosquatting campaigns', nodes: ['setuptools'],
    desc: 'Mass typosquatting campaigns targeting ML packages on PyPI: pytorch-lightning, nupmy, reqeusts, torchaudio variants. setup.py hooks execute cryptominers and credential stealers on pip install.' },
  { id: 'inc29', date: '2025-01', label: 'Flowise critical CVE cascade', nodes: ['flowise'],
    desc: 'Multiple critical CVEs: CVE-2025-58434 (CVSS 9.8 unauthenticated ATO), CVE-2024-31621 (auth bypass via case sensitivity, EPSS 60.74%). RCE via CustomMCP node and Supabase RPC Filter → execSync().' },
];

const ATTACK_PATTERNS = [
  { id: 'model-malware',    label: 'Model-as-Malware',           color: '#ff1744',
    desc: 'Legitimate model format features used as malware delivery. Not a bug — by-design code execution in model formats.',
    nodes: ['tensorflow', 'pytorch', 'hf-hub', 'safetensors', 'llama-cpp'],
    papers: ['TensorAbuse (S&P\'25)', 'CVE-2024-3660', 'Confused Learning (BlackHat Asia\'24)'] },
  { id: 'llm-injection',    label: 'LLM-Mediated Injection',     color: '#ff9100',
    desc: 'Prompt injection → SQL/OS/code injection via tool calling. LLM bridges untrusted input to privileged system calls.',
    nodes: ['langchain', 'llamaindex', 'ag2', 'browser-use', 'composio', 'flowise', 'langflow'],
    papers: ['LLMSmith (CCS\'24)', 'LLM4Shell (BlackHat Asia\'24)', 'Demystifying RCE (CCS\'24)'] },
  { id: 'pkg-hallucination', label: 'Package Hallucination',      color: '#76ff03',
    desc: 'LLM code assistants hallucinate package names → attackers register them on PyPI/npm → developers install malware. ~20% of suggested packages are hallucinated.',
    nodes: ['setuptools'],
    papers: ['"We Have a Package for You!" (arXiv)', 'Lasso Security: AI Package Hallucinations'] },
  { id: 'tenant-leakage',   label: 'Multi-Tenant Leakage',       color: '#00e5ff',
    desc: 'Shared GPU memory and KV-cache in multi-tenant serving allows cross-tenant prompt extraction.',
    nodes: ['vllm', 'sglang', 'tgi', 'ray'],
    papers: ['KV-Cache Sharing (NDSS\'25)'] },
  { id: 'cicd-compromise',  label: 'CI/CD Pipeline Compromise',   color: '#d500f9',
    desc: 'GitHub Actions / HF Spaces CI → code injection via PR metadata, branch names, workflow triggers.',
    nodes: ['ultralytics', 'hf-hub'],
    papers: ['Ultralytics incident (2024-12)', 'HF AI Jacking (Legit Security)'] },
  { id: 'vectordb-poisoning', label: 'Vector DB Poisoning', color: '#18ffff',
    desc: 'Poisoned embeddings or documents in vector databases manipulate RAG retrieval results. Silent data corruption — no code execution required.',
    nodes: ['chromadb', 'milvus', 'qdrant', 'faiss', 'pgvector', 'weaviate'],
    papers: ['Poisoning RAG (arXiv)', 'Phantom: RAG Poisoning (arXiv)'] },
  { id: 'mcp-tool-poisoning', label: 'MCP Tool Poisoning', color: '#e040fb',
    desc: 'Malicious instructions hidden in MCP tool descriptions. Agent calls tools that exfiltrate data or execute commands. 43% of MCP implementations vulnerable.',
    nodes: ['mcp-sdk', 'langchain', 'crewai', 'ag2', 'flowise'],
    papers: ['Invariant Labs MCP Research (2025)', 'CVE-2025-6514'] },
];

const RESEARCH_REFS = [
  { category: 'Surveys',     title: 'LLM Supply Chain: A Research Agenda',          venue: 'TOSEM',          url: null },
  { category: 'Surveys',     title: 'Lifting the Veil on the LLM Supply Chain',     venue: 'arXiv',          url: null },
  { category: 'Surveys',     title: 'LLM Supply Chain: Open Problems',              venue: 'arXiv',          url: null },
  { category: 'Model Sec',   title: 'Models Are Codes — Malicious Code Poisoning',  venue: 'ASE\'24',        url: null },
  { category: 'Model Sec',   title: 'TensorAbuse — Model-as-Malware',               venue: 'S&P\'25',       url: 'https://github.com/ZJU-SEC/TensorAbuse' },
  { category: 'Model Sec',   title: 'Naming Practices & Typosquatting on HF',       venue: 'arXiv',          url: null },
  { category: 'Model Sec',   title: 'Empirical Study of PTM Supply Chain',          venue: 'SCORED\'22',     url: null },
  { category: 'LLM Sec',     title: 'A New Era in LLM Security',                    venue: 'arXiv',          url: null },
  { category: 'LLM Sec',     title: 'LLMSmith — Systematic RCE Discovery',          venue: 'CCS\'24',       url: 'https://github.com/LLMSmith/LLMSmith' },
  { category: 'Standards',   title: 'OWASP Top 10 for LLMs',                        venue: 'OWASP',          url: 'https://owasp.org/www-project-top-10-for-large-language-model-applications/' },
  { category: 'Standards',   title: 'Offensive ML Playbook',                         venue: 'Wiki',           url: 'https://wiki.offsecml.com' },
  { category: 'Talks',       title: 'Practical LLM Security',                        venue: 'BlackHat USA\'24', url: null },
  { category: 'Talks',       title: 'Isolation or Hallucination — Hacking AI Infra', venue: 'BlackHat USA\'24', url: null },
  { category: 'Talks',       title: 'From MLOps to MLOops',                          venue: 'BlackHat USA\'24', url: null },
  { category: 'Talks',       title: 'Confused Learning — Supply Chain via ML Models', venue: 'BlackHat Asia\'24', url: null },
  { category: 'Talks',       title: 'Hugging Face to Hug Worms',                     venue: 'BlackHat Asia\'24', url: null },
  // ── Enrichment: New references ──
  { category: 'Model Sec',   title: 'Phantom: RAG Poisoning via Adversarial Documents',  venue: 'arXiv',          url: null },
  { category: 'Model Sec',   title: 'Free Hugs Parts 1-4: HuggingFace Ecosystem Exploits', venue: 'Checkmarx',   url: null },
  { category: 'LLM Sec',     title: 'ShadowMQ: Cross-Framework Pickle RCE Propagation', venue: 'arXiv',          url: null },
  { category: 'LLM Sec',     title: 'KV-Cache Sharing Prompt Leakage',                  venue: 'NDSS\'25',       url: null },
  { category: 'Standards',   title: 'OWASP Top 10 for LLM Agents',                       venue: 'OWASP',          url: null },
  { category: 'Talks',       title: 'MCP Security: Tool Poisoning & Agent Exploitation',  venue: 'DEF CON AI Village', url: null },
];

// ══════════════════════════════════════════════════
// MITRE ATLAS DATA
// ══════════════════════════════════════════════════

const ATLAS_TECHNIQUES = {
    'AML.T0010':     { id: 'AML.T0010',     name: 'ML Supply Chain Compromise',       desc: 'Adversary compromises ML supply chain components',                          url: 'https://atlas.mitre.org/techniques/AML.T0010' },
    'AML.T0010.000': { id: 'AML.T0010.000', name: 'ML Software Dependencies',         desc: 'Target software dependencies used in ML stack',                             url: 'https://atlas.mitre.org/techniques/AML.T0010.000' },
    'AML.T0010.001': { id: 'AML.T0010.001', name: 'ML Model Repositories',            desc: 'Compromise models in public repositories (HF Hub, model zoos)',             url: 'https://atlas.mitre.org/techniques/AML.T0010.001' },
    'AML.T0010.002': { id: 'AML.T0010.002', name: 'Data Stores',                      desc: 'Compromise data stores used for training or inference',                     url: 'https://atlas.mitre.org/techniques/AML.T0010.002' },
    'AML.T0018':     { id: 'AML.T0018',     name: 'Backdoor ML Model',                desc: 'Embed hidden functionality in ML model that activates on trigger',          url: 'https://atlas.mitre.org/techniques/AML.T0018' },
    'AML.T0019':     { id: 'AML.T0019',     name: 'Publish Poisoned Datasets',        desc: 'Publish manipulated datasets to public repositories',                       url: 'https://atlas.mitre.org/techniques/AML.T0019' },
    'AML.T0020':     { id: 'AML.T0020',     name: 'Poison Training Data',             desc: 'Manipulate training data to influence model behavior',                      url: 'https://atlas.mitre.org/techniques/AML.T0020' },
    'AML.T0024':     { id: 'AML.T0024',     name: 'Exfiltration via ML Inference API', desc: 'Extract data through model inference endpoints',                           url: 'https://atlas.mitre.org/techniques/AML.T0024' },
    'AML.T0040':     { id: 'AML.T0040',     name: 'ML Model Inference API Access',    desc: 'Gain access to model prediction interfaces',                                url: 'https://atlas.mitre.org/techniques/AML.T0040' },
    'AML.T0043':     { id: 'AML.T0043',     name: 'Craft Adversarial Data',           desc: 'Create inputs designed to cause model misclassification',                   url: 'https://atlas.mitre.org/techniques/AML.T0043' },
    'AML.T0049':     { id: 'AML.T0049',     name: 'Exploit Public-Facing Application', desc: 'Exploit vulnerabilities in public ML endpoints',                           url: 'https://atlas.mitre.org/techniques/AML.T0049' },
    'AML.T0051':     { id: 'AML.T0051',     name: 'LLM Prompt Injection',             desc: 'Manipulate LLM behavior through crafted inputs',                            url: 'https://atlas.mitre.org/techniques/AML.T0051' },
    'AML.T0051.000': { id: 'AML.T0051.000', name: 'Direct Prompt Injection',          desc: 'Directly inject malicious instructions into LLM prompt',                    url: 'https://atlas.mitre.org/techniques/AML.T0051.000' },
    'AML.T0051.001': { id: 'AML.T0051.001', name: 'Indirect Prompt Injection',        desc: 'Inject via external data sources processed by LLM',                         url: 'https://atlas.mitre.org/techniques/AML.T0051.001' },
    'AML.T0054':     { id: 'AML.T0054',     name: 'LLM Jailbreak',                    desc: 'Bypass LLM safety controls to execute unauthorized actions',                url: 'https://atlas.mitre.org/techniques/AML.T0054' },
    'AML.T0048':     { id: 'AML.T0048',     name: 'External Harms',                   desc: 'Cause financial, reputational, or physical harm via AI abuse',              url: 'https://atlas.mitre.org/techniques/AML.T0048' },
    'AML.T0062':     { id: 'AML.T0062',     name: 'Exfiltration via AI Agent Tool Invocation', desc: 'Use legitimate agent tool calls to extract data',                  url: 'https://atlas.mitre.org/techniques/AML.T0062' },
    'AML.T0012':     { id: 'AML.T0012',     name: 'Valid Accounts',                   desc: 'Acquire legitimate credentials to access ML systems',                       url: 'https://atlas.mitre.org/techniques/AML.T0012' },
};

function hasPickleRisk(node) {
    if (!node) return false;
    const text = (node.blast + ' ' + JSON.stringify(node.cves) + ' ' + JSON.stringify(node.attacks)).toLowerCase();
    return text.includes('pickle') || text.includes('deserialization') || text.includes('torch.load');
}

const ATLAS_EDGE_RULES = [
    { condition: (src, tgt) => tgt.id === 'setuptools',
      technique: 'AML.T0010.000', label: 'PyPI supply chain entry' },
    { condition: (src, tgt) => tgt.id === 'hf-hub' || tgt.layer === 'hf',
      technique: 'AML.T0010.001', label: 'Model repository compromise' },
    { condition: (src, tgt) => tgt.id === 'datasets' || tgt.id === 'pyarrow',
      technique: 'AML.T0019', label: 'Poisoned dataset distribution' },
    { condition: (src, tgt) => hasPickleRisk(src) || hasPickleRisk(tgt),
      technique: 'AML.T0010.000', label: 'Pickle deserialization in dependency' },
    { condition: (src, tgt) => src.layer === 'agents' || tgt.layer === 'agents',
      technique: 'AML.T0062', label: 'Agent tool invocation exploitation' },
    { condition: (src, tgt) => src.layer === 'app' && tgt.layer === 'serving',
      technique: 'AML.T0051', label: 'LLM prompt injection via serving' },
    { condition: (src, tgt) => tgt.cves && tgt.cves.some(c => c.cvss >= 9.0),
      technique: 'AML.T0049', label: 'Exploit critical CVE in public endpoint' },
    { condition: (src, tgt) => tgt.layer === 'hardware',
      technique: 'AML.T0010', label: 'Hardware supply chain compromise' },
    { condition: (src, tgt) => tgt.id === 'transformers' || tgt.id === 'safetensors',
      technique: 'AML.T0018', label: 'Backdoor ML model via format exploit' },
    { condition: (src, tgt) => tgt.layer === 'serving',
      technique: 'AML.T0040', label: 'ML inference API access' },
    { condition: () => true,
      technique: 'AML.T0010', label: 'ML supply chain dependency' },
];

const ATLAS_CASE_STUDY_MAP = {
    'inc1':  { csId: null,          techniques: ['AML.T0010.000'] },
    'inc2':  { csId: null,          techniques: ['AML.T0010.001', 'AML.T0018'] },
    'inc4':  { csId: null,          techniques: ['AML.T0010.001', 'AML.T0018'] },
    'inc5':  { csId: null,          techniques: ['AML.T0010.000', 'AML.T0049'] },
    'inc6':  { csId: null,          techniques: ['AML.T0049', 'AML.T0010.000'] },
    'inc7':  { csId: null,          techniques: ['AML.T0051', 'AML.T0024'] },
    'inc8':  { csId: null,          techniques: ['AML.T0049'] },
    'inc9':  { csId: null,          techniques: ['AML.T0010.001', 'AML.T0018'] },
    'inc11': { csId: null,          techniques: ['AML.T0049', 'AML.T0054'] },
    'inc12': { csId: null,          techniques: ['AML.T0062', 'AML.T0051.001'] },
    'inc15': { csId: null,          techniques: ['AML.T0010.000'] },
    'inc16': { csId: 'AML.CS0029', techniques: ['AML.T0049', 'AML.T0012'] },
    'inc19': { csId: null,          techniques: ['AML.T0010.000'] },
    'inc21': { csId: null,          techniques: ['AML.T0012'] },
    'inc23': { csId: null,          techniques: ['AML.T0049', 'AML.T0040'] },
};

// ══════════════════════════════════════════════════
// GLOBALS
// ══════════════════════════════════════════════════
const osvCache = {};
const osvPackageCache = {};
const OSV_API_BASE = 'https://api.osv.dev/v1';
const OSV_CACHE_TTL = 30 * 60 * 1000;

const NODE_TO_PYPI = {
  'pytorch': 'torch', 'hf-hub': 'huggingface-hub',
  'llama-cpp': 'llama-cpp-python', 'openai-sdk': 'openai',
  'anthropic-sdk': 'anthropic', 'google-genai': 'google-genai',
  'mistralai-sdk': 'mistralai', 'cohere-sdk': 'cohere',
  'gigachat-sdk': 'gigachat', 'groq-sdk': 'groq',
  'cuda': null, 'tsmc': null, 'asml': null, 'amd-rocm': null, 'pgvector': null,
};

let simulation, svg, g, linkGroup, nodeGroup, hullGroup, arrowDefs, graphZoom;
let simMode = false;
let attackPathMode = false;
let currentView = 'graph';
let chatHistory = [];
let activeFilters = new Set(Object.keys(LAYERS));
let activeYearFilter = null;  // null = show all
let nodeMap = {};
let adjForward = {};  // source → [target]  (source depends on target)
let adjReverse = {};  // target → [source]  (who depends on target)

NODES.forEach(n => { nodeMap[n.id] = n; adjForward[n.id] = []; adjReverse[n.id] = []; });
EDGES.forEach(e => {
  adjForward[e.source] = adjForward[e.source] || [];
  adjForward[e.source].push(e.target);
  adjReverse[e.target] = adjReverse[e.target] || [];
  adjReverse[e.target].push(e.source);
});

// ══════════════════════════════════════════════════
// INIT
// ══════════════════════════════════════════════════
document.addEventListener('DOMContentLoaded', () => {
  buildLayerFilters();
  buildYearFilters();
  buildTimeline();
  buildGraph();
  buildAttackRanking();
  buildResearchLibrary();
  initChat();
});

// ══════════════════════════════════════════════════
// LAYER FILTERS
// ══════════════════════════════════════════════════
function buildLayerFilters() {
  const container = document.getElementById('layerFilters');
  Object.entries(LAYERS).forEach(([key, l]) => {
    const chip = document.createElement('button');
    chip.className = 'layer-chip active';
    chip.textContent = l.name;
    chip.style.borderColor = l.color;
    chip.style.color = l.color;
    chip.dataset.layer = key;
    chip.onclick = () => toggleLayer(key, chip);
    container.appendChild(chip);
  });
}

function buildYearFilters() {
  const container = document.getElementById('yearFilters');
  const years = [null, 2023, 2024, 2025, 2026];
  const labels = ['All', '2023', '2024', '2025', '2026'];
  years.forEach((year, i) => {
    const chip = document.createElement('button');
    chip.className = 'year-chip' + (year === null ? ' active' : '');
    chip.textContent = labels[i];
    chip.dataset.year = year === null ? 'all' : year;
    chip.onclick = () => {
      activeYearFilter = year;
      container.querySelectorAll('.year-chip').forEach(c => c.classList.remove('active'));
      chip.classList.add('active');
      updateVisibility();
    };
    container.appendChild(chip);
  });
}

function toggleLayer(key, chip) {
  if (activeFilters.has(key)) { activeFilters.delete(key); chip.classList.remove('active'); }
  else { activeFilters.add(key); chip.classList.add('active'); }
  updateVisibility();
}

function isNodeVisible(node) {
  if (!activeFilters.has(node.layer)) return false;
  if (activeYearFilter !== null && node.since > activeYearFilter) return false;
  return true;
}

// Check if a node has CVEs or attacks in a given year
function nodeActiveInYear(node, year) {
  if (node.since === year) return true;
  if (node.cves) {
    for (const cve of node.cves) {
      const m = cve.id.match(/CVE-(\d{4})/);
      if (m && parseInt(m[1]) === year) return true;
    }
  }
  if (node.attacks) {
    for (const a of node.attacks) {
      if (parseInt(a.date) === year) return true;
    }
  }
  return false;
}

function updateVisibility() {
  // Apply node visibility + year emphasis via CSS classes
  nodeGroup.each(function(d) {
    const el = d3.select(this);
    const vis = isNodeVisible(d);
    el.style('display', vis ? null : 'none');

    if (activeYearFilter !== null && vis) {
      const isActive = nodeActiveInYear(d, activeYearFilter);
      el.classed('year-new', isActive).classed('year-old', !isActive);
    } else {
      el.classed('year-new', false).classed('year-old', false);
    }
  });

  linkGroup.each(function(d) {
    const srcNode = nodeMap[d.source.id || d.source];
    const tgtNode = nodeMap[d.target.id || d.target];
    const srcVis = srcNode && isNodeVisible(srcNode);
    const tgtVis = tgtNode && isNodeVisible(tgtNode);
    const el = d3.select(this);
    el.style('display', srcVis && tgtVis ? null : 'none');

    if (activeYearFilter !== null && srcVis && tgtVis) {
      const touchesActive = nodeActiveInYear(srcNode, activeYearFilter) || nodeActiveInYear(tgtNode, activeYearFilter);
      el.classed('year-edge-dim', !touchesActive);
    } else {
      el.classed('year-edge-dim', false);
    }
  });

  hullGroup.each(function(d) {
    let hasVisible = false;
    if (activeFilters.has(d)) {
      nodeGroup.each(function(n) { if (n.layer === d && isNodeVisible(n)) hasVisible = true; });
    }
    d3.select(this).style('display', hasVisible ? null : 'none');
  });

  // Gentle reheat so layout adjusts to hidden/shown nodes
  if (simulation) { simulation.alpha(0.15).restart(); }

  // Re-render heatmap if active
  if (currentView === 'heatmap') renderHeatmap();
}

// ══════════════════════════════════════════════════
// GRAPH
// ══════════════════════════════════════════════════
function buildGraph() {
  const container = document.getElementById('main');
  const W = container.clientWidth;
  const H = container.clientHeight;

  svg = d3.select('#graphSvg');

  // Defs: glow filters + arrow markers
  const defs = svg.append('defs');

  // Glow filters per layer
  Object.entries(LAYERS).forEach(([key, l]) => {
    const filter = defs.append('filter').attr('id', `glow-${key}`)
      .attr('x', '-50%').attr('y', '-50%').attr('width', '200%').attr('height', '200%');
    filter.append('feGaussianBlur').attr('stdDeviation', '4').attr('result', 'blur');
    const merge = filter.append('feMerge');
    merge.append('feMergeNode').attr('in', 'blur');
    merge.append('feMergeNode').attr('in', 'SourceGraphic');
  });

  // Critical glow (stronger)
  const critGlow = defs.append('filter').attr('id', 'glow-critical')
    .attr('x', '-50%').attr('y', '-50%').attr('width', '200%').attr('height', '200%');
  critGlow.append('feGaussianBlur').attr('stdDeviation', '8').attr('result', 'blur');
  const critMerge = critGlow.append('feMerge');
  critMerge.append('feMergeNode').attr('in', 'blur');
  critMerge.append('feMergeNode').attr('in', 'SourceGraphic');

  // Vulnerability ring glow
  const vulnGlow = defs.append('filter').attr('id', 'glow-vuln')
    .attr('x', '-50%').attr('y', '-50%').attr('width', '200%').attr('height', '200%');
  vulnGlow.append('feGaussianBlur').attr('stdDeviation', '3').attr('result', 'blur');
  const vulnMerge = vulnGlow.append('feMerge');
  vulnMerge.append('feMergeNode').attr('in', 'blur');
  vulnMerge.append('feMergeNode').attr('in', 'SourceGraphic');

  // Arrow marker
  defs.append('marker')
    .attr('id', 'arrowhead')
    .attr('viewBox', '0 -5 10 10')
    .attr('refX', 20).attr('refY', 0)
    .attr('markerWidth', 6).attr('markerHeight', 6)
    .attr('orient', 'auto')
    .append('path').attr('d', 'M0,-4L10,0L0,4').attr('class', 'link-arrow')
    .style('fill', '#556');

  // Zoom
  const zoom = d3.zoom()
    .scaleExtent([0.3, 4])
    .on('zoom', (event) => { g.attr('transform', event.transform); });
  svg.call(zoom);
  graphZoom = zoom;

  g = svg.append('g');

  // Cluster centers
  const layerCenters = {
    hardware:  { x: W * 0.15, y: H * 0.25 },
    base:      { x: W * 0.32, y: H * 0.82 },
    framework: { x: W * 0.3,  y: H * 0.5 },
    hf:        { x: W * 0.6,  y: H * 0.45 },
    vectordb:  { x: W * 0.5,  y: H * 0.72 },
    serving:   { x: W * 0.8, y: H * 0.28 },
    agents:    { x: W * 0.72, y: H * 0.65 },
    app:       { x: W * 0.82, y: H * 0.72 },
  };

  // Radius scale
  const maxDl = d3.max(NODES, d => d.downloads);
  const rScale = d3.scaleSqrt().domain([0, maxDl]).range([14, 55]);

  // Copy nodes data
  const nodesData = NODES.map(d => ({
    ...d,
    r: d.downloads > 0 ? rScale(d.downloads) : (d.layer === 'hardware' ? 30 : 18),
    x: layerCenters[d.layer].x + (Math.random() - 0.5) * 80,
    y: layerCenters[d.layer].y + (Math.random() - 0.5) * 60,
  }));

  const edgesData = EDGES.map(d => ({ ...d }));

  // Convex hulls
  hullGroup = g.selectAll('.cluster-hull')
    .data(Object.keys(LAYERS))
    .enter().append('path')
    .attr('class', 'cluster-hull')
    .attr('fill', d => LAYERS[d].color)
    .attr('fill-opacity', 0.03)
    .attr('stroke', d => LAYERS[d].color)
    .attr('stroke-opacity', 0.12)
    .attr('stroke-dasharray', '4 2');

  // Links
  linkGroup = g.selectAll('.link-line')
    .data(edgesData)
    .enter().append('path')
    .attr('class', 'link-line')
    .attr('stroke', '#334')
    .attr('stroke-width', 1.2)
    .attr('marker-end', 'url(#arrowhead)');

  // Nodes
  nodeGroup = g.selectAll('.node-group')
    .data(nodesData)
    .enter().append('g')
    .attr('class', 'node-group')
    .call(d3.drag()
      .on('start', dragStart)
      .on('drag', dragging)
      .on('end', dragEnd))
    .on('mouseover', onNodeHover)
    .on('mouseout', onNodeOut)
    .on('click', onNodeClick);

  // Draw shapes
  nodeGroup.each(function(d) {
    const el = d3.select(this);
    const layerColor = LAYERS[d.layer].color;
    const glowFilter = d.risk >= 85 ? 'url(#glow-critical)' : `url(#glow-${d.layer})`;
    const cveBonus = Math.min(d.cves.length * 0.04, 0.20);

    if (d.shape === 'hex') {
      const r = d.r;
      const hex = d3.range(6).map(i => {
        const angle = (Math.PI / 3) * i - Math.PI / 6;
        return [r * Math.cos(angle), r * Math.sin(angle)];
      });
      el.append('polygon')
        .attr('class', 'node-hex')
        .attr('points', hex.map(p => p.join(',')).join(' '))
        .attr('fill', hexToRGBA(layerColor, 0.15 + cveBonus))
        .attr('stroke', layerColor)
        .style('filter', glowFilter);
    } else {
      el.append('circle')
        .attr('class', 'node-circle')
        .attr('r', d.r)
        .attr('fill', hexToRGBA(layerColor, 0.12 + cveBonus))
        .attr('stroke', layerColor)
        .style('filter', glowFilter);
    }

    el.append('text')
      .attr('class', 'node-label')
      .attr('dy', d.r + 14)
      .text(d.label);

    // Vulnerability depth ring
    if (d.cves.length > 0) {
      const vulnCount = d.cves.length;
      const maxCVSS = d3.max(d.cves, c => c.cvss) || 0;
      const ringR = d.r + 6 + Math.min(vulnCount, 9) * 2;
      const ringColor = maxCVSS >= 9 ? '#ff1744' : maxCVSS >= 7 ? '#ff9100' : '#ffea00';
      const ringWidth = 1.5 + Math.min(vulnCount, 9) * 0.3;

      el.append('circle')
        .attr('class', 'vuln-ring vuln-ring-unfixed')
        .attr('r', ringR)
        .attr('stroke', ringColor)
        .attr('stroke-width', ringWidth)
        .attr('stroke-dasharray', '4 3')
        .style('filter', 'url(#glow-vuln)');

      if (vulnCount >= 2) {
        el.append('text')
          .attr('class', 'node-label')
          .attr('dy', -(d.r + 8))
          .attr('text-anchor', 'middle')
          .attr('fill', ringColor)
          .attr('font-size', '9px')
          .attr('font-family', 'JetBrains Mono, monospace')
          .attr('font-weight', '600')
          .text(`${vulnCount} CVE`);
      }
    }
  });

  // Force simulation
  simulation = d3.forceSimulation(nodesData)
    .force('link', d3.forceLink(edgesData).id(d => d.id).distance(120).strength(0.3))
    .force('charge', d3.forceManyBody().strength(-500))
    .force('x', d3.forceX(d => layerCenters[d.layer].x).strength(0.15))
    .force('y', d3.forceY(d => layerCenters[d.layer].y).strength(0.15))
    .force('collide', d3.forceCollide(d => d.r + 12).strength(0.8))
    .on('tick', ticked);

  function ticked() {
    linkGroup.attr('d', d => {
      const dx = d.target.x - d.source.x;
      const dy = d.target.y - d.source.y;
      const dr = Math.sqrt(dx * dx + dy * dy) * 1.5;
      return `M${d.source.x},${d.source.y}A${dr},${dr} 0 0,1 ${d.target.x},${d.target.y}`;
    });

    nodeGroup.attr('transform', d => `translate(${d.x},${d.y})`);
    updateHulls(nodesData);
  }

  function updateHulls(nodes) {
    hullGroup.attr('d', layer => {
      const pts = nodes.filter(n => n.layer === layer).map(n => [n.x, n.y]);
      if (pts.length < 3) return null;
      const hull = d3.polygonHull(expandPoints(pts, 30));
      return hull ? `M${hull.join('L')}Z` : null;
    });
  }

  // Center view
  const initTransform = d3.zoomIdentity.translate(0, 0).scale(1);
  svg.call(zoom.transform, initTransform);

  // Resize handler
  window.addEventListener('resize', () => {
    const nW = container.clientWidth;
    const nH = container.clientHeight;
    const scaleX = nW / W;
    const scaleY = nH / H;
    Object.keys(layerCenters).forEach(k => {
      layerCenters[k].x *= scaleX;
      layerCenters[k].y *= scaleY;
    });
    simulation.force('x', d3.forceX(d => layerCenters[d.layer].x).strength(0.15));
    simulation.force('y', d3.forceY(d => layerCenters[d.layer].y).strength(0.15));
    simulation.alpha(0.3).restart();
  });
}

// ── Helpers ──
function hexToRGBA(hex, alpha) {
  const r = parseInt(hex.slice(1, 3), 16);
  const g = parseInt(hex.slice(3, 5), 16);
  const b = parseInt(hex.slice(5, 7), 16);
  return `rgba(${r},${g},${b},${alpha})`;
}

function expandPoints(points, padding) {
  if (points.length < 2) return points;
  const cx = d3.mean(points, p => p[0]);
  const cy = d3.mean(points, p => p[1]);
  return points.map(p => {
    const dx = p[0] - cx;
    const dy = p[1] - cy;
    const dist = Math.sqrt(dx * dx + dy * dy) || 1;
    return [p[0] + (dx / dist) * padding, p[1] + (dy / dist) * padding];
  });
}

function formatNumber(n) {
  if (n >= 1e9) return (n / 1e9).toFixed(1) + 'B';
  if (n >= 1e6) return (n / 1e6).toFixed(1) + 'M';
  if (n >= 1e3) return (n / 1e3).toFixed(1) + 'K';
  return n.toString();
}

// ── Drag ──
function dragStart(event, d) {
  if (!event.active) simulation.alphaTarget(0.3).restart();
  d.fx = d.x; d.fy = d.y;
}
function dragging(event, d) { d.fx = event.x; d.fy = event.y; }
function dragEnd(event, d) {
  if (!event.active) simulation.alphaTarget(0);
  d.fx = null; d.fy = null;
}

// ══════════════════════════════════════════════════
// HOVER — highlight neighbors
// ══════════════════════════════════════════════════
function onNodeHover(event, d) {
  if (simMode || attackPathMode) return;

  const neighbors = new Set([d.id]);
  (adjForward[d.id] || []).forEach(n => neighbors.add(n));
  (adjReverse[d.id] || []).forEach(n => neighbors.add(n));

  nodeGroup.classed('dimmed', n => !neighbors.has(n.id));
  nodeGroup.classed('highlighted', n => neighbors.has(n.id));
  linkGroup.classed('dimmed', e => {
    const sid = e.source.id || e.source;
    const tid = e.target.id || e.target;
    return !(sid === d.id || tid === d.id);
  });

  // Tooltip
  const tooltip = document.getElementById('tooltip');
  const mainRect = document.getElementById('main').getBoundingClientRect();
  tooltip.innerHTML = `
    <div class="tt-name" style="color:${LAYERS[d.layer].color}">${d.label}</div>
    <div class="tt-layer">${LAYERS[d.layer].name}</div>
    ${d.downloads > 0 ? `<div class="tt-downloads">${formatNumber(d.downloads)} downloads/mo</div>` : ''}
  `;
  tooltip.style.display = 'block';
  tooltip.style.left = (event.clientX - mainRect.left + 15) + 'px';
  tooltip.style.top = (event.clientY - mainRect.top + 15) + 'px';
}

function onNodeOut(event, d) {
  if (simMode || attackPathMode) return;
  nodeGroup.classed('dimmed', false).classed('highlighted', false);
  linkGroup.classed('dimmed', false);
  document.getElementById('tooltip').style.display = 'none';
}

// ══════════════════════════════════════════════════
// CLICK — detail panel or compromise
// ══════════════════════════════════════════════════
function onNodeClick(event, d) {
  event.stopPropagation();
  document.getElementById('tooltip').style.display = 'none';

  if (attackPathMode) {
    renderAttackPaths(d);
    return;
  }

  if (simMode) {
    runCompromiseSimulation(d);
    return;
  }

  showNodeDetail(d);
}

// ══════════════════════════════════════════════════
// OSV.dev API INTEGRATION
// ══════════════════════════════════════════════════

async function fetchOsvVuln(cveId) {
  const cached = osvCache[cveId];
  if (cached && Date.now() - cached.timestamp < OSV_CACHE_TTL) {
    if (cached.error) throw cached.error;
    return cached.data;
  }
  try {
    const resp = await fetch(`${OSV_API_BASE}/vulns/${encodeURIComponent(cveId)}`);
    if (resp.status === 404) {
      const err = new Error('Not found in OSV');
      osvCache[cveId] = { data: null, timestamp: Date.now(), error: err };
      throw err;
    }
    if (!resp.ok) throw new Error(`OSV API error: ${resp.status}`);
    const data = await resp.json();
    osvCache[cveId] = { data, timestamp: Date.now(), error: null };
    return data;
  } catch (e) {
    if (!osvCache[cveId]) osvCache[cveId] = { data: null, timestamp: Date.now(), error: e };
    throw e;
  }
}

async function fetchOsvPackageVulns(nodeId) {
  const cached = osvPackageCache[nodeId];
  if (cached && Date.now() - cached.timestamp < OSV_CACHE_TTL) {
    if (cached.error) throw cached.error;
    return cached.vulns;
  }
  const pypiName = NODE_TO_PYPI.hasOwnProperty(nodeId) ? NODE_TO_PYPI[nodeId] : nodeId;
  if (pypiName === null) {
    osvPackageCache[nodeId] = { vulns: [], timestamp: Date.now(), error: null };
    return [];
  }
  try {
    const resp = await fetch(`${OSV_API_BASE}/query`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ package: { name: pypiName, ecosystem: 'PyPI' } })
    });
    if (!resp.ok) throw new Error(`OSV query error: ${resp.status}`);
    const data = await resp.json();
    const vulns = data.vulns || [];
    osvPackageCache[nodeId] = { vulns, timestamp: Date.now(), error: null };
    return vulns;
  } catch (e) {
    if (!osvPackageCache[nodeId]) osvPackageCache[nodeId] = { vulns: [], timestamp: Date.now(), error: e };
    throw e;
  }
}

function extractFixInfo(osvData) {
  const fixVersions = [];
  let hasFix = false;
  if (osvData && osvData.affected) {
    osvData.affected.forEach(aff => {
      if (aff.ranges) {
        aff.ranges.forEach(range => {
          if (range.events) {
            range.events.forEach(ev => {
              if (ev.fixed) {
                hasFix = true;
                if (!fixVersions.includes(ev.fixed)) fixVersions.push(ev.fixed);
              }
            });
          }
        });
      }
    });
  }
  return { hasFix, fixVersions };
}

function refTypeLabel(type) {
  const labels = {
    'ADVISORY': 'Advisory', 'ARTICLE': 'Article', 'DETECTION': 'Detection',
    'DISCUSSION': 'Discussion', 'REPORT': 'Report', 'FIX': 'Fix',
    'INTRODUCED': 'Intro', 'PACKAGE': 'Pkg', 'EVIDENCE': 'Evidence',
    'WEB': 'Web', 'GIT': 'Git'
  };
  return labels[type] || type || 'Link';
}

function renderCveWithOsv(cve, container) {
  const cvssColor = cve.cvss >= 9 ? '#ff1744' : cve.cvss >= 7 ? '#ff9100' : '#ffea00';
  const itemEl = document.createElement('div');
  itemEl.className = 'cve-item';
  itemEl.innerHTML = `
    <div class="cve-id">${cve.id} <span class="cve-osv-spinner" id="osv-spin-${cve.id.replace(/[^a-zA-Z0-9]/g, '_')}"></span></div>
    <div class="cve-desc">${cve.desc}</div>
    <span class="cve-cvss" style="background:${hexToRGBA(cvssColor, 0.2)};color:${cvssColor};border:1px solid ${hexToRGBA(cvssColor, 0.3)}">CVSS ${cve.cvss}</span>
    <div class="cve-osv-details" id="osv-details-${cve.id.replace(/[^a-zA-Z0-9]/g, '_')}"></div>
  `;
  container.appendChild(itemEl);

  const spinId = `osv-spin-${cve.id.replace(/[^a-zA-Z0-9]/g, '_')}`;
  const detailId = `osv-details-${cve.id.replace(/[^a-zA-Z0-9]/g, '_')}`;

  const fixPromise = fetchOsvVuln(cve.id).then(osvData => {
    const spinner = document.getElementById(spinId);
    if (spinner) spinner.remove();

    const { hasFix, fixVersions } = extractFixInfo(osvData);
    const idEl = itemEl.querySelector('.cve-id');
    if (hasFix) {
      let ver = fixVersions[0];
      // Truncate commit hashes (40 hex chars) to short form
      if (/^[0-9a-f]{20,}$/i.test(ver)) ver = ver.substring(0, 7);
      idEl.insertAdjacentHTML('beforeend', `<span class="cve-fix-badge cve-fix-available" title="${fixVersions[0]}">FIX ${ver}</span>`);
    } else {
      idEl.insertAdjacentHTML('beforeend', `<span class="cve-fix-badge cve-fix-none">NO FIX</span>`);
    }

    const detailEl = document.getElementById(detailId);
    if (detailEl && osvData) {
      let html = '';
      if (osvData.summary) html += `<div class="cve-osv-summary">${osvData.summary}</div>`;
      if (osvData.aliases && osvData.aliases.length > 0) {
        html += `<div class="cve-osv-aliases">Aliases: ${osvData.aliases.join(', ')}</div>`;
      }
      if (osvData.references && osvData.references.length > 0) {
        html += '<div class="cve-osv-refs">';
        const seen = new Set();
        let refCount = 0;
        for (const ref of osvData.references) {
          const label = refTypeLabel(ref.type);
          if (seen.has(label) && label === 'Advisory') continue;
          seen.add(label);
          html += `<a class="cve-osv-ref-link" href="${ref.url}" target="_blank" rel="noopener">${label}</a>`;
          if (++refCount >= 4) break;
        }
        html += '</div>';
      }
      detailEl.innerHTML = html;
    }
    return { hasFix, fixVersions };
  }).catch(err => {
    const spinner = document.getElementById(spinId);
    if (spinner) spinner.remove();
    const detailEl = document.getElementById(detailId);
    if (detailEl) detailEl.innerHTML = `<div class="cve-osv-error">${err.message}</div>`;
    return { hasFix: false, fixVersions: [] };
  });

  return fixPromise;
}

async function enrichDetailWithOsvPackageQuery(nodeId, existingCveIds, container) {
  const titleEl = document.getElementById('osvExtraSectionTitle');
  container.innerHTML = '';
  titleEl.style.display = 'none';
  try {
    const vulns = await fetchOsvPackageVulns(nodeId);
    const existingSet = new Set(existingCveIds.map(id => id.toUpperCase()));
    const extras = vulns.filter(v => {
      const ids = [v.id, ...(v.aliases || [])].map(a => a.toUpperCase());
      return !ids.some(a => existingSet.has(a));
    });
    if (extras.length === 0) return;
    titleEl.style.display = 'block';
    extras.slice(0, 5).forEach(v => {
      const el = document.createElement('div');
      el.className = 'osv-extra-cve-item';
      const summary = v.summary || v.details || 'No description available';
      const truncated = summary.length > 120 ? summary.substring(0, 120) + '...' : summary;
      el.innerHTML = `
        <div class="osv-extra-cve-id">${v.id}</div>
        <div class="cve-desc">${truncated}</div>
      `;
      container.appendChild(el);
    });
  } catch (e) {
    container.innerHTML = `<div class="cve-osv-error">Package query: ${e.message}</div>`;
  }
}

function updateFixSummary(totalCves, fixPromises) {
  const row = document.getElementById('fixSummaryRow');
  const val = document.getElementById('fixSummaryValue');
  if (totalCves === 0) { row.style.display = 'none'; return; }
  row.style.display = 'flex';
  val.textContent = 'Loading...';
  val.className = 'fix-summary-value';

  Promise.allSettled(fixPromises).then(results => {
    let fixCount = 0;
    results.forEach(r => {
      if (r.status === 'fulfilled' && r.value && r.value.hasFix) fixCount++;
    });
    const ratio = fixCount / totalCves;
    let cls = 'fix-summary-bad';
    if (ratio >= 0.7) cls = 'fix-summary-good';
    else if (ratio >= 0.3) cls = 'fix-summary-warn';
    val.textContent = `${fixCount}/${totalCves} have fixes`;
    val.className = `fix-summary-value ${cls}`;
  });
}

function showNodeDetail(d) {
  const panel = document.getElementById('node-detail');
  panel.classList.add('visible');
  requestAnimationFrame(() => panel.scrollIntoView({ behavior: 'smooth', block: 'start' }));

  document.getElementById('detailDot').style.background = LAYERS[d.layer].color;
  document.getElementById('detailName').textContent = d.label;
  document.getElementById('detailName').style.color = LAYERS[d.layer].color;
  document.getElementById('detailLayer').textContent = LAYERS[d.layer].name;

  // Risk
  const riskEl = document.getElementById('detailRisk');
  const riskClass = d.risk >= 85 ? 'risk-critical' : d.risk >= 65 ? 'risk-high' : 'risk-medium';
  const riskLabel = d.risk >= 85 ? 'CRITICAL' : d.risk >= 65 ? 'HIGH' : 'MEDIUM';
  riskEl.innerHTML = `<span class="risk-badge ${riskClass}">${d.risk}/100 ${riskLabel}</span>`;

  document.getElementById('detailDownloads').textContent = d.downloads > 0 ? formatNumber(d.downloads) : 'N/A (hardware)';
  document.getElementById('detailDeps').textContent = d.depRepos > 0 ? formatNumber(d.depRepos) + '+' : 'N/A';
  document.getElementById('detailMaintainers').textContent = d.maintainers;
  document.getElementById('detailBlast').textContent = d.blast;

  // CVEs with OSV enrichment
  const cveContainer = document.getElementById('detailCVEs');
  const cveSectionTitle = document.getElementById('cveSectionTitle');
  const osvExtraContainer = document.getElementById('osvExtraCVEs');
  const osvExtraSectionTitle = document.getElementById('osvExtraSectionTitle');
  const fixSummaryRow = document.getElementById('fixSummaryRow');
  cveContainer.innerHTML = '';
  osvExtraContainer.innerHTML = '';
  osvExtraSectionTitle.style.display = 'none';
  fixSummaryRow.style.display = 'none';

  const fixPromises = [];
  const existingCveIds = d.cves.map(c => c.id);

  if (d.cves.length > 0) {
    cveSectionTitle.style.display = 'block';
    d.cves.forEach(cve => {
      const p = renderCveWithOsv(cve, cveContainer);
      fixPromises.push(p);
    });
    updateFixSummary(d.cves.length, fixPromises);
  } else {
    cveSectionTitle.style.display = 'none';
  }

  enrichDetailWithOsvPackageQuery(d.id, existingCveIds, osvExtraContainer);

  // Attacks
  const attackContainer = document.getElementById('detailAttacks');
  const attackSectionTitle = document.getElementById('attackSectionTitle');
  attackContainer.innerHTML = '';
  if (d.attacks.length > 0) {
    attackSectionTitle.style.display = 'block';
    d.attacks.forEach(a => {
      attackContainer.innerHTML += `
        <div class="attack-item">
          <span class="attack-date">${a.date}</span> — ${a.desc}
        </div>`;
    });
  } else {
    attackSectionTitle.style.display = 'none';
  }

  // Threat Actors
  const threatContainer = document.getElementById('detailThreats');
  const threatSectionTitle = document.getElementById('threatSectionTitle');
  threatContainer.innerHTML = '';
  if (d.threats && d.threats.length > 0) {
    threatSectionTitle.style.display = 'block';
    d.threats.forEach(t => {
      const actor = THREAT_ACTORS[t.actor];
      if (!actor) return;
      threatContainer.innerHTML += `
        <div class="threat-item">
          <span class="threat-actor-badge" style="background:${hexToRGBA(actor.color, 0.2)};color:${actor.color};border:1px solid ${hexToRGBA(actor.color, 0.3)}">${actor.icon} ${actor.label}</span>
          <div class="threat-vector">${t.vector}</div>
        </div>`;
    });
  } else {
    threatSectionTitle.style.display = 'none';
  }
}

// ══════════════════════════════════════════════════
// COMPROMISE SIMULATION
// ══════════════════════════════════════════════════
function toggleSimMode() {
  simMode = !simMode;
  const btn = document.getElementById('simBtn');
  const resetBtn = document.getElementById('simReset');
  const hint = document.getElementById('graphHint');

  if (simMode) {
    // Disable attack path mode if active
    if (attackPathMode) toggleAttackPathMode();
    btn.classList.add('active');
    btn.innerHTML = '&#x26A0; SIMULATION MODE ACTIVE';
    resetBtn.style.display = 'inline-block';
    hint.textContent = 'Click a node to run cascade simulation';
    hint.style.color = '#ff1744';
  } else {
    resetSimulation();
  }
}

function resetSimulation() {
  simMode = false;
  const btn = document.getElementById('simBtn');
  const resetBtn = document.getElementById('simReset');
  const hint = document.getElementById('graphHint');

  btn.classList.remove('active');
  btn.innerHTML = '&#x26A0; Compromise Simulation';
  resetBtn.style.display = 'none';
  hint.textContent = 'scroll: zoom \u00b7 drag: navigate \u00b7 click: details';
  hint.style.color = '#334';

  // Clear all compromise visuals
  nodeGroup.classed('compromised', false).classed('dimmed', false).classed('highlighted', false);
  linkGroup.classed('compromise-link', false).classed('dimmed', false);
  document.querySelectorAll('.link-arrow').forEach(el => el.classList.remove('compromise-arrow'));

  document.getElementById('compromise-panel').classList.remove('visible');

  // Also clear attack path highlights if any
  if (typeof clearAttackPathHighlight === 'function') clearAttackPathHighlight();
  document.getElementById('attack-paths-panel').classList.remove('visible');
}

function runCompromiseSimulation(startNode) {
  // Reset previous
  nodeGroup.classed('compromised', false);
  linkGroup.classed('compromise-link', false);

  // BFS through reverse dependencies (who depends on compromised node)
  const visited = new Set();
  const queue = [{ id: startNode.id, depth: 0 }];
  visited.add(startNode.id);
  let maxDepth = 0;
  const depthMap = { [startNode.id]: 0 };

  while (queue.length > 0) {
    const { id, depth } = queue.shift();
    maxDepth = Math.max(maxDepth, depth);
    const dependents = adjReverse[id] || [];
    dependents.forEach(dep => {
      if (!visited.has(dep)) {
        visited.add(dep);
        depthMap[dep] = depth + 1;
        queue.push({ id: dep, depth: depth + 1 });
      }
    });
  }

  // Animate cascade with delay per depth level
  visited.forEach(nodeId => {
    const depth = depthMap[nodeId];
    setTimeout(() => {
      nodeGroup.filter(n => n.id === nodeId).classed('compromised', true);
    }, depth * 600);
  });

  // Highlight compromise edges
  linkGroup.each(function(e) {
    const sid = e.source.id || e.source;
    const tid = e.target.id || e.target;
    if (visited.has(sid) && visited.has(tid)) {
      const edgeDepth = Math.min(depthMap[sid] || 0, depthMap[tid] || 0);
      setTimeout(() => {
        d3.select(this).classed('compromise-link', true);
      }, edgeDepth * 600);
    }
  });

  // Calculate total downloads affected
  let totalDownloads = 0;
  visited.forEach(nodeId => {
    totalDownloads += (nodeMap[nodeId]?.downloads || 0);
  });

  // Show panel after animation completes
  setTimeout(() => {
    const panel = document.getElementById('compromise-panel');
    panel.classList.add('visible');
    document.getElementById('compNodes').textContent = visited.size;
    document.getElementById('compDownloads').textContent = formatNumber(totalDownloads) + '/mo';
    document.getElementById('compDepth').textContent = maxDepth;
  }, (maxDepth + 1) * 600);
}

// ══════════════════════════════════════════════════
// TIMELINE
// ══════════════════════════════════════════════════
function buildTimeline() {
  const track = document.getElementById('timelineTrack');
  const scrollEl = track.parentElement;
  // Use a short delay so layout is computed
  requestAnimationFrame(() => {
    const containerWidth = scrollEl.clientWidth || (window.innerWidth - 48);

    // Date range
    const startDate = new Date(2022, 9);
    const endDate = new Date(2026, 5);
    const totalMs = endDate - startDate;

    // Force scroll — always wider than container
    const trackWidth = Math.max(containerWidth + 200, INCIDENTS.length * 95 + 120);
    track.style.width = trackWidth + 'px';

    // Year separators + labels
    [2023, 2024, 2025, 2026].forEach(year => {
      const yearDate = new Date(year, 0);
      const pos = 40 + ((yearDate - startDate) / totalMs) * (trackWidth - 80);

      const sep = document.createElement('div');
      sep.className = 'timeline-year-separator';
      sep.style.left = pos + 'px';
      track.appendChild(sep);

      const label = document.createElement('div');
      label.className = 'timeline-year-label';
      label.style.left = (pos + 4) + 'px';
      label.textContent = year;
      track.appendChild(label);
    });

    // Sort incidents
    const sorted = [...INCIDENTS].sort((a, b) => {
      const da = a.date.split('-'), db = b.date.split('-');
      return new Date(+da[0], +da[1] - 1) - new Date(+db[0], +db[1] - 1);
    });

    function getSeverity(inc) {
      const desc = (inc.desc + ' ' + inc.label).toLowerCase();
      if (desc.includes('cvss 10') || desc.includes('cvss 9') || desc.includes('rce') || desc.includes('critical')) return 'critical';
      if (desc.includes('cvss 8') || desc.includes('cvss 7') || desc.includes('bypass') || desc.includes('injection')) return 'high';
      return 'medium';
    }

    // Collision avoidance
    const usedPositions = [];
    const minSpacing = 90;

    sorted.forEach((inc) => {
      const parts = inc.date.split('-');
      const incDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1);
      let pos = 40 + ((incDate - startDate) / totalMs) * (trackWidth - 80);

      for (const used of usedPositions) {
        if (Math.abs(pos - used) < minSpacing) {
          pos = used + minSpacing;
        }
      }
      usedPositions.push(pos);

      const severity = getSeverity(inc);
      const nodeBadges = inc.nodes.map(nid => {
        const n = nodeMap[nid];
        return n ? `<span class="timeline-tooltip-node">${n.label}</span>` : '';
      }).join('');

      const el = document.createElement('div');
      el.className = 'timeline-incident';
      el.style.left = pos + 'px';
      // Shift dot to sit ON the axis: axis is top:50%, dot is 12px, so offset by -6
      el.style.marginTop = '-6px';

      el.innerHTML = `
        <div class="timeline-label-above">${inc.label}</div>
        <div class="timeline-dot severity-${severity}"></div>
        <div class="timeline-date-below">${inc.date}</div>
      `;

      // Tooltip via fixed overlay
      const tooltipHtml = `
        <div class="timeline-tooltip-title">${inc.label}</div>
        <div class="timeline-tooltip-desc">${inc.desc}</div>
        <div class="timeline-tooltip-nodes">${nodeBadges}</div>
      `;
      el.addEventListener('mouseenter', (e) => {
        const overlay = document.getElementById('timeline-tooltip-overlay');
        overlay.innerHTML = tooltipHtml;
        const rect = el.getBoundingClientRect();
        overlay.style.left = Math.min(rect.left, window.innerWidth - 310) + 'px';
        overlay.style.top = (rect.top - overlay.offsetHeight - 8) + 'px';
        overlay.classList.add('visible');
        // Reposition after render
        requestAnimationFrame(() => {
          overlay.style.top = (rect.top - overlay.offsetHeight - 8) + 'px';
        });
      });
      el.addEventListener('mouseleave', () => {
        document.getElementById('timeline-tooltip-overlay').classList.remove('visible');
      });

      el.onclick = (e) => flashIncidentNodes(inc, e);
      track.appendChild(el);
    });
  });
}

function flashIncidentNodes(incident, e) {
  // Remove previous active
  document.querySelectorAll('.timeline-incident.active').forEach(el => el.classList.remove('active'));
  e?.currentTarget?.classList.add('active');

  // Flash affected nodes
  incident.nodes.forEach(nodeId => {
    const nodeEl = nodeGroup.filter(n => n.id === nodeId);
    nodeEl.classed('incident-flash', false);
    // Force reflow
    nodeEl.each(function() { this.offsetWidth; });
    nodeEl.classed('incident-flash', true);
    setTimeout(() => nodeEl.classed('incident-flash', false), 1500);
  });

  // Show detail for first node
  const firstNode = NODES.find(n => n.id === incident.nodes[0]);
  if (firstNode) showNodeDetail(firstNode);
}

// Click on background → deselect
document.addEventListener('click', (e) => {
  if (e.target === document.getElementById('graphSvg') || e.target.tagName === 'svg') {
    document.getElementById('node-detail').classList.remove('visible');
    if (g) g.selectAll('.focus-ring').remove();
  }
});

// ══════════════════════════════════════════════════
// ATTACK RANKING
// ══════════════════════════════════════════════════
function buildAttackRanking() {
  const tabsContainer = document.getElementById('attackRankingTabs');
  const listContainer = document.getElementById('attackRankingList');
  const years = [2025, 2024, 2023];

  // Count CVEs + attacks per node per year
  function getNodeCounts(year) {
    const counts = {};
    NODES.forEach(n => {
      let count = 0;
      // Count CVEs by year from CVE ID (CVE-YYYY-NNNNN)
      (n.cves || []).forEach(cve => {
        const match = cve.id.match(/CVE-(\d{4})/);
        if (match && parseInt(match[1]) === year) count++;
      });
      // Count attacks by year
      (n.attacks || []).forEach(a => {
        const aYear = parseInt(a.date);
        if (aYear === year) count++;
      });
      if (count > 0) counts[n.id] = count;
    });
    return counts;
  }

  function renderYear(year, autoHighlight) {
    const counts = getNodeCounts(year);
    const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]).slice(0, 5);

    if (sorted.length === 0) {
      listContainer.innerHTML = '<div style="font-size:11px;color:#445;padding:8px;">No data for this year</div>';
      return;
    }

    const nodeIds = sorted.map(([nid]) => nid);

    listContainer.innerHTML = sorted.map(([nodeId, count], i) => {
      const node = nodeMap[nodeId];
      const color = node ? LAYERS[node.layer].color : '#667';
      return `<div class="attack-ranking-item" data-node-id="${nodeId}">
        <span class="attack-ranking-rank">${i + 1}</span>
        <span class="attack-ranking-name" style="color:${color}">${node ? node.label : nodeId}</span>
        <span class="attack-ranking-count">${count} CVE${count > 1 ? 's' : ''}</span>
      </div>`;
    }).join('');

    listContainer.querySelectorAll('.attack-ranking-item').forEach(el => {
      el.addEventListener('click', () => {
        const nodeId = el.dataset.nodeId;
        if (typeof focusNodeById === 'function') focusNodeById(nodeId);
      });
    });

    // Highlight all ranked nodes on the map
    if (autoHighlight && typeof highlightNodeGroup === 'function') {
      highlightNodeGroup(nodeIds);
    }
  }

  years.forEach((year, i) => {
    const tab = document.createElement('button');
    tab.className = 'attack-ranking-tab' + (i === 0 ? ' active' : '');
    tab.textContent = year;
    tab.onclick = () => {
      tabsContainer.querySelectorAll('.attack-ranking-tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      renderYear(year, true);
    };
    tabsContainer.appendChild(tab);
  });

  renderYear(years[0], false);
}

// ══════════════════════════════════════════════════
// RESEARCH LIBRARY
// ══════════════════════════════════════════════════
function buildResearchLibrary() {
  // Attack Patterns
  const patternsEl = document.getElementById('patternsContent');
  patternsEl.innerHTML = ATTACK_PATTERNS.map(p => `
    <div class="attack-pattern-card" data-nodes='${JSON.stringify(p.nodes)}'>
      <div class="pattern-title">
        <span class="pattern-dot" style="background:${p.color}"></span>
        ${p.label}
      </div>
      <div class="pattern-desc">${p.desc}</div>
      <div class="pattern-nodes">
        ${p.nodes.map(n => `<span class="pattern-node-tag">${nodeMap[n] ? nodeMap[n].label : n}</span>`).join('')}
      </div>
    </div>
  `).join('');

  // Click handler → highlightNodeGroup
  patternsEl.querySelectorAll('.attack-pattern-card').forEach(card => {
    card.addEventListener('click', () => {
      const nodes = JSON.parse(card.dataset.nodes);
      highlightNodeGroup(nodes);
    });
  });

  // Academic References
  const refsEl = document.getElementById('refsContent');
  const grouped = {};
  RESEARCH_REFS.forEach(r => {
    if (!grouped[r.category]) grouped[r.category] = [];
    grouped[r.category].push(r);
  });
  refsEl.innerHTML = Object.entries(grouped).map(([cat, refs]) => `
    <div class="ref-category">
      <div class="ref-category-title">${cat}</div>
      ${refs.map(r => `<div class="ref-item">
        ${r.url ? `<a href="${r.url}" target="_blank" rel="noopener">${r.title}</a>` : r.title}
        <span class="ref-venue">${r.venue}</span>
      </div>`).join('')}
    </div>
  `).join('');
}

function toggleResearchSection(section) {
  const btn = document.getElementById(section + 'Toggle');
  const content = document.getElementById(section + 'Content');
  const isOpen = btn.classList.contains('open');
  btn.classList.toggle('open');
  content.style.display = isOpen ? 'none' : 'block';
}

// ══════════════════════════════════════════════════
// GLOBAL focusNodeById
// ══════════════════════════════════════════════════
function focusNodeById(nodeId) {
  let targetData = null;
  nodeGroup.each(function(d) { if (d.id === nodeId) targetData = d; });
  if (!targetData) return;

  // Make sure layer is visible
  if (!activeFilters.has(targetData.layer)) {
    activeFilters.add(targetData.layer);
    const chip = document.querySelector(`.layer-chip[data-layer="${targetData.layer}"]`);
    if (chip) chip.classList.add('active');
  }

  // Clear year filter if node not visible
  if (activeYearFilter !== null && targetData.since > activeYearFilter) {
    activeYearFilter = null;
    document.querySelectorAll('.year-chip').forEach(c => c.classList.remove('active'));
    const allChip = document.querySelector('.year-chip[data-year="all"]');
    if (allChip) allChip.classList.add('active');
  }

  updateVisibility();

  // Pan + zoom
  const container = document.getElementById('main');
  const W = container.clientWidth;
  const H = container.clientHeight;
  const scale = 1.8;
  const tx = W / 2 - targetData.x * scale;
  const ty = H / 2 - targetData.y * scale;
  const transform = d3.zoomIdentity.translate(tx, ty).scale(scale);
  svg.transition().duration(700).ease(d3.easeCubicInOut).call(graphZoom.transform, transform);

  setTimeout(() => {
    const neighbors = new Set([targetData.id]);
    (adjForward[targetData.id] || []).forEach(n => neighbors.add(n));
    (adjReverse[targetData.id] || []).forEach(n => neighbors.add(n));

    nodeGroup.classed('dimmed', n => !neighbors.has(n.id));
    nodeGroup.classed('highlighted', n => neighbors.has(n.id));
    linkGroup.classed('dimmed', e => {
      const sid = e.source.id || e.source;
      const tid = e.target.id || e.target;
      return !(sid === targetData.id || tid === targetData.id);
    });

    // Remove previous focus rings
    g.selectAll('.focus-ring').remove();

    // Dashed spinning ring around the target
    const layerColor = LAYERS[targetData.layer].color;
    const focusR = targetData.r + 8;
    g.append('circle')
      .attr('class', 'focus-ring')
      .attr('cx', targetData.x).attr('cy', targetData.y)
      .attr('r', focusR)
      .attr('stroke', layerColor);

    // Also add a search ping
    const ring = g.append('circle')
      .attr('class', 'search-ring')
      .attr('cx', targetData.x).attr('cy', targetData.y)
      .attr('r', targetData.r + 5);
    setTimeout(() => ring.remove(), 1300);

    // Remove focus ring after 5 seconds
    setTimeout(() => g.selectAll('.focus-ring').remove(), 5000);

    showNodeDetail(targetData);
  }, 750);
}

// Highlight multiple nodes at once (for attack ranking year tab)
function highlightNodeGroup(nodeIds) {
  if (!nodeIds || nodeIds.length === 0) return;
  const idSet = new Set(nodeIds);

  // Collect all neighbors for all target nodes
  const allRelated = new Set(nodeIds);
  nodeIds.forEach(nid => {
    (adjForward[nid] || []).forEach(n => allRelated.add(n));
    (adjReverse[nid] || []).forEach(n => allRelated.add(n));
  });

  // Ensure all layers are visible
  nodeIds.forEach(nid => {
    const nd = nodeMap[nid];
    if (nd && !activeFilters.has(nd.layer)) {
      activeFilters.add(nd.layer);
      const chip = document.querySelector(`.layer-chip[data-layer="${nd.layer}"]`);
      if (chip) chip.classList.add('active');
    }
  });

  // Clear year filter if any target is hidden
  if (activeYearFilter !== null) {
    const anyHidden = nodeIds.some(nid => nodeMap[nid] && nodeMap[nid].since > activeYearFilter);
    if (anyHidden) {
      activeYearFilter = null;
      document.querySelectorAll('.year-chip').forEach(c => c.classList.remove('active'));
      const allChip = document.querySelector('.year-chip[data-year="all"]');
      if (allChip) allChip.classList.add('active');
    }
  }
  updateVisibility();

  // Zoom to fit all target nodes
  const targets = nodeIds.map(nid => { let d = null; nodeGroup.each(function(n) { if (n.id === nid) d = n; }); return d; }).filter(Boolean);
  if (targets.length === 0) return;

  const xs = targets.map(d => d.x);
  const ys = targets.map(d => d.y);
  const minX = Math.min(...xs) - 60, maxX = Math.max(...xs) + 60;
  const minY = Math.min(...ys) - 60, maxY = Math.max(...ys) + 60;
  const container = document.getElementById('main');
  const W = container.clientWidth;
  const H = container.clientHeight;
  const scale = Math.min(W / (maxX - minX), H / (maxY - minY), 2.0);
  const cx = (minX + maxX) / 2;
  const cy = (minY + maxY) / 2;
  const tx = W / 2 - cx * scale;
  const ty = H / 2 - cy * scale;
  const transform = d3.zoomIdentity.translate(tx, ty).scale(scale);
  svg.transition().duration(700).ease(d3.easeCubicInOut).call(graphZoom.transform, transform);

  setTimeout(() => {
    // Dim non-related, highlight related
    nodeGroup.classed('dimmed', n => !allRelated.has(n.id));
    nodeGroup.classed('highlighted', n => idSet.has(n.id));
    linkGroup.classed('dimmed', e => {
      const sid = e.source.id || e.source;
      const tid = e.target.id || e.target;
      return !(idSet.has(sid) || idSet.has(tid));
    });

    // Focus rings on all targets
    g.selectAll('.focus-ring').remove();
    targets.forEach(d => {
      const layerColor = LAYERS[d.layer].color;
      g.append('circle')
        .attr('class', 'focus-ring')
        .attr('cx', d.x).attr('cy', d.y)
        .attr('r', d.r + 8)
        .attr('stroke', layerColor);
    });

    setTimeout(() => g.selectAll('.focus-ring').remove(), 8000);
  }, 750);
}

// ══════════════════════════════════════════════════
// SEARCH
// ══════════════════════════════════════════════════
(function initSearch() {
  const input = document.getElementById('searchInput');
  const dropdown = document.getElementById('searchDropdown');
  const clearBtn = document.getElementById('searchClear');
  const kbdHint = document.querySelector('.search-kbd');
  let activeIdx = -1;
  let results = [];

  function getResults(query) {
    if (!query) return [];
    const q = query.toLowerCase();
    return NODES
      .filter(n => n.label.toLowerCase().includes(q) || n.id.toLowerCase().includes(q) || LAYERS[n.layer].name.toLowerCase().includes(q))
      .sort((a, b) => {
        const aStart = a.label.toLowerCase().startsWith(q) ? 0 : 1;
        const bStart = b.label.toLowerCase().startsWith(q) ? 0 : 1;
        return aStart - bStart || a.label.localeCompare(b.label);
      });
  }

  function highlightText(text, query) {
    const idx = text.toLowerCase().indexOf(query.toLowerCase());
    if (idx === -1) return text;
    return text.slice(0, idx) + '<mark>' + text.slice(idx, idx + query.length) + '</mark>' + text.slice(idx + query.length);
  }

  function renderDropdown() {
    const q = input.value.trim();
    results = getResults(q);
    activeIdx = -1;

    if (!q) { dropdown.classList.remove('visible'); return; }

    if (results.length === 0) {
      dropdown.innerHTML = '<div class="search-empty">No nodes found</div>';
      dropdown.classList.add('visible');
      return;
    }

    dropdown.innerHTML = results.map((n, i) =>
      `<div class="search-item" data-idx="${i}">
        <div class="search-item-dot" style="background:${LAYERS[n.layer].color}"></div>
        <span class="search-item-name">${highlightText(n.label, q)}</span>
        <span class="search-item-layer">${LAYERS[n.layer].name}</span>
      </div>`
    ).join('');

    dropdown.classList.add('visible');

    dropdown.querySelectorAll('.search-item').forEach(el => {
      el.addEventListener('mousedown', (e) => {
        e.preventDefault();
        selectResult(parseInt(el.dataset.idx));
      });
    });
  }

  function setActiveItem(idx) {
    const items = dropdown.querySelectorAll('.search-item');
    items.forEach(el => el.classList.remove('active'));
    if (idx >= 0 && idx < items.length) {
      items[idx].classList.add('active');
      items[idx].scrollIntoView({ block: 'nearest' });
    }
    activeIdx = idx;
  }

  function selectResult(idx) {
    const node = results[idx];
    if (!node) return;

    input.value = node.label;
    dropdown.classList.remove('visible');
    clearBtn.style.display = 'block';
    kbdHint.style.display = 'none';

    focusNode(node.id);
  }

  function focusNode(nodeId) {
    focusNodeById(nodeId);
  }

  function clearSearch() {
    input.value = '';
    dropdown.classList.remove('visible');
    clearBtn.style.display = 'none';
    kbdHint.style.display = '';
    activeIdx = -1;
    results = [];
    if (!simMode) {
      nodeGroup.classed('dimmed', false).classed('highlighted', false);
      linkGroup.classed('dimmed', false);
    }
  }

  // Event listeners
  input.addEventListener('input', renderDropdown);

  input.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      if (results.length) setActiveItem(Math.min(activeIdx + 1, results.length - 1));
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      if (results.length) setActiveItem(Math.max(activeIdx - 1, 0));
    } else if (e.key === 'Enter') {
      e.preventDefault();
      if (activeIdx >= 0) selectResult(activeIdx);
      else if (results.length === 1) selectResult(0);
    } else if (e.key === 'Escape') {
      if (input.value) clearSearch();
      else input.blur();
    }
  });

  input.addEventListener('focus', () => {
    kbdHint.style.display = 'none';
    if (input.value.trim()) renderDropdown();
  });

  input.addEventListener('blur', () => {
    setTimeout(() => dropdown.classList.remove('visible'), 150);
    if (!input.value.trim()) kbdHint.style.display = '';
  });

  clearBtn.addEventListener('click', () => { clearSearch(); input.focus(); });

  // Global "/" shortcut to focus search (works in any keyboard layout)
  document.addEventListener('keydown', (e) => {
    if ((e.key === '/' || e.code === 'Slash') && !e.ctrlKey && !e.altKey && !e.metaKey
        && document.activeElement !== input
        && document.activeElement.tagName !== 'INPUT'
        && document.activeElement.tagName !== 'TEXTAREA') {
      e.preventDefault();
      e.stopPropagation();
      setTimeout(() => { input.focus(); input.select(); }, 0);
    }
  });
})();

// ══════════════════════════════════════════════════
// ATTACK PATH CALCULATOR
// ══════════════════════════════════════════════════

function parseMaintainerCount(str) {
    if (!str) return 99;
    const m = str.match(/\(~?(\d+)\)/);
    if (m) return parseInt(m[1]);
    if (str.match(/corp|inc|team|foundation/i)) return 99;
    return str.split(/[,&+]/).length;
}

function isEntryPoint(nodeId) {
    const node = nodeMap[nodeId];
    if (!node) return false;
    if (node.layer === 'hardware') return true;
    if (nodeId === 'setuptools') return true;
    if (nodeId === 'hf-hub') return true;
    if (node.attacks && node.attacks.length > 0) return true;
    const mc = parseMaintainerCount(node.maintainers);
    if (mc <= 5 && node.downloads > 50000000) return true;
    return false;
}

function computeAttackPaths(targetId, maxDepth, maxPaths) {
    maxDepth = maxDepth || 5;
    maxPaths = maxPaths || 8;
    const allPaths = [];

    function dfs(currentId, path, visited, depth) {
        if (depth > maxDepth) return;
        const deps = adjForward[currentId] || [];
        for (const dep of deps) {
            if (visited.has(dep)) continue;
            const newPath = [dep].concat(path);
            if (isEntryPoint(dep)) {
                allPaths.push(newPath.slice());
            }
            visited.add(dep);
            dfs(dep, newPath, visited, depth + 1);
            visited.delete(dep);
        }
    }

    dfs(targetId, [targetId], new Set([targetId]), 0);

    const scoredPaths = allPaths.map(function(path) {
        return {
            path: path,
            score: computePathScore(path),
            atlas: mapPathToATLAS(path),
            incidents: findRelatedIncidents(path),
        };
    });

    return scoredPaths.sort(function(a, b) { return b.score - a.score; }).slice(0, maxPaths);
}

function computePathScore(path) {
    let score = 0;
    for (const nodeId of path) {
        const node = nodeMap[nodeId];
        if (!node) continue;
        score += node.risk * 0.3;
        score += (node.attacks ? node.attacks.length : 0) * 15;
        score += (node.cves ? node.cves.length : 0) * 10;
        const mc = parseMaintainerCount(node.maintainers);
        if (mc <= 5) score += 20;
        if (mc <= 3) score += 15;
    }
    score *= (1 / Math.sqrt(path.length));
    const atlasCount = mapPathToATLAS(path).filter(function(a) { return a.technique; }).length;
    score += atlasCount * 12;
    return Math.round(Math.min(score, 100));
}

function mapPathToATLAS(path) {
    const result = [];
    for (let i = 0; i < path.length - 1; i++) {
        const srcNode = nodeMap[path[i]];
        const tgtNode = nodeMap[path[i + 1]];
        let matched = null;
        for (const rule of ATLAS_EDGE_RULES) {
            if (rule.condition(srcNode || {}, tgtNode || {})) {
                matched = { technique: rule.technique, label: rule.label };
                break;
            }
        }
        result.push(matched || { technique: 'AML.T0010', label: 'ML supply chain dependency' });
    }
    return result;
}

function findRelatedIncidents(path) {
    const pathNodeIds = new Set(path);
    return INCIDENTS.filter(function(inc) {
        return inc.nodes.some(function(nid) { return pathNodeIds.has(nid); });
    }).map(function(inc) {
        return {
            id: inc.id,
            date: inc.date,
            label: inc.label,
            matchedNodes: inc.nodes.filter(function(nid) { return pathNodeIds.has(nid); }),
        };
    });
}

function toggleAttackPathMode() {
    attackPathMode = !attackPathMode;
    const btn = document.getElementById('atkBtn');
    const hint = document.getElementById('graphHint');

    if (attackPathMode) {
        // Disable sim mode if active
        if (simMode) { toggleSimMode(); }
        btn.classList.add('active');
        hint.textContent = 'Click a target node to compute attack paths';
    } else {
        btn.classList.remove('active');
        hint.textContent = 'scroll: zoom \u00B7 drag: navigate \u00B7 click: details';
        clearAttackPathHighlight();
        document.getElementById('attack-paths-panel').classList.remove('visible');
    }
}

function renderPathCard(pathData, index) {
    const hopLabels = ['\u2460','\u2461','\u2462','\u2463','\u2464','\u2465','\u2466','\u2467'];
    let stepsHtml = '';
    for (let i = 0; i < pathData.path.length; i++) {
        const nodeId = pathData.path[i];
        const node = nodeMap[nodeId];
        const label = node ? node.label : nodeId;
        const isTarget = i === pathData.path.length - 1;
        let atlasHtml = '';
        if (i < pathData.atlas.length) {
            const a = pathData.atlas[i];
            const tech = ATLAS_TECHNIQUES[a.technique];
            if (tech) {
                atlasHtml = '<div class="path-step-atlas">\u2193 <a href="' + tech.url + '" target="_blank" title="' + tech.name + '">' + a.technique + '</a> ' + a.label + '</div>';
            }
        }
        let incHtml = '';
        const nodeIncs = pathData.incidents.filter(function(inc) { return inc.matchedNodes.includes(nodeId); });
        if (nodeIncs.length > 0) {
            incHtml = nodeIncs.map(function(inc) {
                return '<div class="path-step-incident">' + inc.id + ': ' + inc.label.substring(0, 40) + '</div>';
            }).join('');
        }
        stepsHtml += '<div class="path-step">' +
            '<div class="path-step-number">' + hopLabels[i] + '</div>' +
            '<div class="path-step-content">' +
            '<div class="path-step-node" style="color:' + (node ? LAYERS[node.layer].color : '#ddd') + '">' + label + (isTarget ? ' [TARGET]' : '') + '</div>' +
            atlasHtml + incHtml +
            '</div></div>';
    }

    return '<div class="attack-path-card" data-path-idx="' + index + '" ' +
        'onmouseenter="highlightAttackPathByIdx(' + index + ')" ' +
        'onmouseleave="clearAttackPathHighlight()">' +
        '<div class="path-header">' +
        '<div class="path-title">Path ' + (index + 1) + ' \u2014 ' + pathData.path.length + ' hops</div>' +
        '<div class="path-score">' + pathData.score + '/100</div>' +
        '</div>' + stepsHtml + '</div>';
}

// Store last computed paths for hover highlight
let lastComputedPaths = [];

function renderAttackPaths(targetNode) {
    const panel = document.getElementById('attack-paths-panel');
    const listEl = document.getElementById('attackPathsList');
    const emptyEl = document.getElementById('atkPathsEmpty');

    document.getElementById('atkTargetName').textContent = targetNode.label;
    document.getElementById('node-detail').classList.remove('visible');
    document.getElementById('compromise-panel').classList.remove('visible');

    lastComputedPaths = computeAttackPaths(targetNode.id);

    if (lastComputedPaths.length === 0) {
        listEl.innerHTML = '';
        emptyEl.style.display = 'block';
        document.getElementById('atkPathsCount').textContent = '';
    } else {
        emptyEl.style.display = 'none';
        document.getElementById('atkPathsCount').textContent = lastComputedPaths.length + ' path' + (lastComputedPaths.length > 1 ? 's' : '') + ' found';
        listEl.innerHTML = lastComputedPaths.map(function(pd, idx) { return renderPathCard(pd, idx); }).join('');
    }

    panel.classList.add('visible');
    panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function highlightAttackPathByIdx(idx) {
    if (idx >= 0 && idx < lastComputedPaths.length) {
        highlightAttackPath(lastComputedPaths[idx].path);
    }
}

function highlightAttackPath(path) {
    clearAttackPathHighlight();
    if (!path || path.length < 2) return;

    const pathSet = new Set(path);
    const hopLabels = ['\u2460','\u2461','\u2462','\u2463','\u2464','\u2465','\u2466','\u2467'];

    // Dim non-path nodes
    nodeGroup.classed('dimmed', function(n) { return !pathSet.has(n.id); });
    nodeGroup.classed('highlighted', function(n) { return pathSet.has(n.id); });

    // Dim non-path edges
    linkGroup.classed('dimmed', true);

    // Draw attack path edges
    const pathEdges = [];
    for (let i = 0; i < path.length - 1; i++) {
        pathEdges.push({ source: path[i], target: path[i + 1] });
    }

    // Find node positions
    const posMap = {};
    nodeGroup.each(function(n) { if (pathSet.has(n.id)) posMap[n.id] = { x: n.x, y: n.y }; });

    // Draw animated dashed path edges
    pathEdges.forEach(function(edge) {
        const sp = posMap[edge.source];
        const tp = posMap[edge.target];
        if (!sp || !tp) return;
        g.append('line')
            .attr('class', 'atk-path-edge')
            .attr('x1', sp.x).attr('y1', sp.y)
            .attr('x2', tp.x).attr('y2', tp.y);
    });

    // Draw hop number labels
    path.forEach(function(nodeId, i) {
        const pos = posMap[nodeId];
        if (!pos) return;
        g.append('text')
            .attr('class', 'atk-hop-label')
            .attr('x', pos.x).attr('y', pos.y - 18)
            .text(hopLabels[i] || (i + 1));
    });
}

function clearAttackPathHighlight() {
    if (!g) return;
    g.selectAll('.atk-path-edge').remove();
    g.selectAll('.atk-hop-label').remove();
    if (!attackPathMode) {
        nodeGroup.classed('dimmed', false).classed('highlighted', false);
        linkGroup.classed('dimmed', false);
    }
}

// ══════════════════════════════════════════════════
// TEMPORAL HEATMAP
// ══════════════════════════════════════════════════

function toggleSidebar() {
    var app = document.getElementById('app');
    var btn = document.getElementById('sidebarToggle');
    app.classList.toggle('sidebar-hidden');
    btn.innerHTML = app.classList.contains('sidebar-hidden') ? '&#x25B6;' : '&#x25C0;';
}

function switchView(view) {
    if (view === currentView) return;
    currentView = view;

    // Exit attack path and sim modes when switching to heatmap
    if (view === 'heatmap') {
        if (attackPathMode) toggleAttackPathMode();
        if (simMode) toggleSimMode();
    }

    document.getElementById('viewGraph').classList.toggle('active', view === 'graph');
    document.getElementById('viewHeatmap').classList.toggle('active', view === 'heatmap');
    document.getElementById('graphSvg').style.display = view === 'graph' ? '' : 'none';
    document.getElementById('heatmapSvg').style.display = view === 'heatmap' ? '' : 'none';
    document.getElementById('graphHint').style.display = view === 'graph' ? '' : 'none';

    if (view === 'heatmap') renderHeatmap();
}

function computeHeatmapData() {
    const quarters = [];
    for (let y = 2022; y <= 2026; y++) {
        for (let q = 1; q <= 4; q++) {
            if (y === 2022 && q < 4) continue;
            if (y === 2026 && q > 1) continue;
            quarters.push({ year: y, quarter: q, label: 'Q' + q + "'" + String(y).slice(2) });
        }
    }

    const grid = {};
    NODES.forEach(function(node) {
        grid[node.id] = {};
        quarters.forEach(function(q) {
            let count = 0;
            (node.cves || []).forEach(function(cve) {
                var m = cve.id.match(/CVE-(\d{4})/);
                if (m) {
                    var cveYear = parseInt(m[1]);
                    if (cveYear === q.year && q.quarter === 1) count++;
                }
            });
            (node.attacks || []).forEach(function(a) {
                var parts = a.date.split('-');
                var aYear = parseInt(parts[0]);
                var aMonth = parts[1] ? parseInt(parts[1]) : 1;
                var aQuarter = Math.ceil(aMonth / 3);
                if (aYear === q.year && aQuarter === q.quarter) count++;
            });
            INCIDENTS.forEach(function(inc) {
                if (!inc.nodes.includes(node.id)) return;
                var parts = inc.date.split('-');
                var iYear = parseInt(parts[0]);
                var iMonth = parts[1] ? parseInt(parts[1]) : 1;
                var iQuarter = Math.ceil(iMonth / 3);
                if (iYear === q.year && iQuarter === q.quarter) count++;
            });
            grid[node.id][q.year + '-Q' + q.quarter] = count;
        });
    });

    return { quarters: quarters, grid: grid };
}

var heatmapZoom = null;

function renderHeatmap() {
    var hmSvg = d3.select('#heatmapSvg');
    hmSvg.selectAll('*').remove();

    var data = computeHeatmapData();
    var quarters = data.quarters;
    var grid = data.grid;

    // Filter to nodes with events and matching current filters
    var activeNodes = NODES.filter(function(n) {
        if (!activeFilters.has(n.layer)) return false;
        return Object.values(grid[n.id]).some(function(v) { return v > 0; });
    }).sort(function(a, b) {
        var ld = LAYERS[a.layer].order - LAYERS[b.layer].order;
        if (ld !== 0) return ld;
        return b.risk - a.risk;
    });

    if (activeNodes.length === 0) {
        hmSvg.append('text').attr('x', 200).attr('y', 80).attr('fill', '#556').attr('font-size', 14)
            .text('No events to display. Adjust filters.');
        return;
    }

    var cellW = 56, cellH = 32, cellGap = 3;
    var labelW = 160, headerH = 60, layerGapH = 20;
    var riskBarW = 40;

    // Pre-compute layer groups with gap rows
    var rows = [];
    var prevLayer = null;
    activeNodes.forEach(function(node) {
        if (node.layer !== prevLayer) {
            rows.push({ type: 'layer', layer: node.layer });
            prevLayer = node.layer;
        }
        rows.push({ type: 'node', node: node });
    });

    var totalH = headerH;
    rows.forEach(function(r) { totalH += r.type === 'layer' ? layerGapH : cellH; });
    totalH += 50; // legend

    var gridW = quarters.length * cellW;
    var W = labelW + riskBarW + gridW + 30;
    var H = totalH;

    // Set up zoom + pan
    var hmG = hmSvg.append('g');
    heatmapZoom = d3.zoom()
        .scaleExtent([0.3, 6])
        .on('zoom', function(event) { hmG.attr('transform', event.transform); });
    hmSvg.call(heatmapZoom);

    // Fit to container
    var container = document.getElementById('main');
    var cW = container.clientWidth;
    var cH = container.clientHeight;
    var initScale = Math.min(cW / (W + 20), cH / (H + 20), 2.0) * 0.92;
    var initX = (cW - W * initScale) / 2;
    var initY = Math.max((cH - H * initScale) / 2, 8);
    hmSvg.call(heatmapZoom.transform, d3.zoomIdentity.translate(initX, initY).scale(initScale));

    var maxVal = 0;
    activeNodes.forEach(function(n) {
        var mx = d3.max(Object.values(grid[n.id]));
        if (mx > maxVal) maxVal = mx;
    });
    if (maxVal === 0) maxVal = 1;

    var colorScale = d3.scaleSequential(d3.interpolateYlOrRd).domain([0, maxVal + 0.5]);
    var gridX0 = labelW + riskBarW;

    // ── Year headers ──
    var yearGroups = {};
    quarters.forEach(function(q, qi) {
        if (!yearGroups[q.year]) yearGroups[q.year] = { start: qi, count: 0 };
        yearGroups[q.year].count++;
    });
    Object.keys(yearGroups).forEach(function(yr) {
        var yg = yearGroups[yr];
        var cx = gridX0 + (yg.start + yg.count / 2) * cellW;
        hmG.append('text').attr('class', 'hm-year-label')
            .attr('x', cx).attr('y', 16).text(yr);
        // year separator line
        if (yg.start > 0) {
            hmG.append('line')
                .attr('x1', gridX0 + yg.start * cellW - 1).attr('x2', gridX0 + yg.start * cellW - 1)
                .attr('y1', 24).attr('y2', H - 50)
                .attr('stroke', 'rgba(255,255,255,0.06)').attr('stroke-width', 1);
        }
    });

    // ── Quarter sub-headers ──
    quarters.forEach(function(q, qi) {
        var isActive = activeYearFilter === null || activeYearFilter === q.year;
        hmG.append('text').attr('class', 'heatmap-quarter-label')
            .attr('x', gridX0 + qi * cellW + cellW / 2)
            .attr('y', headerH - 16)
            .attr('opacity', isActive ? 1 : 0.3)
            .text('Q' + q.quarter);
    });

    // ── Header separator ──
    hmG.append('line')
        .attr('x1', labelW).attr('x2', gridX0 + gridW)
        .attr('y1', headerH - 6).attr('y2', headerH - 6)
        .attr('stroke', 'rgba(255,255,255,0.08)').attr('stroke-width', 1);

    // "Risk" column label
    hmG.append('text')
        .attr('x', labelW + riskBarW / 2).attr('y', headerH - 16)
        .attr('text-anchor', 'middle')
        .attr('font-size', 8).attr('fill', '#556').attr('font-family', "'JetBrains Mono', monospace")
        .attr('text-transform', 'uppercase').attr('letter-spacing', '1px')
        .text('RISK');

    // ── Rows ──
    var curY = headerH;
    rows.forEach(function(row) {
        if (row.type === 'layer') {
            // Layer group header
            var lc = LAYERS[row.layer].color;
            hmG.append('rect').attr('class', 'hm-layer-bg')
                .attr('x', 0).attr('y', curY)
                .attr('width', W).attr('height', layerGapH)
                .attr('fill', lc);
            hmG.append('text').attr('class', 'heatmap-layer-label')
                .attr('x', 8).attr('y', curY + layerGapH / 2 + 3)
                .attr('fill', lc)
                .text(LAYERS[row.layer].name.toUpperCase());
            curY += layerGapH;
            return;
        }

        var node = row.node;
        var y = curY;

        // Invisible wide hover rect for row highlight
        hmG.append('rect').attr('class', 'hm-row-hover')
            .attr('x', 0).attr('y', y).attr('width', W).attr('height', cellH);

        // Alternating row tint
        var rowIdx = activeNodes.indexOf(node);
        if (rowIdx % 2 === 0) {
            hmG.append('rect')
                .attr('x', gridX0).attr('y', y)
                .attr('width', gridW).attr('height', cellH)
                .attr('fill', 'rgba(255,255,255,0.015)');
        }

        // Node label with layer-colored dot
        var dotR = 4;
        hmG.append('circle')
            .attr('cx', labelW - 18 - dotR).attr('cy', y + cellH / 2)
            .attr('r', dotR).attr('fill', LAYERS[node.layer].color).attr('opacity', 0.7);

        hmG.append('text').attr('class', 'heatmap-label')
            .attr('x', labelW - 26 - dotR * 2).attr('y', y + cellH / 2 + 4)
            .attr('text-anchor', 'end')
            .text(node.label.length > 18 ? node.label.substring(0, 17) + '\u2026' : node.label)
            .on('click', function() { onHeatmapLabelClick(node.id); })
            .append('title').text(node.label + ' \u2014 risk: ' + node.risk + '/100');

        // Risk mini-bar
        var riskW = (node.risk / 100) * (riskBarW - 8);
        var riskColor = node.risk >= 85 ? '#ff1744' : node.risk >= 65 ? '#ff9100' : '#ffea00';
        hmG.append('rect').attr('class', 'hm-risk-bar')
            .attr('x', labelW + 2).attr('y', y + cellH / 2 - 3)
            .attr('width', riskW).attr('height', 6)
            .attr('rx', 3).attr('fill', riskColor);

        // Grid cells — draw bg for all, colored for events
        quarters.forEach(function(q, qi) {
            var cx = gridX0 + qi * cellW;
            var key = q.year + '-Q' + q.quarter;
            var val = grid[node.id][key] || 0;
            var isActiveQ = activeYearFilter === null || activeYearFilter === q.year;

            // Background cell (subtle grid)
            hmG.append('rect').attr('class', 'hm-bg-cell')
                .attr('x', cx + cellGap / 2).attr('y', y + cellGap / 2)
                .attr('width', cellW - cellGap).attr('height', cellH - cellGap)
                .attr('rx', 4)
                .attr('opacity', isActiveQ ? 1 : 0.3);

            if (val > 0) {
                hmG.append('rect').attr('class', 'heatmap-cell')
                    .attr('x', cx + cellGap / 2).attr('y', y + cellGap / 2)
                    .attr('width', cellW - cellGap).attr('height', cellH - cellGap)
                    .attr('rx', 4)
                    .attr('fill', colorScale(val))
                    .attr('opacity', isActiveQ ? 0.9 : 0.2)
                    .on('click', function() { onHeatmapCellClick(node.id, q); })
                    .on('mouseenter', function(event) { onHeatmapCellHover(event, node, q, val); })
                    .on('mouseleave', function() {
                        document.getElementById('heatmapTooltip').classList.remove('visible');
                    });

                // Count number inside cell
                hmG.append('text').attr('class', 'hm-cell-text')
                    .attr('x', cx + cellW / 2).attr('y', y + cellH / 2)
                    .attr('opacity', isActiveQ ? 0.95 : 0.3)
                    .text(val);
            }
        });

        curY += cellH;
    });

    // ── Color legend ──
    var legendY = curY + 16;
    var legendX = gridX0;
    var legendW = 160, legendH = 10, legendSteps = 40;
    hmG.append('text').attr('x', legendX).attr('y', legendY - 4)
        .attr('font-size', 9).attr('fill', '#556').attr('font-family', "'JetBrains Mono', monospace")
        .text('Events');
    for (var li = 0; li < legendSteps; li++) {
        hmG.append('rect')
            .attr('x', legendX + li * (legendW / legendSteps))
            .attr('y', legendY)
            .attr('width', legendW / legendSteps + 0.5)
            .attr('height', legendH)
            .attr('fill', colorScale(li / legendSteps * maxVal));
    }
    hmG.append('text').attr('class', 'hm-legend-label').attr('x', legendX).attr('y', legendY + legendH + 10).text('0');
    hmG.append('text').attr('class', 'hm-legend-label').attr('x', legendX + legendW).attr('y', legendY + legendH + 10).text(maxVal);
}

function onHeatmapCellClick(nodeId, quarter) {
    var node = nodeMap[nodeId];
    if (node) showNodeDetail(node);
}

function onHeatmapCellHover(event, node, quarter, count) {
    var tooltip = document.getElementById('heatmapTooltip');
    var key = quarter.year + '-Q' + quarter.quarter;

    // Gather CVE and incident details for this node + quarter
    var details = [];
    (node.cves || []).forEach(function(cve) {
        var m = cve.id.match(/CVE-(\d{4})/);
        if (m && parseInt(m[1]) === quarter.year && quarter.quarter === 1) {
            details.push('<span style="color:#ff9100">' + cve.id + '</span> (CVSS ' + cve.cvss + ')');
        }
    });
    (node.attacks || []).forEach(function(a) {
        var parts = a.date.split('-');
        var aQ = Math.ceil((parts[1] ? parseInt(parts[1]) : 1) / 3);
        if (parseInt(parts[0]) === quarter.year && aQ === quarter.quarter) {
            details.push('<span style="color:#ff1744">' + a.label.substring(0, 50) + '</span>');
        }
    });
    INCIDENTS.forEach(function(inc) {
        if (!inc.nodes.includes(node.id)) return;
        var parts = inc.date.split('-');
        var iQ = Math.ceil((parts[1] ? parseInt(parts[1]) : 1) / 3);
        if (parseInt(parts[0]) === quarter.year && iQ === quarter.quarter) {
            details.push('<span style="color:#d500f9">' + inc.label.substring(0, 50) + '</span>');
        }
    });

    tooltip.innerHTML = '<div style="font-weight:600;color:' + LAYERS[node.layer].color + ';margin-bottom:4px">' + node.label + '</div>' +
        '<div style="font-size:10px;color:#889;margin-bottom:4px">' + quarter.label + ' \u2014 ' + count + ' event' + (count > 1 ? 's' : '') + '</div>' +
        details.join('<br>');
    tooltip.classList.add('visible');
    tooltip.style.left = (event.clientX + 12) + 'px';
    tooltip.style.top = (event.clientY - 10) + 'px';
}

function onHeatmapLabelClick(nodeId) {
    switchView('graph');
    setTimeout(function() { focusNodeById(nodeId); }, 100);
}

// ══════════════════════════════════════════════════
// LLM CHAT INTERFACE
// ══════════════════════════════════════════════════

function initChat() {
    var input = document.getElementById('chatInput');
    if (!input) return;
    input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendChatMessage();
        }
        if (e.key === 'Escape') {
            var chat = document.getElementById('llm-chat');
            if (!chat.classList.contains('collapsed')) toggleChat();
        }
    });
}

function toggleChat() {
    var chat = document.getElementById('llm-chat');
    var btn = document.getElementById('chatMinBtn');
    chat.classList.toggle('collapsed');
    btn.innerHTML = chat.classList.contains('collapsed') ? '\u25BC' : '\u25B2';
}

function openSettings() {
    var overlay = document.getElementById('settingsOverlay');
    var input = document.getElementById('groqKeyInput');
    input.value = localStorage.getItem('groq_api_key') || '';
    overlay.classList.add('visible');
}

function closeSettings() {
    document.getElementById('settingsOverlay').classList.remove('visible');
}

function saveSettings() {
    var key = document.getElementById('groqKeyInput').value.trim();
    if (key) {
        localStorage.setItem('groq_api_key', key);
    } else {
        localStorage.removeItem('groq_api_key');
    }
    closeSettings();
}

function buildSystemPrompt() {
    var nodesSummary = NODES.map(function(n) {
        return {
            id: n.id, label: n.label, layer: n.layer,
            risk: n.risk, downloads: n.downloads,
            cveCount: n.cves ? n.cves.length : 0,
            attackCount: n.attacks ? n.attacks.length : 0,
            maintainers: n.maintainers,
            deps: adjForward[n.id] ? adjForward[n.id].length : 0,
            dependents: adjReverse[n.id] ? adjReverse[n.id].length : 0,
        };
    });

    var incidentsSummary = INCIDENTS.map(function(i) {
        return { id: i.id, date: i.date, label: i.label, nodes: i.nodes };
    });

    return 'You are an AI security analyst assistant for an interactive ML Supply Chain Dependency Map.\n\n' +
        '## Your Knowledge Base\n' +
        'You have access to a graph of ' + NODES.length + ' packages in the ML/AI ecosystem with ' + EDGES.length + ' dependency edges and ' + INCIDENTS.length + ' real-world security incidents.\n\n' +
        '## Node Data (JSON):\n' + JSON.stringify(nodesSummary) + '\n\n' +
        '## Incidents (JSON):\n' + JSON.stringify(incidentsSummary) + '\n\n' +
        '## MITRE ATLAS Techniques You Know:\n' +
        Object.values(ATLAS_TECHNIQUES).map(function(t) { return '- ' + t.id + ': ' + t.name; }).join('\n') + '\n\n' +
        '## Your Capabilities\n' +
        '1. Analyze attack paths between nodes\n' +
        '2. Identify highest-risk components and why\n' +
        '3. Map threats to MITRE ATLAS techniques\n' +
        '4. Reference real incidents from the data\n' +
        '5. Suggest which nodes to patch/monitor first\n\n' +
        '## Response Format\n' +
        '- Be concise (3-5 sentences for simple questions)\n' +
        '- Reference specific node IDs, CVE IDs, and incident IDs\n' +
        '- When you mention a node, wrap it in brackets: [numpy], [vLLM]\n' +
        '- When you mention an ATLAS technique, format as: AML.T0010\n' +
        '- When suggesting to highlight nodes, output: HIGHLIGHT:[node1,node2,node3]\n' +
        '- When suggesting to run a simulation, output: SIMULATE:[nodeId]\n' +
        '- When suggesting to focus on a node, output: FOCUS:[nodeId]\n\n' +
        '## Tone\n' +
        'Technical, precise, direct. No fluff. Think threat intelligence analyst writing a brief.';
}

async function queryLLM(userMessage) {
    var apiKey = localStorage.getItem('groq_api_key');
    if (!apiKey) {
        return { error: 'No API key. Open settings (\u2699) to enter your Groq key.' };
    }

    var messages = [
        { role: 'system', content: buildSystemPrompt() }
    ].concat(chatHistory.slice(-6)).concat([
        { role: 'user', content: userMessage }
    ]);

    try {
        var response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + apiKey,
            },
            body: JSON.stringify({
                model: 'llama-3.3-70b-versatile',
                messages: messages,
                max_tokens: 1024,
                temperature: 0.3,
            }),
        });

        if (!response.ok) {
            var err = await response.json().catch(function() { return {}; });
            return { error: 'API error: ' + ((err.error && err.error.message) || response.status) };
        }

        var responseData = await response.json();
        var reply = responseData.choices[0].message.content;
        parseAndExecuteActions(reply);
        return { text: reply };
    } catch (err) {
        return { error: 'Network error: ' + err.message };
    }
}

async function sendChatMessage() {
    var input = document.getElementById('chatInput');
    var msg = input.value.trim();
    if (!msg) return;
    input.value = '';

    // Expand chat if collapsed
    var chat = document.getElementById('llm-chat');
    if (chat.classList.contains('collapsed')) toggleChat();

    addChatBubble('user', msg);
    chatHistory.push({ role: 'user', content: msg });

    // Show typing indicator
    var msgsEl = document.getElementById('chatMessages');
    var typingEl = document.createElement('div');
    typingEl.className = 'chat-msg ai';
    typingEl.id = 'chatTyping';
    typingEl.innerHTML = '<div class="msg-bubble chat-typing"><span></span><span></span><span></span></div>';
    msgsEl.appendChild(typingEl);
    msgsEl.scrollTop = msgsEl.scrollHeight;

    var result = await queryLLM(msg);

    // Remove typing indicator
    var ti = document.getElementById('chatTyping');
    if (ti) ti.remove();

    if (result.error) {
        addChatBubble('error', result.error);
    } else {
        addChatBubble('ai', result.text);
        chatHistory.push({ role: 'assistant', content: result.text });
    }
}

function addChatBubble(role, text) {
    var msgsEl = document.getElementById('chatMessages');
    var div = document.createElement('div');
    div.className = 'chat-msg ' + role;
    if (role === 'ai') {
        div.innerHTML = '<div class="msg-bubble">' + formatAIResponse(text) + '</div>';
    } else if (role === 'error') {
        div.innerHTML = '<div class="msg-bubble">' + text + '</div>';
    } else {
        div.innerHTML = '<div class="msg-bubble">' + escapeHtml(text) + '</div>';
    }
    msgsEl.appendChild(div);
    msgsEl.scrollTop = msgsEl.scrollHeight;
}

function escapeHtml(str) {
    var div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

function parseAndExecuteActions(text) {
    var highlightMatch = text.match(/HIGHLIGHT:\[([^\]]+)\]/);
    if (highlightMatch) {
        var nodeIds = highlightMatch[1].split(',').map(function(s) { return s.trim(); });
        highlightNodeGroup(nodeIds);
    }

    var simMatch = text.match(/SIMULATE:\[([^\]]+)\]/);
    if (simMatch) {
        var simNodeId = simMatch[1].trim();
        if (!simMode) toggleSimMode();
        var simNodeData = NODES.find(function(n) { return n.id === simNodeId; });
        if (simNodeData) runCompromiseSimulation(simNodeData);
    }

    var focusMatch = text.match(/FOCUS:\[([^\]]+)\]/);
    if (focusMatch) {
        focusNodeById(focusMatch[1].trim());
    }
}

function formatAIResponse(text) {
    var clean = text
        .replace(/HIGHLIGHT:\[[^\]]+\]/g, '')
        .replace(/SIMULATE:\[[^\]]+\]/g, '')
        .replace(/FOCUS:\[[^\]]+\]/g, '')
        .trim();

    // Escape HTML first
    clean = escapeHtml(clean);

    // Convert [nodeName] to clickable links
    clean = clean.replace(/\[([^\]]+)\]/g, function(match, name) {
        var node = NODES.find(function(n) {
            return n.label.toLowerCase() === name.toLowerCase() ||
                   n.id.toLowerCase() === name.toLowerCase();
        });
        if (node) {
            return '<span class="chat-node-link" onclick="focusNodeById(\'' + node.id + '\')">' + node.label + '</span>';
        }
        return match;
    });

    // Convert AML.TXXXX to styled tags
    clean = clean.replace(/(AML\.T\d{4}(?:\.\d{3})?)/g, function(match) {
        var tech = ATLAS_TECHNIQUES[match];
        if (tech) {
            return '<a class="chat-atlas-tag" href="' + tech.url + '" target="_blank" title="' + tech.name + '">' + match + '</a>';
        }
        return '<span class="chat-atlas-tag">' + match + '</span>';
    });

    // Convert newlines to <br>
    clean = clean.replace(/\n/g, '<br>');

    return clean;
}
</script>
</body>
</html>
